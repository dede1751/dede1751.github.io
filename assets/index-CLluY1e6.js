(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const n of r.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&s(n)}).observe(document,{childList:!0,subtree:!0});function e(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(i){if(i.ep)return;i.ep=!0;const r=e(i);fetch(i.href,r)}})();function _s(h){return h!==null?{comment:h,variations:[]}:{variations:[]}}function ws(h,t,e,s,i){const r={move:h,variations:i};return t&&(r.suffix=t),e&&(r.nag=e),s!==null&&(r.comment=s),r}function ys(...h){const[t,...e]=h;let s=t;for(const i of e)i!==null&&(s.variations=[i,...i.variations],i.variations=[],s=i);return t}function Ss(h,t){if(t.marker&&t.marker.comment){let e=t.root;for(;;){const s=e.variations[0];if(!s){e.comment=t.marker.comment;break}e=s}}return{headers:h,root:t.root,result:(t.marker&&t.marker.result)??void 0}}function ks(h,t){function e(){this.constructor=h}e.prototype=t.prototype,h.prototype=new e}function ie(h,t,e,s){var i=Error.call(this,h);return Object.setPrototypeOf&&Object.setPrototypeOf(i,ie.prototype),i.expected=t,i.found=e,i.location=s,i.name="SyntaxError",i}ks(ie,Error);function Ee(h,t,e){return e=e||" ",h.length>t?h:(t-=h.length,e+=e.repeat(t),h+e.slice(0,t))}ie.prototype.format=function(h){var t="Error: "+this.message;if(this.location){var e=null,s;for(s=0;s<h.length;s++)if(h[s].source===this.location.source){e=h[s].text.split(/\r\n|\n|\r/g);break}var i=this.location.start,r=this.location.source&&typeof this.location.source.offset=="function"?this.location.source.offset(i):i,n=this.location.source+":"+r.line+":"+r.column;if(e){var o=this.location.end,d=Ee("",r.line.toString().length," "),f=e[i.line-1],m=i.line===o.line?o.column:f.length+1,E=m-i.column||1;t+=`
 --> `+n+`
`+d+` |
`+r.line+" | "+f+`
`+d+" | "+Ee("",i.column-1," ")+Ee("",E,"^")}else t+=`
 at `+n}return t};ie.buildMessage=function(h,t){var e={literal:function(f){return'"'+i(f.text)+'"'},class:function(f){var m=f.parts.map(function(E){return Array.isArray(E)?r(E[0])+"-"+r(E[1]):r(E)});return"["+(f.inverted?"^":"")+m.join("")+"]"},any:function(){return"any character"},end:function(){return"end of input"},other:function(f){return f.description}};function s(f){return f.charCodeAt(0).toString(16).toUpperCase()}function i(f){return f.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(m){return"\\x0"+s(m)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(m){return"\\x"+s(m)})}function r(f){return f.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(m){return"\\x0"+s(m)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(m){return"\\x"+s(m)})}function n(f){return e[f.type](f)}function o(f){var m=f.map(n),E,g;if(m.sort(),m.length>0){for(E=1,g=1;E<m.length;E++)m[E-1]!==m[E]&&(m[g]=m[E],g++);m.length=g}switch(m.length){case 1:return m[0];case 2:return m[0]+" or "+m[1];default:return m.slice(0,-1).join(", ")+", or "+m[m.length-1]}}function d(f){return f?'"'+i(f)+'"':"end of input"}return"Expected "+o(h)+" but "+d(t)+" found."};function Es(h,t){t=t!==void 0?t:{};var e={},s=t.grammarSource,i={pgn:et},r=et,n="[",o='"',d="]",f=".",m="O-O-O",E="O-O",g="0-0-0",y="0-0",P="$",x="{",H="}",_e=";",we="(",vt=")",Oe="1-0",$e="0-1",De="1/2-1/2",bt="*",ye=/^[a-zA-Z]/,Ne=/^[^"]/,le=/^[0-9]/,Be=/^[.]/,Re=/^[a-zA-Z1-8\-=]/,_t=/^[+#]/,Fe=/^[!?]/,Ge=/^[^}]/,Ke=/^[^\r\n]/,Ue=/^[ \t\r\n]/,wt=R("tag pair"),yt=A("[",!1),He=A('"',!1),St=A("]",!1),kt=R("tag name"),Se=K([["a","z"],["A","Z"]],!1,!1),Et=R("tag value"),We=K(['"'],!0,!1),Pt=R("move number"),ce=K([["0","9"]],!1,!1),Ct=A(".",!1),ze=K(["."],!1,!1),qt=R("standard algebraic notation"),xt=A("O-O-O",!1),Tt=A("O-O",!1),It=A("0-0-0",!1),Mt=A("0-0",!1),Qe=K([["a","z"],["A","Z"],["1","8"],"-","="],!1,!1),At=K(["+","#"],!1,!1),Lt=R("suffix annotation"),Ve=K(["!","?"],!1,!1),Ot=R("NAG"),$t=A("$",!1),Dt=R("brace comment"),Nt=A("{",!1),je=K(["}"],!0,!1),Bt=A("}",!1),Rt=R("rest of line comment"),Ft=A(";",!1),Ye=K(["\r",`
`],!0,!1),Gt=R("variation"),Kt=A("(",!1),Ut=A(")",!1),Ht=R("game termination marker"),Wt=A("1-0",!1),zt=A("0-1",!1),Qt=A("1/2-1/2",!1),Vt=A("*",!1),jt=R("whitespace"),Xe=K([" ","	","\r",`
`],!1,!1),Yt=function(a,c){return Ss(a,c)},Xt=function(a){return Object.fromEntries(a)},Zt=function(a,c){return[a,c]},Jt=function(a,c){return{root:a,marker:c}},es=function(a,c){return ys(_s(a),...c.flat())},ts=function(a,c,u,_,w){return ws(a,c,u,_,w)},ss=function(a){return a},is=function(a){return a.replace(/[\r\n]+/g," ")},rs=function(a){return a.trim()},ns=function(a){return a},os=function(a,c){return{result:a,comment:c}},l=t.peg$currPos|0,J=[{line:1,column:1}],G=l,ue=t.peg$maxFailExpected||[],p=t.peg$silentFails|0,re;if(t.startRule){if(!(t.startRule in i))throw new Error(`Can't start parsing from rule "`+t.startRule+'".');r=i[t.startRule]}function A(a,c){return{type:"literal",text:a,ignoreCase:c}}function K(a,c,u){return{type:"class",parts:a,inverted:c,ignoreCase:u}}function as(){return{type:"end"}}function R(a){return{type:"other",description:a}}function Ze(a){var c=J[a],u;if(c)return c;if(a>=J.length)u=J.length-1;else for(u=a;!J[--u];);for(c=J[u],c={line:c.line,column:c.column};u<a;)h.charCodeAt(u)===10?(c.line++,c.column=1):c.column++,u++;return J[a]=c,c}function Je(a,c,u){var _=Ze(a),w=Ze(c),C={source:s,start:{offset:a,line:_.line,column:_.column},end:{offset:c,line:w.line,column:w.column}};return C}function v(a){l<G||(l>G&&(G=l,ue=[]),ue.push(a))}function hs(a,c,u){return new ie(ie.buildMessage(a,c),a,c,u)}function et(){var a,c,u;return a=l,c=ls(),u=ds(),a=Yt(c,u),a}function ls(){var a,c,u;for(a=l,c=[],u=tt();u!==e;)c.push(u),u=tt();return u=D(),a=Xt(c),a}function tt(){var a,c,u,_,w,C,Y;return p++,a=l,D(),h.charCodeAt(l)===91?(c=n,l++):(c=e,p===0&&v(yt)),c!==e?(D(),u=cs(),u!==e?(D(),h.charCodeAt(l)===34?(_=o,l++):(_=e,p===0&&v(He)),_!==e?(w=us(),h.charCodeAt(l)===34?(C=o,l++):(C=e,p===0&&v(He)),C!==e?(D(),h.charCodeAt(l)===93?(Y=d,l++):(Y=e,p===0&&v(St)),Y!==e?a=Zt(u,w):(l=a,a=e)):(l=a,a=e)):(l=a,a=e)):(l=a,a=e)):(l=a,a=e),p--,a===e&&p===0&&v(wt),a}function cs(){var a,c,u;if(p++,a=l,c=[],u=h.charAt(l),ye.test(u)?l++:(u=e,p===0&&v(Se)),u!==e)for(;u!==e;)c.push(u),u=h.charAt(l),ye.test(u)?l++:(u=e,p===0&&v(Se));else c=e;return c!==e?a=h.substring(a,l):a=c,p--,a===e&&(c=e,p===0&&v(kt)),a}function us(){var a,c,u;for(p++,a=l,c=[],u=h.charAt(l),Ne.test(u)?l++:(u=e,p===0&&v(We));u!==e;)c.push(u),u=h.charAt(l),Ne.test(u)?l++:(u=e,p===0&&v(We));return a=h.substring(a,l),p--,c=e,p===0&&v(Et),a}function ds(){var a,c,u;return a=l,c=st(),D(),u=bs(),u===e&&(u=null),D(),a=Jt(c,u),a}function st(){var a,c,u,_;for(a=l,c=ke(),c===e&&(c=null),u=[],_=it();_!==e;)u.push(_),_=it();return a=es(c,u),a}function it(){var a,c,u,_,w,C,Y,de;if(a=l,D(),fs(),D(),c=ps(),c!==e){for(u=gs(),u===e&&(u=null),_=[],w=rt();w!==e;)_.push(w),w=rt();for(w=D(),C=ke(),C===e&&(C=null),Y=[],de=nt();de!==e;)Y.push(de),de=nt();a=ts(c,u,_,C,Y)}else l=a,a=e;return a}function fs(){var a,c,u,_,w,C;for(p++,a=l,c=[],u=h.charAt(l),le.test(u)?l++:(u=e,p===0&&v(ce));u!==e;)c.push(u),u=h.charAt(l),le.test(u)?l++:(u=e,p===0&&v(ce));if(h.charCodeAt(l)===46?(u=f,l++):(u=e,p===0&&v(Ct)),u!==e){for(_=D(),w=[],C=h.charAt(l),Be.test(C)?l++:(C=e,p===0&&v(ze));C!==e;)w.push(C),C=h.charAt(l),Be.test(C)?l++:(C=e,p===0&&v(ze));c=[c,u,_,w],a=c}else l=a,a=e;return p--,a===e&&(c=e,p===0&&v(Pt)),a}function ps(){var a,c,u,_,w,C;if(p++,a=l,c=l,h.substr(l,5)===m?(u=m,l+=5):(u=e,p===0&&v(xt)),u===e&&(h.substr(l,3)===E?(u=E,l+=3):(u=e,p===0&&v(Tt)),u===e&&(h.substr(l,5)===g?(u=g,l+=5):(u=e,p===0&&v(It)),u===e&&(h.substr(l,3)===y?(u=y,l+=3):(u=e,p===0&&v(Mt)),u===e))))if(u=l,_=h.charAt(l),ye.test(_)?l++:(_=e,p===0&&v(Se)),_!==e){if(w=[],C=h.charAt(l),Re.test(C)?l++:(C=e,p===0&&v(Qe)),C!==e)for(;C!==e;)w.push(C),C=h.charAt(l),Re.test(C)?l++:(C=e,p===0&&v(Qe));else w=e;w!==e?(_=[_,w],u=_):(l=u,u=e)}else l=u,u=e;return u!==e?(_=h.charAt(l),_t.test(_)?l++:(_=e,p===0&&v(At)),_===e&&(_=null),u=[u,_],c=u):(l=c,c=e),c!==e?a=h.substring(a,l):a=c,p--,a===e&&(c=e,p===0&&v(qt)),a}function gs(){var a,c,u;for(p++,a=l,c=[],u=h.charAt(l),Fe.test(u)?l++:(u=e,p===0&&v(Ve));u!==e;)c.push(u),c.length>=2?u=e:(u=h.charAt(l),Fe.test(u)?l++:(u=e,p===0&&v(Ve)));return c.length<1?(l=a,a=e):a=c,p--,a===e&&(c=e,p===0&&v(Lt)),a}function rt(){var a,c,u,_,w;if(p++,a=l,D(),h.charCodeAt(l)===36?(c=P,l++):(c=e,p===0&&v($t)),c!==e){if(u=l,_=[],w=h.charAt(l),le.test(w)?l++:(w=e,p===0&&v(ce)),w!==e)for(;w!==e;)_.push(w),w=h.charAt(l),le.test(w)?l++:(w=e,p===0&&v(ce));else _=e;_!==e?u=h.substring(u,l):u=_,u!==e?a=ss(u):(l=a,a=e)}else l=a,a=e;return p--,a===e&&p===0&&v(Ot),a}function ke(){var a;return a=ms(),a===e&&(a=vs()),a}function ms(){var a,c,u,_,w;if(p++,a=l,h.charCodeAt(l)===123?(c=x,l++):(c=e,p===0&&v(Nt)),c!==e){for(u=l,_=[],w=h.charAt(l),Ge.test(w)?l++:(w=e,p===0&&v(je));w!==e;)_.push(w),w=h.charAt(l),Ge.test(w)?l++:(w=e,p===0&&v(je));u=h.substring(u,l),h.charCodeAt(l)===125?(_=H,l++):(_=e,p===0&&v(Bt)),_!==e?a=is(u):(l=a,a=e)}else l=a,a=e;return p--,a===e&&(c=e,p===0&&v(Dt)),a}function vs(){var a,c,u,_,w;if(p++,a=l,h.charCodeAt(l)===59?(c=_e,l++):(c=e,p===0&&v(Ft)),c!==e){for(u=l,_=[],w=h.charAt(l),Ke.test(w)?l++:(w=e,p===0&&v(Ye));w!==e;)_.push(w),w=h.charAt(l),Ke.test(w)?l++:(w=e,p===0&&v(Ye));u=h.substring(u,l),a=rs(u)}else l=a,a=e;return p--,a===e&&(c=e,p===0&&v(Rt)),a}function nt(){var a,c,u,_;return p++,a=l,D(),h.charCodeAt(l)===40?(c=we,l++):(c=e,p===0&&v(Kt)),c!==e?(u=st(),u!==e?(D(),h.charCodeAt(l)===41?(_=vt,l++):(_=e,p===0&&v(Ut)),_!==e?a=ns(u):(l=a,a=e)):(l=a,a=e)):(l=a,a=e),p--,a===e&&p===0&&v(Gt),a}function bs(){var a,c,u;return p++,a=l,h.substr(l,3)===Oe?(c=Oe,l+=3):(c=e,p===0&&v(Wt)),c===e&&(h.substr(l,3)===$e?(c=$e,l+=3):(c=e,p===0&&v(zt)),c===e&&(h.substr(l,7)===De?(c=De,l+=7):(c=e,p===0&&v(Qt)),c===e&&(h.charCodeAt(l)===42?(c=bt,l++):(c=e,p===0&&v(Vt))))),c!==e?(D(),u=ke(),u===e&&(u=null),a=os(c,u)):(l=a,a=e),p--,a===e&&(c=e,p===0&&v(Ht)),a}function D(){var a,c;for(p++,a=[],c=h.charAt(l),Ue.test(c)?l++:(c=e,p===0&&v(Xe));c!==e;)a.push(c),c=h.charAt(l),Ue.test(c)?l++:(c=e,p===0&&v(Xe));return p--,c=e,p===0&&v(jt),a}if(re=r(),t.peg$library)return{peg$result:re,peg$currPos:l,peg$FAILED:e,peg$maxFailExpected:ue,peg$maxFailPos:G};if(re!==e&&l===h.length)return re;throw re!==e&&l<h.length&&v(as()),hs(ue,G<h.length?h.charAt(G):null,G<h.length?Je(G,G+1):Je(G,G))}/**
 * @license
 * Copyright (c) 2025, Jeff Hlywa (jhlywa@gmail.com)
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are met:
 *
 * 1. Redistributions of source code must retain the above copyright notice,
 *    this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright notice,
 *    this list of conditions and the following disclaimer in the documentation
 *    and/or other materials provided with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
 * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE
 * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
 * POSSIBILITY OF SUCH DAMAGE.
 */const me=0xffffffffffffffffn;function Pe(h,t){return(h<<t|h>>64n-t)&0xffffffffffffffffn}function ot(h,t){return h*t&me}function Ps(h){return function(){let t=BigInt(h&me),e=BigInt(h>>64n&me);const s=ot(Pe(ot(t,5n),7n),9n);return e^=t,t=(Pe(t,24n)^e^e<<16n)&me,e=Pe(e,37n),h=e<<64n|t,s}}const be=Ps(0xa187eb39cdcaed8f31c4b365b102e01en),Cs=Array.from({length:2},()=>Array.from({length:6},()=>Array.from({length:128},()=>be()))),qs=Array.from({length:8},()=>be()),xs=Array.from({length:16},()=>be()),Ce=be(),$="w",N="b",I="p",Me="n",ve="b",oe="r",V="q",M="k",qe="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1";class fe{color;from;to;piece;captured;promotion;flags;san;lan;before;after;constructor(t,e){const{color:s,piece:i,from:r,to:n,flags:o,captured:d,promotion:f}=e,m=L(r),E=L(n);this.color=s,this.piece=i,this.from=m,this.to=E,this.san=t._moveToSan(e,t._moves({legal:!0})),this.lan=m+E,this.before=t.fen(),t._makeMove(e),this.after=t.fen(),t._undoMove(),this.flags="";for(const g in k)k[g]&o&&(this.flags+=X[g]);d&&(this.captured=d),f&&(this.promotion=f,this.lan+=f)}isCapture(){return this.flags.indexOf(X.CAPTURE)>-1}isPromotion(){return this.flags.indexOf(X.PROMOTION)>-1}isEnPassant(){return this.flags.indexOf(X.EP_CAPTURE)>-1}isKingsideCastle(){return this.flags.indexOf(X.KSIDE_CASTLE)>-1}isQueensideCastle(){return this.flags.indexOf(X.QSIDE_CASTLE)>-1}isBigPawn(){return this.flags.indexOf(X.BIG_PAWN)>-1}}const O=-1,X={NORMAL:"n",CAPTURE:"c",BIG_PAWN:"b",EP_CAPTURE:"e",PROMOTION:"p",KSIDE_CASTLE:"k",QSIDE_CASTLE:"q",NULL_MOVE:"-"},k={NORMAL:1,CAPTURE:2,BIG_PAWN:4,EP_CAPTURE:8,PROMOTION:16,KSIDE_CASTLE:32,QSIDE_CASTLE:64,NULL_MOVE:128},Ae={Event:"?",Site:"?",Date:"????.??.??",Round:"?",White:"?",Black:"?",Result:"*"},Ts={WhiteTitle:null,BlackTitle:null,WhiteElo:null,BlackElo:null,WhiteUSCF:null,BlackUSCF:null,WhiteNA:null,BlackNA:null,WhiteType:null,BlackType:null,EventDate:null,EventSponsor:null,Section:null,Stage:null,Board:null,Opening:null,Variation:null,SubVariation:null,ECO:null,NIC:null,Time:null,UTCTime:null,UTCDate:null,TimeControl:null,SetUp:null,FEN:null,Termination:null,Annotator:null,Mode:null,PlyCount:null},Is={...Ae,...Ts},S={a8:0,b8:1,c8:2,d8:3,e8:4,f8:5,g8:6,h8:7,a7:16,b7:17,c7:18,d7:19,e7:20,f7:21,g7:22,h7:23,a6:32,b6:33,c6:34,d6:35,e6:36,f6:37,g6:38,h6:39,a5:48,b5:49,c5:50,d5:51,e5:52,f5:53,g5:54,h5:55,a4:64,b4:65,c4:66,d4:67,e4:68,f4:69,g4:70,h4:71,a3:80,b3:81,c3:82,d3:83,e3:84,f3:85,g3:86,h3:87,a2:96,b2:97,c2:98,d2:99,e2:100,f2:101,g2:102,h2:103,a1:112,b1:113,c1:114,d1:115,e1:116,f1:117,g1:118,h1:119},xe={b:[16,32,17,15],w:[-16,-32,-17,-15]},at={n:[-18,-33,-31,-14,18,33,31,14],b:[-17,-15,17,15],r:[-16,1,16,-1],q:[-17,-16,-15,1,17,16,15,-1],k:[-17,-16,-15,1,17,16,15,-1]},Ms=[20,0,0,0,0,0,0,24,0,0,0,0,0,0,20,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,24,24,24,24,24,24,56,0,56,24,24,24,24,24,24,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,20,0,0,0,0,0,0,24,0,0,0,0,0,0,20],As=[17,0,0,0,0,0,0,16,0,0,0,0,0,0,15,0,0,17,0,0,0,0,0,16,0,0,0,0,0,15,0,0,0,0,17,0,0,0,0,16,0,0,0,0,15,0,0,0,0,0,0,17,0,0,0,16,0,0,0,15,0,0,0,0,0,0,0,0,17,0,0,16,0,0,15,0,0,0,0,0,0,0,0,0,0,17,0,16,0,15,0,0,0,0,0,0,0,0,0,0,0,0,17,16,15,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,-15,-16,-17,0,0,0,0,0,0,0,0,0,0,0,0,-15,0,-16,0,-17,0,0,0,0,0,0,0,0,0,0,-15,0,0,-16,0,0,-17,0,0,0,0,0,0,0,0,-15,0,0,0,-16,0,0,0,-17,0,0,0,0,0,0,-15,0,0,0,0,-16,0,0,0,0,-17,0,0,0,0,-15,0,0,0,0,0,-16,0,0,0,0,0,-17,0,0,-15,0,0,0,0,0,0,-16,0,0,0,0,0,0,-17],Ls={p:1,n:2,b:4,r:8,q:16,k:32},Os="pnbrqkPNBRQK",ht=[Me,ve,oe,V],$s=7,Ds=6,Ns=1,Bs=0,pe={[M]:k.KSIDE_CASTLE,[V]:k.QSIDE_CASTLE},W={w:[{square:S.a1,flag:k.QSIDE_CASTLE},{square:S.h1,flag:k.KSIDE_CASTLE}],b:[{square:S.a8,flag:k.QSIDE_CASTLE},{square:S.h8,flag:k.KSIDE_CASTLE}]},Rs={b:Ns,w:Ds},Te="--";function Z(h){return h>>4}function he(h){return h&15}function gt(h){return"0123456789".indexOf(h)!==-1}function L(h){const t=he(h),e=Z(h);return"abcdefgh".substring(t,t+1)+"87654321".substring(e,e+1)}function ne(h){return h===$?N:$}function Fs(h){const t=h.split(/\s+/);if(t.length!==6)return{ok:!1,error:"Invalid FEN: must contain six space-delimited fields"};const e=parseInt(t[5],10);if(isNaN(e)||e<=0)return{ok:!1,error:"Invalid FEN: move number must be a positive integer"};const s=parseInt(t[4],10);if(isNaN(s)||s<0)return{ok:!1,error:"Invalid FEN: half move counter number must be a non-negative integer"};if(!/^(-|[abcdefgh][36])$/.test(t[3]))return{ok:!1,error:"Invalid FEN: en-passant square is invalid"};if(/[^kKqQ-]/.test(t[2]))return{ok:!1,error:"Invalid FEN: castling availability is invalid"};if(!/^(w|b)$/.test(t[1]))return{ok:!1,error:"Invalid FEN: side-to-move is invalid"};const i=t[0].split("/");if(i.length!==8)return{ok:!1,error:"Invalid FEN: piece data does not contain 8 '/'-delimited rows"};for(let n=0;n<i.length;n++){let o=0,d=!1;for(let f=0;f<i[n].length;f++)if(gt(i[n][f])){if(d)return{ok:!1,error:"Invalid FEN: piece data is invalid (consecutive number)"};o+=parseInt(i[n][f],10),d=!0}else{if(!/^[prnbqkPRNBQK]$/.test(i[n][f]))return{ok:!1,error:"Invalid FEN: piece data is invalid (invalid piece)"};o+=1,d=!1}if(o!==8)return{ok:!1,error:"Invalid FEN: piece data is invalid (too many squares in rank)"}}if(t[3][1]=="3"&&t[1]=="w"||t[3][1]=="6"&&t[1]=="b")return{ok:!1,error:"Invalid FEN: illegal en-passant square"};const r=[{color:"white",regex:/K/g},{color:"black",regex:/k/g}];for(const{color:n,regex:o}of r){if(!o.test(t[0]))return{ok:!1,error:`Invalid FEN: missing ${n} king`};if((t[0].match(o)||[]).length>1)return{ok:!1,error:`Invalid FEN: too many ${n} kings`}}return Array.from(i[0]+i[7]).some(n=>n.toUpperCase()==="P")?{ok:!1,error:"Invalid FEN: some pawns are on the edge rows"}:{ok:!0}}function Gs(h,t){const e=h.from,s=h.to,i=h.piece;let r=0,n=0,o=0;for(let d=0,f=t.length;d<f;d++){const m=t[d].from,E=t[d].to,g=t[d].piece;i===g&&e!==m&&s===E&&(r++,Z(e)===Z(m)&&n++,he(e)===he(m)&&o++)}return r>0?n>0&&o>0?L(e):o>0?L(e).charAt(1):L(e).charAt(0):""}function z(h,t,e,s,i,r=void 0,n=k.NORMAL){const o=Z(s);if(i===I&&(o===$s||o===Bs))for(let d=0;d<ht.length;d++){const f=ht[d];h.push({color:t,from:e,to:s,piece:i,captured:r,promotion:f,flags:n|k.PROMOTION})}else h.push({color:t,from:e,to:s,piece:i,captured:r,flags:n})}function lt(h){let t=h.charAt(0);return t>="a"&&t<="h"?h.match(/[a-h]\d.*[a-h]\d/)?void 0:I:(t=t.toLowerCase(),t==="o"?M:t)}function Ie(h){return h.replace(/=/,"").replace(/[+#]?[?!]*$/,"")}class Ks{_board=new Array(128);_turn=$;_header={};_kings={w:O,b:O};_epSquare=-1;_halfMoves=0;_moveNumber=0;_history=[];_comments={};_castling={w:0,b:0};_hash=0n;_positionCount=new Map;constructor(t=qe,{skipValidation:e=!1}={}){this.load(t,{skipValidation:e})}clear({preserveHeaders:t=!1}={}){this._board=new Array(128),this._kings={w:O,b:O},this._turn=$,this._castling={w:0,b:0},this._epSquare=O,this._halfMoves=0,this._moveNumber=1,this._history=[],this._comments={},this._header=t?this._header:{...Is},this._hash=this._computeHash(),this._positionCount=new Map,this._header.SetUp=null,this._header.FEN=null}load(t,{skipValidation:e=!1,preserveHeaders:s=!1}={}){let i=t.split(/\s+/);if(i.length>=2&&i.length<6){const o=["-","-","0","1"];t=i.concat(o.slice(-(6-i.length))).join(" ")}if(i=t.split(/\s+/),!e){const{ok:o,error:d}=Fs(t);if(!o)throw new Error(d)}const r=i[0];let n=0;this.clear({preserveHeaders:s});for(let o=0;o<r.length;o++){const d=r.charAt(o);if(d==="/")n+=8;else if(gt(d))n+=parseInt(d,10);else{const f=d<"a"?$:N;this._put({type:d.toLowerCase(),color:f},L(n)),n++}}this._turn=i[1],i[2].indexOf("K")>-1&&(this._castling.w|=k.KSIDE_CASTLE),i[2].indexOf("Q")>-1&&(this._castling.w|=k.QSIDE_CASTLE),i[2].indexOf("k")>-1&&(this._castling.b|=k.KSIDE_CASTLE),i[2].indexOf("q")>-1&&(this._castling.b|=k.QSIDE_CASTLE),this._epSquare=i[3]==="-"?O:S[i[3]],this._halfMoves=parseInt(i[4],10),this._moveNumber=parseInt(i[5],10),this._hash=this._computeHash(),this._updateSetup(t),this._incPositionCount()}fen({forceEnpassantSquare:t=!1}={}){let e=0,s="";for(let n=S.a8;n<=S.h1;n++){if(this._board[n]){e>0&&(s+=e,e=0);const{color:o,type:d}=this._board[n];s+=o===$?d.toUpperCase():d.toLowerCase()}else e++;n+1&136&&(e>0&&(s+=e),n!==S.h1&&(s+="/"),e=0,n+=8)}let i="";this._castling[$]&k.KSIDE_CASTLE&&(i+="K"),this._castling[$]&k.QSIDE_CASTLE&&(i+="Q"),this._castling[N]&k.KSIDE_CASTLE&&(i+="k"),this._castling[N]&k.QSIDE_CASTLE&&(i+="q"),i=i||"-";let r="-";if(this._epSquare!==O)if(t)r=L(this._epSquare);else{const n=this._epSquare+(this._turn===$?16:-16),o=[n+1,n-1];for(const d of o){if(d&136)continue;const f=this._turn;if(this._board[d]?.color===f&&this._board[d]?.type===I){this._makeMove({color:f,from:d,to:this._epSquare,piece:I,captured:I,flags:k.EP_CAPTURE});const m=!this._isKingAttacked(f);if(this._undoMove(),m){r=L(this._epSquare);break}}}}return[s,this._turn,i,r,this._halfMoves,this._moveNumber].join(" ")}_pieceKey(t){if(!this._board[t])return 0n;const{color:e,type:s}=this._board[t],i={w:0,b:1}[e],r={p:0,n:1,b:2,r:3,q:4,k:5}[s];return Cs[i][r][t]}_epKey(){return this._epSquare===O?0n:qs[this._epSquare&7]}_castlingKey(){const t=this._castling.w>>5|this._castling.b>>3;return xs[t]}_computeHash(){let t=0n;for(let e=S.a8;e<=S.h1;e++){if(e&136){e+=7;continue}this._board[e]&&(t^=this._pieceKey(e))}return t^=this._epKey(),t^=this._castlingKey(),this._turn==="b"&&(t^=Ce),t}_updateSetup(t){this._history.length>0||(t!==qe?(this._header.SetUp="1",this._header.FEN=t):(this._header.SetUp=null,this._header.FEN=null))}reset(){this.load(qe)}get(t){return this._board[S[t]]}findPiece(t){const e=[];for(let s=S.a8;s<=S.h1;s++){if(s&136){s+=7;continue}!this._board[s]||this._board[s]?.color!==t.color||this._board[s].color===t.color&&this._board[s].type===t.type&&e.push(L(s))}return e}put({type:t,color:e},s){return this._put({type:t,color:e},s)?(this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),!0):!1}_set(t,e){this._hash^=this._pieceKey(t),this._board[t]=e,this._hash^=this._pieceKey(t)}_put({type:t,color:e},s){if(Os.indexOf(t.toLowerCase())===-1||!(s in S))return!1;const i=S[s];if(t==M&&!(this._kings[e]==O||this._kings[e]==i))return!1;const r=this._board[i];return r&&r.type===M&&(this._kings[r.color]=O),this._set(i,{type:t,color:e}),t===M&&(this._kings[e]=i),!0}_clear(t){this._hash^=this._pieceKey(t),delete this._board[t]}remove(t){const e=this.get(t);return this._clear(S[t]),e&&e.type===M&&(this._kings[e.color]=O),this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),e}_updateCastlingRights(){this._hash^=this._castlingKey();const t=this._board[S.e1]?.type===M&&this._board[S.e1]?.color===$,e=this._board[S.e8]?.type===M&&this._board[S.e8]?.color===N;(!t||this._board[S.a1]?.type!==oe||this._board[S.a1]?.color!==$)&&(this._castling.w&=-65),(!t||this._board[S.h1]?.type!==oe||this._board[S.h1]?.color!==$)&&(this._castling.w&=-33),(!e||this._board[S.a8]?.type!==oe||this._board[S.a8]?.color!==N)&&(this._castling.b&=-65),(!e||this._board[S.h8]?.type!==oe||this._board[S.h8]?.color!==N)&&(this._castling.b&=-33),this._hash^=this._castlingKey()}_updateEnPassantSquare(){if(this._epSquare===O)return;const t=this._epSquare+(this._turn===$?-16:16),e=this._epSquare+(this._turn===$?16:-16),s=[e+1,e-1];if(this._board[t]!==null||this._board[this._epSquare]!==null||this._board[e]?.color!==ne(this._turn)||this._board[e]?.type!==I){this._hash^=this._epKey(),this._epSquare=O;return}const i=r=>!(r&136)&&this._board[r]?.color===this._turn&&this._board[r]?.type===I;s.some(i)||(this._hash^=this._epKey(),this._epSquare=O)}_attacked(t,e,s){const i=[];for(let r=S.a8;r<=S.h1;r++){if(r&136){r+=7;continue}if(this._board[r]===void 0||this._board[r].color!==t)continue;const n=this._board[r],o=r-e;if(o===0)continue;const d=o+119;if(Ms[d]&Ls[n.type]){if(n.type===I){if(o>0&&n.color===$||o<=0&&n.color===N)if(s)i.push(L(r));else return!0;continue}if(n.type==="n"||n.type==="k")if(s){i.push(L(r));continue}else return!0;const f=As[d];let m=r+f,E=!1;for(;m!==e;){if(this._board[m]!=null){E=!0;break}m+=f}if(!E)if(s){i.push(L(r));continue}else return!0}}return s?i:!1}attackers(t,e){return e?this._attacked(e,S[t],!0):this._attacked(this._turn,S[t],!0)}_isKingAttacked(t){const e=this._kings[t];return e===-1?!1:this._attacked(ne(t),e)}hash(){return this._hash.toString(16)}isAttacked(t,e){return this._attacked(e,S[t])}isCheck(){return this._isKingAttacked(this._turn)}inCheck(){return this.isCheck()}isCheckmate(){return this.isCheck()&&this._moves().length===0}isStalemate(){return!this.isCheck()&&this._moves().length===0}isInsufficientMaterial(){const t={b:0,n:0,r:0,q:0,k:0,p:0},e=[];let s=0,i=0;for(let r=S.a8;r<=S.h1;r++){if(i=(i+1)%2,r&136){r+=7;continue}const n=this._board[r];n&&(t[n.type]=n.type in t?t[n.type]+1:1,n.type===ve&&e.push(i),s++)}if(s===2)return!0;if(s===3&&(t[ve]===1||t[Me]===1))return!0;if(s===t[ve]+2){let r=0;const n=e.length;for(let o=0;o<n;o++)r+=e[o];if(r===0||r===n)return!0}return!1}isThreefoldRepetition(){return this._getPositionCount(this._hash)>=3}isDrawByFiftyMoves(){return this._halfMoves>=100}isDraw(){return this.isDrawByFiftyMoves()||this.isStalemate()||this.isInsufficientMaterial()||this.isThreefoldRepetition()}isGameOver(){return this.isCheckmate()||this.isDraw()}moves({verbose:t=!1,square:e=void 0,piece:s=void 0}={}){const i=this._moves({square:e,piece:s});return t?i.map(r=>new fe(this,r)):i.map(r=>this._moveToSan(r,i))}_moves({legal:t=!0,piece:e=void 0,square:s=void 0}={}){const i=s?s.toLowerCase():void 0,r=e?.toLowerCase(),n=[],o=this._turn,d=ne(o);let f=S.a8,m=S.h1,E=!1;if(i)if(i in S)f=m=S[i],E=!0;else return[];for(let y=f;y<=m;y++){if(y&136){y+=7;continue}if(!this._board[y]||this._board[y].color===d)continue;const{type:P}=this._board[y];let x;if(P===I){if(r&&r!==P)continue;x=y+xe[o][0],this._board[x]||(z(n,o,y,x,I),x=y+xe[o][1],Rs[o]===Z(y)&&!this._board[x]&&z(n,o,y,x,I,void 0,k.BIG_PAWN));for(let H=2;H<4;H++)x=y+xe[o][H],!(x&136)&&(this._board[x]?.color===d?z(n,o,y,x,I,this._board[x].type,k.CAPTURE):x===this._epSquare&&z(n,o,y,x,I,I,k.EP_CAPTURE))}else{if(r&&r!==P)continue;for(let H=0,_e=at[P].length;H<_e;H++){const we=at[P][H];for(x=y;x+=we,!(x&136);){if(!this._board[x])z(n,o,y,x,P);else{if(this._board[x].color===o)break;z(n,o,y,x,P,this._board[x].type,k.CAPTURE);break}if(P===Me||P===M)break}}}}if((r===void 0||r===M)&&(!E||m===this._kings[o])){if(this._castling[o]&k.KSIDE_CASTLE){const y=this._kings[o],P=y+2;!this._board[y+1]&&!this._board[P]&&!this._attacked(d,this._kings[o])&&!this._attacked(d,y+1)&&!this._attacked(d,P)&&z(n,o,this._kings[o],P,M,void 0,k.KSIDE_CASTLE)}if(this._castling[o]&k.QSIDE_CASTLE){const y=this._kings[o],P=y-2;!this._board[y-1]&&!this._board[y-2]&&!this._board[y-3]&&!this._attacked(d,this._kings[o])&&!this._attacked(d,y-1)&&!this._attacked(d,P)&&z(n,o,this._kings[o],P,M,void 0,k.QSIDE_CASTLE)}}if(!t||this._kings[o]===-1)return n;const g=[];for(let y=0,P=n.length;y<P;y++)this._makeMove(n[y]),this._isKingAttacked(o)||g.push(n[y]),this._undoMove();return g}move(t,{strict:e=!1}={}){let s=null;if(typeof t=="string")s=this._moveFromSan(t,e);else if(t===null)s=this._moveFromSan(Te,e);else if(typeof t=="object"){const r=this._moves();for(let n=0,o=r.length;n<o;n++)if(t.from===L(r[n].from)&&t.to===L(r[n].to)&&(!("promotion"in r[n])||t.promotion===r[n].promotion)){s=r[n];break}}if(!s)throw typeof t=="string"?new Error(`Invalid move: ${t}`):new Error(`Invalid move: ${JSON.stringify(t)}`);if(this.isCheck()&&s.flags&k.NULL_MOVE)throw new Error("Null move not allowed when in check");const i=new fe(this,s);return this._makeMove(s),this._incPositionCount(),i}_push(t){this._history.push({move:t,kings:{b:this._kings.b,w:this._kings.w},turn:this._turn,castling:{b:this._castling.b,w:this._castling.w},epSquare:this._epSquare,halfMoves:this._halfMoves,moveNumber:this._moveNumber})}_movePiece(t,e){this._hash^=this._pieceKey(t),this._board[e]=this._board[t],delete this._board[t],this._hash^=this._pieceKey(e)}_makeMove(t){const e=this._turn,s=ne(e);if(this._push(t),t.flags&k.NULL_MOVE){e===N&&this._moveNumber++,this._halfMoves++,this._turn=s,this._epSquare=O;return}if(this._hash^=this._epKey(),this._hash^=this._castlingKey(),t.captured&&(this._hash^=this._pieceKey(t.to)),this._movePiece(t.from,t.to),t.flags&k.EP_CAPTURE&&(this._turn===N?this._clear(t.to-16):this._clear(t.to+16)),t.promotion&&(this._clear(t.to),this._set(t.to,{type:t.promotion,color:e})),this._board[t.to].type===M){if(this._kings[e]=t.to,t.flags&k.KSIDE_CASTLE){const i=t.to-1,r=t.to+1;this._movePiece(r,i)}else if(t.flags&k.QSIDE_CASTLE){const i=t.to+1,r=t.to-2;this._movePiece(r,i)}this._castling[e]=0}if(this._castling[e]){for(let i=0,r=W[e].length;i<r;i++)if(t.from===W[e][i].square&&this._castling[e]&W[e][i].flag){this._castling[e]^=W[e][i].flag;break}}if(this._castling[s]){for(let i=0,r=W[s].length;i<r;i++)if(t.to===W[s][i].square&&this._castling[s]&W[s][i].flag){this._castling[s]^=W[s][i].flag;break}}if(this._hash^=this._castlingKey(),t.flags&k.BIG_PAWN){let i;e===N?i=t.to-16:i=t.to+16,!(t.to-1&136)&&this._board[t.to-1]?.type===I&&this._board[t.to-1]?.color===s||!(t.to+1&136)&&this._board[t.to+1]?.type===I&&this._board[t.to+1]?.color===s?(this._epSquare=i,this._hash^=this._epKey()):this._epSquare=O}else this._epSquare=O;t.piece===I?this._halfMoves=0:t.flags&(k.CAPTURE|k.EP_CAPTURE)?this._halfMoves=0:this._halfMoves++,e===N&&this._moveNumber++,this._turn=s,this._hash^=Ce}undo(){const t=this._hash,e=this._undoMove();if(e){const s=new fe(this,e);return this._decPositionCount(t),s}return null}_undoMove(){const t=this._history.pop();if(t===void 0)return null;this._hash^=this._epKey(),this._hash^=this._castlingKey();const e=t.move;this._kings=t.kings,this._turn=t.turn,this._castling=t.castling,this._epSquare=t.epSquare,this._halfMoves=t.halfMoves,this._moveNumber=t.moveNumber,this._hash^=this._epKey(),this._hash^=this._castlingKey(),this._hash^=Ce;const s=this._turn,i=ne(s);if(e.flags&k.NULL_MOVE)return e;if(this._movePiece(e.to,e.from),e.piece&&(this._clear(e.from),this._set(e.from,{type:e.piece,color:s})),e.captured)if(e.flags&k.EP_CAPTURE){let r;s===N?r=e.to-16:r=e.to+16,this._set(r,{type:I,color:i})}else this._set(e.to,{type:e.captured,color:i});if(e.flags&(k.KSIDE_CASTLE|k.QSIDE_CASTLE)){let r,n;e.flags&k.KSIDE_CASTLE?(r=e.to+1,n=e.to-1):(r=e.to-2,n=e.to+1),this._movePiece(n,r)}return e}pgn({newline:t=`
`,maxWidth:e=0}={}){const s=[];let i=!1;for(const g in this._header)this._header[g]&&s.push(`[${g} "${this._header[g]}"]`+t),i=!0;i&&this._history.length&&s.push(t);const r=g=>{const y=this._comments[this.fen()];if(typeof y<"u"){const P=g.length>0?" ":"";g=`${g}${P}{${y}}`}return g},n=[];for(;this._history.length>0;)n.push(this._undoMove());const o=[];let d="";for(n.length===0&&o.push(r(""));n.length>0;){d=r(d);const g=n.pop();if(!g)break;if(!this._history.length&&g.color==="b"){const y=`${this._moveNumber}. ...`;d=d?`${d} ${y}`:y}else g.color==="w"&&(d.length&&o.push(d),d=this._moveNumber+".");d=d+" "+this._moveToSan(g,this._moves({legal:!0})),this._makeMove(g)}if(d.length&&o.push(r(d)),o.push(this._header.Result||"*"),e===0)return s.join("")+o.join(" ");const f=function(){return s.length>0&&s[s.length-1]===" "?(s.pop(),!0):!1},m=function(g,y){for(const P of y.split(" "))if(P){if(g+P.length>e){for(;f();)g--;s.push(t),g=0}s.push(P),g+=P.length,s.push(" "),g++}return f()&&g--,g};let E=0;for(let g=0;g<o.length;g++){if(E+o[g].length>e&&o[g].includes("{")){E=m(E,o[g]);continue}E+o[g].length>e&&g!==0?(s[s.length-1]===" "&&s.pop(),s.push(t),E=0):g!==0&&(s.push(" "),E++),s.push(o[g]),E+=o[g].length}return s.join("")}header(...t){for(let e=0;e<t.length;e+=2)typeof t[e]=="string"&&typeof t[e+1]=="string"&&(this._header[t[e]]=t[e+1]);return this._header}setHeader(t,e){return this._header[t]=e??Ae[t]??null,this.getHeaders()}removeHeader(t){return t in this._header?(this._header[t]=Ae[t]||null,!0):!1}getHeaders(){const t={};for(const[e,s]of Object.entries(this._header))s!==null&&(t[e]=s);return t}loadPgn(t,{strict:e=!1,newlineChar:s=`\r?
`}={}){s!==`\r?
`&&(t=t.replace(new RegExp(s,"g"),`
`));const i=Es(t);this.reset();const r=i.headers;let n="";for(const f in r)f.toLowerCase()==="fen"&&(n=r[f]),this.header(f,r[f]);if(!e)n&&this.load(n,{preserveHeaders:!0});else if(r.SetUp==="1"){if(!("FEN"in r))throw new Error("Invalid PGN: FEN tag must be supplied with SetUp tag");this.load(r.FEN,{preserveHeaders:!0})}let o=i.root;for(;o;){if(o.move){const f=this._moveFromSan(o.move,e);if(f==null)throw new Error(`Invalid move in PGN: ${o.move}`);this._makeMove(f),this._incPositionCount()}o.comment!==void 0&&(this._comments[this.fen()]=o.comment),o=o.variations[0]}const d=i.result;d&&Object.keys(this._header).length&&this._header.Result!==d&&this.setHeader("Result",d)}_moveToSan(t,e){let s="";if(t.flags&k.KSIDE_CASTLE)s="O-O";else if(t.flags&k.QSIDE_CASTLE)s="O-O-O";else{if(t.flags&k.NULL_MOVE)return Te;if(t.piece!==I){const i=Gs(t,e);s+=t.piece.toUpperCase()+i}t.flags&(k.CAPTURE|k.EP_CAPTURE)&&(t.piece===I&&(s+=L(t.from)[0]),s+="x"),s+=L(t.to),t.promotion&&(s+="="+t.promotion.toUpperCase())}return this._makeMove(t),this.isCheck()&&(this.isCheckmate()?s+="#":s+="+"),this._undoMove(),s}_moveFromSan(t,e=!1){let s=Ie(t);if(e||(s==="0-0"?s="O-O":s==="0-0-0"&&(s="O-O-O")),s==Te)return{color:this._turn,from:0,to:0,piece:"k",flags:k.NULL_MOVE};let i=lt(s),r=this._moves({legal:!0,piece:i});for(let g=0,y=r.length;g<y;g++)if(s===Ie(this._moveToSan(r[g],r)))return r[g];if(e)return null;let n,o,d,f,m,E=!1;if(o=s.match(/([pnbrqkPNBRQK])?([a-h][1-8])x?-?([a-h][1-8])([qrbnQRBN])?/),o?(n=o[1],d=o[2],f=o[3],m=o[4],d.length==1&&(E=!0)):(o=s.match(/([pnbrqkPNBRQK])?([a-h]?[1-8]?)x?-?([a-h][1-8])([qrbnQRBN])?/),o&&(n=o[1],d=o[2],f=o[3],m=o[4],d.length==1&&(E=!0))),i=lt(s),r=this._moves({legal:!0,piece:n||i}),!f)return null;for(let g=0,y=r.length;g<y;g++)if(d){if((!n||n.toLowerCase()==r[g].piece)&&S[d]==r[g].from&&S[f]==r[g].to&&(!m||m.toLowerCase()==r[g].promotion))return r[g];if(E){const P=L(r[g].from);if((!n||n.toLowerCase()==r[g].piece)&&S[f]==r[g].to&&(d==P[0]||d==P[1])&&(!m||m.toLowerCase()==r[g].promotion))return r[g]}}else if(s===Ie(this._moveToSan(r[g],r)).replace("x",""))return r[g];return null}ascii(){let t=`   +------------------------+
`;for(let e=S.a8;e<=S.h1;e++){if(he(e)===0&&(t+=" "+"87654321"[Z(e)]+" |"),this._board[e]){const s=this._board[e].type,r=this._board[e].color===$?s.toUpperCase():s.toLowerCase();t+=" "+r+" "}else t+=" . ";e+1&136&&(t+=`|
`,e+=8)}return t+=`   +------------------------+
`,t+="     a  b  c  d  e  f  g  h",t}perft(t){const e=this._moves({legal:!1});let s=0;const i=this._turn;for(let r=0,n=e.length;r<n;r++)this._makeMove(e[r]),this._isKingAttacked(i)||(t-1>0?s+=this.perft(t-1):s++),this._undoMove();return s}setTurn(t){return this._turn==t?!1:(this.move("--"),!0)}turn(){return this._turn}board(){const t=[];let e=[];for(let s=S.a8;s<=S.h1;s++)this._board[s]==null?e.push(null):e.push({square:L(s),type:this._board[s].type,color:this._board[s].color}),s+1&136&&(t.push(e),e=[],s+=8);return t}squareColor(t){if(t in S){const e=S[t];return(Z(e)+he(e))%2===0?"light":"dark"}return null}history({verbose:t=!1}={}){const e=[],s=[];for(;this._history.length>0;)e.push(this._undoMove());for(;;){const i=e.pop();if(!i)break;t?s.push(new fe(this,i)):s.push(this._moveToSan(i,this._moves())),this._makeMove(i)}return s}_getPositionCount(t){return this._positionCount.get(t)??0}_incPositionCount(){this._positionCount.set(this._hash,(this._positionCount.get(this._hash)??0)+1)}_decPositionCount(t){const e=this._positionCount.get(t)??0;e===1?this._positionCount.delete(t):this._positionCount.set(t,e-1)}_pruneComments(){const t=[],e={},s=i=>{i in this._comments&&(e[i]=this._comments[i])};for(;this._history.length>0;)t.push(this._undoMove());for(s(this.fen());;){const i=t.pop();if(!i)break;this._makeMove(i),s(this.fen())}this._comments=e}getComment(){return this._comments[this.fen()]}setComment(t){this._comments[this.fen()]=t.replace("{","[").replace("}","]")}deleteComment(){return this.removeComment()}removeComment(){const t=this._comments[this.fen()];return delete this._comments[this.fen()],t}getComments(){return this._pruneComments(),Object.keys(this._comments).map(t=>({fen:t,comment:this._comments[t]}))}deleteComments(){return this.removeComments()}removeComments(){return this._pruneComments(),Object.keys(this._comments).map(t=>{const e=this._comments[t];return delete this._comments[t],{fen:t,comment:e}})}setCastlingRights(t,e){for(const i of[M,V])e[i]!==void 0&&(e[i]?this._castling[t]|=pe[i]:this._castling[t]&=~pe[i]);this._updateCastlingRights();const s=this.getCastlingRights(t);return(e[M]===void 0||e[M]===s[M])&&(e[V]===void 0||e[V]===s[V])}getCastlingRights(t){return{[M]:(this._castling[t]&pe[M])!==0,[V]:(this._castling[t]&pe[V])!==0}}moveNumber(){return this._moveNumber}}const Us="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",Hs="8/8/8/8/8/8/8/8",ae={start:Us,empty:Hs};class T{constructor(t=void 0){this.squares=new Array(64).fill(null),this.setFen(t)}setFen(t=ae.empty){let e;t==="start"?(console.warn("setting the position with the strings 'start' or 'empty' is deprecated, use FEN.start or FEN.empty","used:",t),e=ae.start):t==="empty"||t===void 0?(console.warn("setting the position with the strings 'start' or 'empty' is deprecated, use FEN.start or FEN.empty","used:",t),e=ae.empty):e=t;const s=e.replace(/^\s*/,"").replace(/\s*$/,"").split(/\/|\s/);for(let i=0;i<8;i++){const r=s[7-i].replace(/\d/g,n=>{const o=parseInt(n);let d="";for(let f=0;f<o;f++)d+="-";return d});for(let n=0;n<8;n++){const o=r.substring(n,n+1);let d=null;o!=="-"&&(o.toUpperCase()===o?d=`w${o.toLowerCase()}`:d=`b${o}`),this.squares[i*8+n]=d}}}getFen(){let t=new Array(8).fill("");for(let e=0;e<8;e++){let s=0;for(let i=0;i<8;i++){const r=this.squares[e*8+i];if(!r)s++;else{s>0&&(t[7-e]+=s,s=0);const n=r.substring(0,1),o=r.substring(1,2);n==="w"?t[7-e]+=o.toUpperCase():t[7-e]+=o}}s>0&&(t[7-e]+=s,s=0)}return t.join("/")}getPieces(t=["k","q","r","b","n","p"]){const e=[],s=(i,r)=>t.indexOf(i.name)-t.indexOf(r.name);for(let i=0;i<64;i++){const r=this.squares[i];r&&e.push({name:r.charAt(1),color:r.charAt(0),position:T.indexToSquare(i)})}return t&&e.sort(s),e}movePiece(t,e){if(!this.squares[T.squareToIndex(t)]){console.warn("no piece on",t);return}this.squares[T.squareToIndex(e)]=this.squares[T.squareToIndex(t)],this.squares[T.squareToIndex(t)]=void 0}setPiece(t,e){this.squares[T.squareToIndex(t)]=e}getPiece(t){return this.squares[T.squareToIndex(t)]}static squareToIndex(t){const e=t.substring(0,1).charCodeAt(0)-97;return 8*(t.substring(1,2)-1)+e}static indexToSquare(t){const e=String.fromCharCode(t%8+97),s=Math.floor(t/8)+1;return e+s}clone(){const t=new T;return t.squares=this.squares.slice(0),t}}function mt(){let h,t;const e=new Promise(function(s,i){h=s,t=i});return e.resolve=h,e.reject=t,e}class Ws{constructor(){this.position=new T,this.orientation=void 0,this.markers=[],this.inputWhiteEnabled=!1,this.inputBlackEnabled=!1,this.inputEnabled=!1,this.squareSelectEnabled=!1,this.extensionPoints={},this.moveInputProcess=mt().resolve()}setPosition(t,e=!1){this.position=new T(t,e)}movePiece(t,e,s=!1){const i=this._position.clone();i.animated=s;const r=i.getPiece(t);r||console.error("no piece on",t),i.setPiece(t,void 0),i.setPiece(e,r),this._position=i}setPiece(t,e,s=!1){const i=this._position.clone();i.animated=s,i.setPiece(t,e),this._position=i}addMarker(t,e){this.markers.push({square:t,type:e})}removeMarkers(t=void 0,e=void 0){!t&&!e?this.markers=[]:this.markers=this.markers.filter(s=>{if(e){if(t){if(s.type===e&&t===s.square)return!1}else if(s.type===e)return!1}else if(t===s.square)return!1;return!0})}invokeExtensionPoints(t,e={}){const s=this.extensionPoints[t],i=Object.assign({},e);i.extensionPoint=t;let r=!0;if(s)for(const n of s)n(i)===!1&&(r=!1);return r}}const b={waitForInputStart:0,pieceClickedThreshold:1,clickTo:2,secondClickThreshold:3,dragTo:4,clickDragTo:5,moveDone:6,reset:7},ge={secondClick:"secondClick",movedOutOfBoard:"movedOutOfBoard",draggedBack:"draggedBack",clickedAnotherPiece:"clickedAnotherPiece"},ct=4;class zs{constructor(t,e,s,i){this.view=t,this.chessboard=t.chessboard,this.moveInputStartedCallback=r=>{const n=e(r);return n&&(this.chessboard.state.moveInputProcess=mt()),n},this.validateMoveInputCallback=(r,n)=>{const o=s(r,n);return this.chessboard.state.moveInputProcess.resolve(o),o},this.moveInputCanceledCallback=(r,n,o)=>{i(r,n,o),this.chessboard.state.moveInputProcess.resolve()},this.setMoveInputState(b.waitForInputStart)}setMoveInputState(t,e=void 0){const s=this.moveInputState;switch(this.moveInputState=t,t){case b.waitForInputStart:break;case b.pieceClickedThreshold:if(b.waitForInputStart!==s&&b.clickTo!==s)throw new Error("moveInputState");if(this.pointerMoveListener&&(removeEventListener(this.pointerMoveListener.type,this.pointerMoveListener),this.pointerMoveListener=void 0),this.pointerUpListener&&(removeEventListener(this.pointerUpListener.type,this.pointerUpListener),this.pointerUpListener=void 0),this.fromSquare=e.square,this.toSquare=void 0,this.movedPiece=e.piece,this.updateStartEndMarkers(),this.startPoint=e.point,!this.pointerMoveListener&&!this.pointerUpListener)if(e.type==="mousedown")this.pointerMoveListener=this.onPointerMove.bind(this),this.pointerMoveListener.type="mousemove",addEventListener("mousemove",this.pointerMoveListener),this.pointerUpListener=this.onPointerUp.bind(this),this.pointerUpListener.type="mouseup",addEventListener("mouseup",this.pointerUpListener);else if(e.type==="touchstart")this.pointerMoveListener=this.onPointerMove.bind(this),this.pointerMoveListener.type="touchmove",addEventListener("touchmove",this.pointerMoveListener),this.pointerUpListener=this.onPointerUp.bind(this),this.pointerUpListener.type="touchend",addEventListener("touchend",this.pointerUpListener);else throw Error("event type");else throw Error("_pointerMoveListener or _pointerUpListener");break;case b.clickTo:this.draggablePiece&&(q.removeElement(this.draggablePiece),this.draggablePiece=void 0),s===b.dragTo&&this.view.setPieceVisibility(e.square,!0);break;case b.secondClickThreshold:if(b.clickTo!==s)throw new Error("moveInputState");this.startPoint=e.point;break;case b.dragTo:if(b.pieceClickedThreshold!==s)throw new Error("moveInputState");this.view.chessboard.state.inputEnabled&&(this.view.setPieceVisibility(e.square,!1),this.createDraggablePiece(e.piece));break;case b.clickDragTo:if(b.secondClickThreshold!==s)throw new Error("moveInputState");this.view.chessboard.state.inputEnabled&&(this.view.setPieceVisibility(e.square,!1),this.createDraggablePiece(e.piece));break;case b.moveDone:if([b.dragTo,b.clickTo,b.clickDragTo].indexOf(s)===-1)throw new Error("moveInputState");this.toSquare=e.square,this.toSquare&&this.validateMoveInputCallback(this.fromSquare,this.toSquare)?s===b.clickTo?this.chessboard.movePiece(this.fromSquare,this.toSquare,!0).then(()=>{this.setMoveInputState(b.reset)}):this.chessboard.movePiece(this.fromSquare,this.toSquare,!1).then(()=>{this.view.setPieceVisibility(this.toSquare,!0),this.setMoveInputState(b.reset)}):(this.view.setPieceVisibility(this.fromSquare,!0),this.setMoveInputState(b.reset));break;case b.reset:this.fromSquare&&!this.toSquare&&this.movedPiece&&this.chessboard.state.position.setPiece(this.fromSquare,this.movedPiece),this.fromSquare=void 0,this.toSquare=void 0,this.movedPiece=void 0,this.updateStartEndMarkers(),this.draggablePiece&&(q.removeElement(this.draggablePiece),this.draggablePiece=void 0),this.pointerMoveListener&&(removeEventListener(this.pointerMoveListener.type,this.pointerMoveListener),this.pointerMoveListener=void 0),this.pointerUpListener&&(removeEventListener(this.pointerUpListener.type,this.pointerUpListener),this.pointerUpListener=void 0),this.setMoveInputState(b.waitForInputStart);break;default:throw Error(`moveInputState ${t}`)}}createDraggablePiece(t){if(this.draggablePiece)throw Error("draggablePiece exists");this.draggablePiece=q.createSvg(document.body),this.draggablePiece.classList.add("cm-chessboard-draggable-piece"),this.draggablePiece.setAttribute("width",this.view.squareWidth),this.draggablePiece.setAttribute("height",this.view.squareHeight),this.draggablePiece.setAttribute("style","pointer-events: none"),this.draggablePiece.name=t;const e=this.chessboard.props.sprite.cache?"":this.chessboard.props.sprite.url,s=q.addElement(this.draggablePiece,"use",{href:`${e}#${t}`}),i=this.view.squareHeight/this.chessboard.props.sprite.size,r=this.draggablePiece.createSVGTransform();r.setScale(i,i),s.transform.baseVal.appendItem(r)}moveDraggablePiece(t,e){this.draggablePiece.setAttribute("style",`pointer-events: none; position: absolute; left: ${t-this.view.squareHeight/2}px; top: ${e-this.view.squareHeight/2}px`)}onPointerDown(t){if(t.type==="mousedown"&&t.button===0||t.type==="touchstart"){const e=t.target.getAttribute("data-square");if(e){const s=this.chessboard.getPiece(e);let i;if(s&&(i=s?s.substring(0,1):void 0,(i==="w"&&this.chessboard.state.inputWhiteEnabled||i==="b"&&this.chessboard.state.inputBlackEnabled)&&t.preventDefault()),this.moveInputState!==b.waitForInputStart||this.chessboard.state.inputWhiteEnabled&&i==="w"||this.chessboard.state.inputBlackEnabled&&i==="b"){let r;if(t.type==="mousedown"?r={x:t.clientX,y:t.clientY}:t.type==="touchstart"&&(r={x:t.touches[0].clientX,y:t.touches[0].clientY}),this.moveInputState===b.waitForInputStart&&s&&this.moveInputStartedCallback(e))this.setMoveInputState(b.pieceClickedThreshold,{square:e,piece:s,point:r,type:t.type});else if(this.moveInputState===b.clickTo)if(e===this.fromSquare)this.setMoveInputState(b.secondClickThreshold,{square:e,piece:s,point:r,type:t.type});else{const n=this.chessboard.getPiece(e),o=n?n.substring(0,1):void 0,d=this.chessboard.getPiece(this.fromSquare),f=d?d.substring(0,1):void 0;i&&f===o?(this.moveInputCanceledCallback(ge.clickedAnotherPiece,this.fromSquare,e),this.moveInputStartedCallback(e)?this.setMoveInputState(b.pieceClickedThreshold,{square:e,piece:n,point:r,type:t.type}):this.setMoveInputState(b.reset)):this.setMoveInputState(b.moveDone,{square:e})}}}}}onPointerMove(t){let e,s,i,r,n;if(t.type==="mousemove"?(i=t.clientX,r=t.clientY,e=t.pageX,s=t.pageY,n=t.target):t.type==="touchmove"&&(i=t.touches[0].clientX,r=t.touches[0].clientY,e=t.touches[0].pageX,s=t.touches[0].pageY,n=document.elementFromPoint(i,r)),this.moveInputState===b.pieceClickedThreshold||this.moveInputState===b.secondClickThreshold)(Math.abs(this.startPoint.x-i)>ct||Math.abs(this.startPoint.y-r)>ct)&&(this.moveInputState===b.secondClickThreshold?this.setMoveInputState(b.clickDragTo,{square:this.fromSquare,piece:this.movedPiece}):this.setMoveInputState(b.dragTo,{square:this.fromSquare,piece:this.movedPiece}),this.view.chessboard.state.inputEnabled&&this.moveDraggablePiece(e,s));else if(this.moveInputState===b.dragTo||this.moveInputState===b.clickDragTo||this.moveInputState===b.clickTo){if(n&&n.getAttribute&&n.parentElement===this.view.boardGroup){const o=n.getAttribute("data-square");o!==this.fromSquare&&o!==this.toSquare?(this.toSquare=o,this.updateStartEndMarkers()):o===this.fromSquare&&this.toSquare!==void 0&&(this.toSquare=void 0,this.updateStartEndMarkers())}else this.toSquare!==void 0&&(this.toSquare=void 0,this.updateStartEndMarkers());this.view.chessboard.state.inputEnabled&&(this.moveInputState===b.dragTo||this.moveInputState===b.clickDragTo)&&this.moveDraggablePiece(e,s)}}onPointerUp(t){let e;if(t.type==="mouseup"?e=t.target:t.type==="touchend"&&(e=document.elementFromPoint(t.changedTouches[0].clientX,t.changedTouches[0].clientY)),e&&e.getAttribute){const s=e.getAttribute("data-square");if(s)this.moveInputState===b.dragTo||this.moveInputState===b.clickDragTo?this.fromSquare===s?this.moveInputState===b.clickDragTo?(this.chessboard.state.position.setPiece(this.fromSquare,this.movedPiece),this.view.setPieceVisibility(this.fromSquare),this.moveInputCanceledCallback(ge.draggedBack,s,s),this.setMoveInputState(b.reset)):this.setMoveInputState(b.clickTo,{square:s}):this.setMoveInputState(b.moveDone,{square:s}):this.moveInputState===b.pieceClickedThreshold?this.setMoveInputState(b.clickTo,{square:s}):this.moveInputState===b.secondClickThreshold&&(this.setMoveInputState(b.reset),this.moveInputCanceledCallback(ge.secondClick,s,s));else{this.view.redrawPieces();const i=this.fromSquare;this.setMoveInputState(b.reset),this.moveInputCanceledCallback(ge.movedOutOfBoard,i,void 0)}}else this.view.redrawPieces(),this.setMoveInputState(b.reset)}updateStartEndMarkers(){this.chessboard.props.style.moveFromMarker&&this.chessboard.state.removeMarkers(void 0,this.chessboard.props.style.moveFromMarker),this.chessboard.props.style.moveToMarker&&this.chessboard.state.removeMarkers(void 0,this.chessboard.props.style.moveToMarker),this.chessboard.props.style.moveFromMarker&&this.fromSquare&&this.chessboard.state.addMarker(this.fromSquare,this.chessboard.props.style.moveFromMarker),this.chessboard.props.style.moveToMarker&&this.toSquare&&this.chessboard.state.addMarker(this.toSquare,this.chessboard.props.style.moveToMarker),this.view.drawMarkers()}reset(){this.setMoveInputState(b.reset)}destroy(){this.reset()}}const B={positionChanged:"positionChanged",boardChanged:"boardChanged",moveInputToggled:"moveInputToggled",moveInput:"moveInput",redrawBoard:"redrawBoard",destroy:"destroy"};class Qs{constructor(t,e){this.chessboard=t,this.props=e}registerExtensionPoint(t,e){this.chessboard.state.extensionPoints[t]||(this.chessboard.state.extensionPoints[t]=[]),this.chessboard.state.extensionPoints[t].push(e)}registerMethod(t,e){this.chessboard[t]?log.error("method",t,"already exists"):this.chessboard[t]=(...s)=>e.apply(this,s)}}class Vs{constructor(t){this.chessboard=t,this.moveInput=new zs(this,this.moveInputStartedCallback.bind(this),this.validateMoveInputCallback.bind(this),this.moveInputCanceledCallback.bind(this)),t.props.sprite.cache&&this.cacheSpriteToDiv("chessboardSpriteCache",this.chessboard.props.sprite.url),this.context=document.createElement("div"),this.chessboard.context.appendChild(this.context),t.props.responsive&&(typeof ResizeObserver<"u"?(this.resizeObserver=new ResizeObserver(()=>{this.handleResize()}),this.resizeObserver.observe(this.chessboard.context)):(this.resizeListener=this.handleResize.bind(this),window.addEventListener("resize",this.resizeListener))),this.pointerDownListener=this.pointerDownHandler.bind(this),this.pointerDownListener=this.pointerDownHandler.bind(this),this.context.addEventListener("mousedown",this.pointerDownListener),this.context.addEventListener("touchstart",this.pointerDownListener),this.createSvgAndGroups(),this.updateMetrics(),this.handleResize(),this.redrawBoard()}pointerDownHandler(t){this.moveInput.onPointerDown(t)}destroy(){this.moveInput.destroy(),this.resizeObserver&&this.resizeObserver.unobserve(this.chessboard.context),this.resizeListener&&window.removeEventListener("resize",this.resizeListener),this.chessboard.context.removeEventListener("mousedown",this.pointerDownListener),this.chessboard.context.removeEventListener("touchstart",this.pointerDownListener),this.animationQueue=[],this.currentAnimation&&cancelAnimationFrame(this.currentAnimation.frameHandle),q.removeElement(this.svg)}cacheSpriteToDiv(t,e){if(!document.getElementById(t)){const s=document.createElement("div");s.style.display="none",s.id=t,document.body.appendChild(s);const i=new XMLHttpRequest;i.open("GET",e,!0),i.onload=function(){s.insertAdjacentHTML("afterbegin",i.response)},i.send()}}createSvgAndGroups(){this.svg=q.createSvg(this.context);let t=this.chessboard.props.style.cssClass?this.chessboard.props.style.cssClass:"default";this.svg.setAttribute("class","cm-chessboard border-type-"+this.chessboard.props.style.borderType+" "+t),this.svg.setAttribute("role","img"),this.updateMetrics(),this.boardGroup=q.addElement(this.svg,"g",{class:"board"}),this.coordinatesGroup=q.addElement(this.svg,"g",{class:"coordinates"}),this.markersLayer=q.addElement(this.svg,"g",{class:"markers-layer"}),this.markersGroup=q.addElement(this.markersLayer,"g",{class:"markers"}),this.piecesLayer=q.addElement(this.svg,"g",{class:"pieces-layer"}),this.piecesGroup=q.addElement(this.piecesLayer,"g",{class:"pieces"}),this.markersTopLayer=q.addElement(this.svg,"g",{class:"markers-top-layer"})}updateMetrics(){this.width=this.context.clientWidth,this.height=this.context.clientWidth*(this.chessboard.props.style.aspectRatio||1),this.chessboard.props.style.borderType===ee.frame?this.borderSize=this.width/25:this.chessboard.props.style.borderType===ee.thin?this.borderSize=this.width/320:this.borderSize=0,this.innerWidth=this.width-2*this.borderSize,this.innerHeight=this.height-2*this.borderSize,this.squareWidth=this.innerWidth/8,this.squareHeight=this.innerHeight/8,this.scalingX=this.squareWidth/this.chessboard.props.sprite.size,this.scalingY=this.squareHeight/this.chessboard.props.sprite.size,this.pieceXTranslate=this.squareWidth/2-this.chessboard.props.sprite.size*this.scalingY/2}handleResize(){this.context.style.width=this.chessboard.context.clientWidth+"px",this.context.style.height=this.chessboard.context.clientWidth*this.chessboard.props.style.aspectRatio+"px",(this.context.clientWidth!==this.width||this.context.clientHeight!==this.height)&&(this.updateMetrics(),this.redrawBoard(),this.redrawPieces()),this.svg.setAttribute("width","100%"),this.svg.setAttribute("height","100%")}redrawBoard(){this.redrawSquares(),this.drawCoordinates(),this.drawMarkers(),this.chessboard.state.invokeExtensionPoints(B.redrawBoard),this.visualizeInputState()}redrawSquares(){for(;this.boardGroup.firstChild;)this.boardGroup.removeChild(this.boardGroup.lastChild);if(q.addElement(this.boardGroup,"rect",{width:this.width,height:this.height}).setAttribute("class","border"),this.chessboard.props.style.borderType===ee.frame){const e=this.borderSize;q.addElement(this.boardGroup,"rect",{x:e,y:e,width:this.width-e*2,height:this.height-e*2}).setAttribute("class","border-inner")}for(let e=0;e<64;e++){const s=this.chessboard.state.orientation===F.white?e:63-e,r=`square ${(9*s&8)===0?"black":"white"}`,n=this.squareToPoint(T.indexToSquare(s)),o=q.addElement(this.boardGroup,"rect",{x:n.x,y:n.y,width:this.squareWidth,height:this.squareHeight});o.setAttribute("class",r),o.setAttribute("data-square",T.indexToSquare(s))}}drawCoordinates(){if(!this.chessboard.props.style.showCoordinates)return;for(;this.coordinatesGroup.firstChild;)this.coordinatesGroup.removeChild(this.coordinatesGroup.lastChild);const t=this.chessboard.props.style.borderType!==ee.frame;for(let e=0;e<8;e++){let s=this.borderSize+(17+this.chessboard.props.sprite.size*e)*this.scalingX,i=this.height-this.scalingY*3.5,r="coordinate file";t&&(s=s+this.scalingX*15.5,r+=e%2?" white":" black");const n=q.addElement(this.coordinatesGroup,"text",{class:r,x:s,y:i,style:`font-size: ${this.scalingY*10}px`});this.chessboard.state.orientation===F.white?n.textContent=String.fromCharCode(97+e):n.textContent=String.fromCharCode(104-e)}for(let e=0;e<8;e++){let s=this.borderSize/3.7,i=this.borderSize+25*this.scalingY+e*this.squareHeight,r="coordinate rank";t&&(r+=e%2?" black":" white",this.chessboard.props.style.borderType===ee.frame?(s=s+this.scalingX*10,i=i-this.scalingY*15):(s=s+this.scalingX*2,i=i-this.scalingY*15));const n=q.addElement(this.coordinatesGroup,"text",{class:r,x:s,y:i,style:`font-size: ${this.scalingY*10}px`});this.chessboard.state.orientation===F.white?n.textContent=""+(8-e):n.textContent=""+(1+e)}}redrawPieces(t=this.chessboard.state.position.squares){const e=Array.from(this.piecesGroup.childNodes);for(let s=0;s<64;s++){const i=t[s];i&&this.drawPieceOnSquare(T.indexToSquare(s),i)}for(const s of e)this.piecesGroup.removeChild(s)}drawPiece(t,e,s){const i=q.addElement(t,"g",{});i.setAttribute("data-piece",e),i.setAttribute("class","piece-group");const r=this.svg.createSVGTransform();r.setTranslate(s.x,s.y),i.transform.baseVal.appendItem(r);const n=this.chessboard.props.sprite.cache?"":this.chessboard.props.sprite.url,o=q.addElement(i,"use",{href:`${n}#${e}`,class:"piece"}),d=this.svg.createSVGTransform();d.setScale(this.scalingY,this.scalingY),o.transform.baseVal.appendItem(d);const f=this.svg.createSVGTransform();return f.setTranslate(this.pieceXTranslate,0),o.transform.baseVal.appendItem(f),i}drawPieceOnSquare(t,e){const s=this.squareToPoint(t),i=this.drawPiece(this.piecesGroup,e,s);return i.setAttribute("data-square",t),i}setPieceVisibility(t,e=!0){const s=this.getPieceElement(t);s?e?s.setAttribute("visibility","visible"):s.setAttribute("visibility","hidden"):console.warn("no piece on",t)}getPieceElement(t){if(t.length<2)throw new Error("980e03");const e=this.piecesGroup.querySelector(`g[data-square='${t}']`);return e||console.warn("no piece on",t),e}drawMarkers(){for(;this.markersGroup.firstChild;)this.markersGroup.removeChild(this.markersGroup.firstChild);this.chessboard.state.markers.forEach(t=>{this.drawMarker(t)})}drawMarker(t){const e=q.addElement(this.markersGroup,"g");e.setAttribute("data-square",t.square);const s=this.squareToPoint(t.square),i=this.svg.createSVGTransform();i.setTranslate(s.x,s.y),e.transform.baseVal.appendItem(i);const r=this.chessboard.props.sprite.cache?"":this.chessboard.props.sprite.url,n=q.addElement(e,"use",{href:`${r}#${t.type.slice}`,class:"marker "+t.type.class}),o=this.svg.createSVGTransform();return o.setScale(this.scalingX,this.scalingY),n.transform.baseVal.appendItem(o),e}enableMoveInput(t,e=void 0){e===F.white?this.chessboard.state.inputWhiteEnabled=!0:e===F.black?this.chessboard.state.inputBlackEnabled=!0:(this.chessboard.state.inputWhiteEnabled=!0,this.chessboard.state.inputBlackEnabled=!0),this.chessboard.state.inputEnabled=!0,this.moveInputCallback=t,this.chessboard.state.invokeExtensionPoints(B.moveInputToggled,{enabled:!0,color:e}),this.visualizeInputState()}disableMoveInput(){this.chessboard.state.inputWhiteEnabled=!1,this.chessboard.state.inputBlackEnabled=!1,this.chessboard.state.inputEnabled=!1,this.moveInputCallback=void 0,this.chessboard.state.invokeExtensionPoints(B.moveInputToggled,{enabled:!1}),this.visualizeInputState()}moveInputStartedCallback(t){const e={chessboard:this.chessboard,type:se.moveInputStarted,square:t,piece:this.chessboard.getPiece(t)};return this.moveInputCallback&&(e.moveInputCallbackResult=this.moveInputCallback(e)),!(this.chessboard.state.invokeExtensionPoints(B.moveInput,e)===!1||!e.moveInputCallbackResult)}validateMoveInputCallback(t,e){const s={chessboard:this.chessboard,type:se.validateMoveInput,squareFrom:t,squareTo:e,piece:this.chessboard.getPiece(t)};return this.moveInputCallback&&(s.moveInputCallbackResult=this.moveInputCallback(s)),!(this.chessboard.state.invokeExtensionPoints(B.moveInput,s)===!1||!s.moveInputCallbackResult)}moveInputCanceledCallback(t,e,s){const i={chessboard:this.chessboard,type:se.moveInputCanceled,reason:t,squareFrom:e,squareTo:s};this.chessboard.state.invokeExtensionPoints(B.moveInput,i),this.moveInputCallback&&this.moveInputCallback(i)}visualizeInputState(){this.chessboard.state&&(this.chessboard.state.inputWhiteEnabled||this.chessboard.state.inputBlackEnabled||this.chessboard.state.squareSelectEnabled?this.boardGroup.setAttribute("class","board input-enabled"):this.boardGroup.setAttribute("class","board"))}indexToPoint(t){let e,s;return this.chessboard.state.orientation===F.white?(e=this.borderSize+t%8*this.squareWidth,s=this.borderSize+(7-Math.floor(t/8))*this.squareHeight):(e=this.borderSize+(7-t%8)*this.squareWidth,s=this.borderSize+Math.floor(t/8)*this.squareHeight),{x:e,y:s}}squareToPoint(t){const e=T.squareToIndex(t);return this.indexToPoint(e)}}const ut="http://www.w3.org/2000/svg";class q{static createSvg(t=void 0){let e=document.createElementNS(ut,"svg");return t&&(e.setAttribute("width","100%"),e.setAttribute("height","100%"),t.appendChild(e)),e}static addElement(t,e,s,i=void 0){let r=document.createElementNS(ut,e);e==="use"&&(s["xlink:href"]=s.href);for(let n in s)if(s.hasOwnProperty(n))if(n.indexOf(":")!==-1){const o=n.split(":");r.setAttributeNS("http://www.w3.org/1999/"+o[0],o[1],s[n])}else r.setAttribute(n,s[n]);return i!==void 0?t.appendChild(r):t.insertBefore(r,i),r}static removeElement(t){t.parentNode?t.parentNode.removeChild(t):console.warn(t,"without parentNode")}}class js{static delegate(t,e,s,i){const r=function(n){let o=n.target;for(;o&&o!==this;)o.matches(s)&&i.call(o,n),o=o.parentNode};return t.addEventListener(e,r),{remove:function(){t.removeEventListener(e,r)}}}}class Ys{constructor(){this.queue=[],this.workingOnPromise=!1,this.stop=!1}async enqueue(t){return new Promise((e,s)=>{this.queue.push({promise:t,resolve:e,reject:s}),this.dequeue()})}dequeue(){if(this.workingOnPromise)return;if(this.stop){this.queue=[],this.stop=!1;return}const t=this.queue.shift();if(t){try{this.workingOnPromise=!0,t.promise().then(e=>{this.workingOnPromise=!1,t.resolve(e),this.dequeue()}).catch(e=>{this.workingOnPromise=!1,t.reject(e),this.dequeue()})}catch(e){this.workingOnPromise=!1,t.reject(e),this.dequeue()}return!0}}destroy(){this.stop=!0}}const U={move:0,appear:1,disappear:2};class te{constructor(t,e,s,i,r){this.view=t,e&&s?(this.animatedElements=this.createAnimation(e.squares,s.squares),this.duration=i,this.callback=r,this.frameHandle=requestAnimationFrame(this.animationStep.bind(this))):console.error("fromPosition",e,"toPosition",s)}static seekChanges(t,e){const s=[],i=[],r=[];for(let n=0;n<64;n++){const o=t[n],d=e[n];d!==o&&(d&&s.push({piece:d,index:n}),o&&i.push({piece:o,index:n}))}return s.forEach(n=>{let o=8,d;i.forEach(f=>{if(n.piece===f.piece){const m=te.squareDistance(n.index,f.index);m<o&&(d=f,o=m)}}),d?(i.splice(i.indexOf(d),1),r.push({type:U.move,piece:n.piece,atIndex:d.index,toIndex:n.index})):r.push({type:U.appear,piece:n.piece,atIndex:n.index})}),i.forEach(n=>{r.push({type:U.disappear,piece:n.piece,atIndex:n.index})}),r}createAnimation(t,e){const s=te.seekChanges(t,e),i=[];return s.forEach(r=>{const n={type:r.type};switch(r.type){case U.move:n.element=this.view.getPieceElement(T.indexToSquare(r.atIndex)),n.element.parentNode.appendChild(n.element),n.atPoint=this.view.indexToPoint(r.atIndex),n.toPoint=this.view.indexToPoint(r.toIndex);break;case U.appear:n.element=this.view.drawPieceOnSquare(T.indexToSquare(r.atIndex),r.piece),n.element.style.opacity=0;break;case U.disappear:n.element=this.view.getPieceElement(T.indexToSquare(r.atIndex));break}i.push(n)}),i}animationStep(t){this.startTime||(this.startTime=t);const e=t-this.startTime;if(e<=this.duration)this.frameHandle=requestAnimationFrame(this.animationStep.bind(this));else{cancelAnimationFrame(this.frameHandle),this.animatedElements.forEach(r=>{r.type===U.disappear&&q.removeElement(r.element)}),this.callback();return}const s=Math.min(1,e/this.duration);let i=s<.5?2*s*s:-1+(4-2*s)*s;isNaN(i)&&(i=1),this.animatedElements.forEach(r=>{if(r.element)switch(r.type){case U.move:r.element.transform.baseVal.removeItem(0);const n=this.view.svg.createSVGTransform();n.setTranslate(r.atPoint.x+(r.toPoint.x-r.atPoint.x)*i,r.atPoint.y+(r.toPoint.y-r.atPoint.y)*i),r.element.transform.baseVal.appendItem(n);break;case U.appear:r.element.style.opacity=Math.round(i*100)/100;break;case U.disappear:r.element.style.opacity=Math.round((1-i)*100)/100;break}else console.warn("animatedItem has no element",r)})}static squareDistance(t,e){const s=t%8,i=Math.floor(t/8),r=e%8,n=Math.floor(e/8);return Math.max(Math.abs(n-i),Math.abs(r-s))}}class Xs extends Ys{constructor(t){super(),this.chessboard=t}async enqueuePositionChange(t,e,s){return t.getFen()===e.getFen()?Promise.resolve():super.enqueue(()=>new Promise(i=>{let r=s?this.chessboard.props.animationDuration:0;this.queue.length>0&&(r=r/(1+Math.pow(this.queue.length/5,2))),new te(this.chessboard.view,t,e,s?r:0,()=>{this.chessboard.view&&this.chessboard.view.redrawPieces(e.squares),i()})}))}async enqueueTurnBoard(t,e,s){return super.enqueue(()=>new Promise(i=>{const r=new T(ae.empty);let n=s?this.chessboard.props.animationDuration:0;this.queue.length>0&&(n=n/(1+Math.pow(this.queue.length/5,2))),new te(this.chessboard.view,t,r,s?n:0,()=>{this.chessboard.state.orientation=e,this.chessboard.view.redrawBoard(),this.chessboard.view.redrawPieces(r.squares),new te(this.chessboard.view,r,t,s?n:0,()=>{this.chessboard.view.redrawPieces(t.squares),i()})})}))}}const F={white:"w",black:"b"},se={moveInputStarted:"moveInputStarted",validateMoveInput:"validateMoveInput",moveInputCanceled:"moveInputCanceled"},dt={primary:"primary",secondary:"secondary"},ee={none:"none",thin:"thin",frame:"frame"},j={frame:{class:"marker-frame",slice:"markerFrame"},dot:{class:"marker-dot",slice:"markerDot"},circle:{class:"marker-circle",slice:"markerCircle"}},Q={wp:"wp",wb:"wb",wn:"wn",wr:"wr",wq:"wq",wk:"wk",bp:"bp",bb:"bb",bn:"bn",br:"br",bq:"bq",bk:"bk"};class Zs{constructor(t,e={}){if(!t)throw new Error("container element is "+t);this.context=t,this.id=(Math.random()+1).toString(36).substring(2,8),this.extensions=[];let s={position:ae.empty,orientation:F.white,responsive:!0,animationDuration:300,language:navigator.language.substring(0,2).toLowerCase(),style:{cssClass:"default",showCoordinates:!0,borderType:ee.none,aspectRatio:1,moveFromMarker:j.frame,moveToMarker:j.frame},sprite:{url:"./assets/images/chessboard-sprite.svg",size:40,cache:!0},extensions:[]};this.props={},Object.assign(this.props,s),Object.assign(this.props,e),this.props.sprite=s.sprite,this.props.style=s.style,e.sprite&&Object.assign(this.props.sprite,e.sprite),e.style&&Object.assign(this.props.style,e.style),e.extensions&&(this.props.extensions=e.extensions),this.props.language!=="de"&&this.props.language!=="en"&&(this.props.language="en"),this.state=new Ws,this.view=new Vs(this),this.positionAnimationsQueue=new Xs(this),this.state.orientation=this.props.orientation;for(const i of this.props.extensions)this.extensions.push(new i.class(this,i.props));this.view.redrawBoard(),this.state.position=new T(this.props.position),this.view.redrawPieces(),this.state.invokeExtensionPoints(B.positionChanged)}async setPiece(t,e,s=!1){const i=this.state.position.clone();return this.state.position.setPiece(t,e),this.state.invokeExtensionPoints(B.positionChanged),this.positionAnimationsQueue.enqueuePositionChange(i,this.state.position.clone(),s)}async movePiece(t,e,s=!1){const i=this.state.position.clone();return this.state.position.movePiece(t,e),this.state.invokeExtensionPoints(B.positionChanged),this.positionAnimationsQueue.enqueuePositionChange(i,this.state.position.clone(),s)}async setPosition(t,e=!1){const s=this.state.position.clone(),i=new T(t);return s.getFen()!==i.getFen()&&(this.state.position.setFen(t),this.state.invokeExtensionPoints(B.positionChanged)),this.positionAnimationsQueue.enqueuePositionChange(s,this.state.position.clone(),e)}async setOrientation(t,e=!1){const s=this.state.position.clone();if(this.boardTurning){console.log("setOrientation is only once in queue allowed");return}return this.boardTurning=!0,this.positionAnimationsQueue.enqueueTurnBoard(s,t,e).then(()=>{this.boardTurning=!1,this.state.invokeExtensionPoints(B.boardChanged)})}getPiece(t){return this.state.position.getPiece(t)}getPosition(){return this.state.position.getFen()}getOrientation(){return this.state.orientation}addMarker(t,e){if(typeof t=="string"||typeof e=="object"){console.error("changed the signature of `addMarker` to `(type, square)` with v5.1.x");return}this.state.addMarker(e,t),this.view.drawMarkers()}getMarkers(t=void 0,e=void 0){if(typeof t=="string"||typeof e=="object"){console.error("changed the signature of `getMarkers` to `(type, square)` with v5.1.x");return}const s=[];return this.state.markers.forEach(i=>{const r=i.square;(!e&&(!t||t===i.type)||!t&&e===r||t===i.type&&e===r)&&s.push({square:i.square,type:i.type})}),s}removeMarkers(t=void 0,e=void 0){if(typeof t=="string"||typeof e=="object"){console.error("changed the signature of `removeMarkers` to `(type, square)` with v5.1.x");return}this.state.removeMarkers(e,t),this.view.drawMarkers()}enableMoveInput(t,e=void 0){this.view.enableMoveInput(t,e)}disableMoveInput(){this.view.disableMoveInput()}enableSquareSelect(t){if(this.squareSelectListener){console.warn("squareSelectListener already existing");return}this.squareSelectListener=function(e){const s=e.target.getAttribute("data-square");if(e.type==="contextmenu"){e.preventDefault();return}t({mouseEvent:e,chessboard:this,type:e.button===2?dt.secondary:dt.primary,square:s})},this.context.addEventListener("contextmenu",this.squareSelectListener),this.context.addEventListener("mousedown",this.squareSelectListener),this.context.addEventListener("mouseup",this.squareSelectListener),this.context.addEventListener("touchstart",this.squareSelectListener),this.context.addEventListener("touchend",this.squareSelectListener),this.state.squareSelectEnabled=!0,this.view.visualizeInputState()}disableSquareSelect(){this.context.removeEventListener("contextmenu",this.squareSelectListener),this.context.removeEventListener("mousedown",this.squareSelectListener),this.context.removeEventListener("mouseup",this.squareSelectListener),this.context.removeEventListener("touchstart",this.squareSelectListener),this.context.removeEventListener("touchend",this.squareSelectListener),this.squareSelectListener=void 0,this.state.squareSelectEnabled=!1,this.view.visualizeInputState()}destroy(){this.state.invokeExtensionPoints(B.destroy),this.positionAnimationsQueue.destroy(),this.view.destroy(),this.view=void 0,this.state=void 0,this.squareSelectListener&&(this.context.removeEventListener("contextmenu",this.squareSelectListener),this.context.removeEventListener("mouseup",this.squareSelectListener),this.context.removeEventListener("touchend",this.squareSelectListener))}}class Js extends Qs{constructor(t,e){super(t,e),this.registerExtensionPoint(B.redrawBoard,this.redrawDialog.bind(this)),this.registerMethod("showPromotionDialog",this.showPromotionDialog),this.promotionDialogGroup=q.addElement(t.view.markersTopLayer,"g",{class:"promotion-dialog-group"}),js.delegate(this.promotionDialogGroup,"click",".promotion-dialog-button",this.promotionDialogOnClickPiece.bind(this)),this.state={isShown:!1,color:void 0,square:void 0,callback:void 0}}drawPieceButton(t,e){const s=this.chessboard.view.squareWidth,i=this.chessboard.view.squareHeight;q.addElement(this.promotionDialogGroup,"rect",{x:e.x,y:e.y,width:s,height:i,class:"promotion-dialog-button","data-piece":t}),this.chessboard.view.drawPiece(this.promotionDialogGroup,t,e)}redrawDialog(){this.state.square&&(clearTimeout(this.redrawDialogDebounce),this.redrawDialogDebounce=setTimeout(()=>{const t=this.chessboard.view.squareWidth,e=this.chessboard.view.squareHeight,s=this.chessboard.view.squareToPoint(this.state.square);for(s.x=s.x+t/2,s.y=s.y+e/2;this.promotionDialogGroup.firstChild;)this.promotionDialogGroup.removeChild(this.promotionDialogGroup.firstChild);if(this.state.isShown){let i=!1;const r=parseInt(this.state.square.charAt(1),10);(this.chessboard.getOrientation()===F.white&&r<5||this.chessboard.getOrientation()===F.black&&r>=5)&&(i=!0);const n=i?-4*e:0,o=s.x+t>this.chessboard.view.width?-t:0;q.addElement(this.promotionDialogGroup,"rect",{x:s.x+o,y:s.y+n,width:t,height:e*4,class:"promotion-dialog"}),i?(this.drawPieceButton(Q[this.state.color+"q"],{x:s.x+o,y:s.y-e}),this.drawPieceButton(Q[this.state.color+"r"],{x:s.x+o,y:s.y-e*2}),this.drawPieceButton(Q[this.state.color+"b"],{x:s.x+o,y:s.y-e*3}),this.drawPieceButton(Q[this.state.color+"n"],{x:s.x+o,y:s.y-e*4})):(this.drawPieceButton(Q[this.state.color+"q"],{x:s.x+o,y:s.y}),this.drawPieceButton(Q[this.state.color+"r"],{x:s.x+o,y:s.y+e}),this.drawPieceButton(Q[this.state.color+"b"],{x:s.x+o,y:s.y+e*2}),this.drawPieceButton(Q[this.state.color+"n"],{x:s.x+o,y:s.y+e*3}))}},200))}promotionDialogOnClickPiece(t){this.state.isShown=!1,this.chessboard.disableSquareSelect(),this.state.callback({square:this.state.square,piece:t.target.dataset.piece}),this.redrawDialog()}showPromotionDialog(t,e,s){this.state.isShown=!0,this.state.square=t,this.state.color=e,this.state.callback=s;const i=r=>{!r.target.dataset.piece&&this.state.isShown&&(this.state.isShown=!1,this.state.callback({square:this.state.square,piece:null}),this.redrawDialog()),this.chessboard.view.svg.removeEventListener("mousedown",i)};this.chessboard.view.svg.addEventListener("mousedown",i),this.redrawDialog()}}const ft={class:"myMarkerMoveWhite",slice:"markerSquare"},pt={class:"myMarkerMoveBlack",slice:"markerSquare"};function ei(h){const t=h.charCodeAt(0)-97;return 8*(parseInt(h.charAt(1))-1)+t}class Le{constructor(){this.player=F.white,this.chessGame=new Ks,this.evalBar=new si("evalBar"),this.chessBoard=this.initChessBoard(),this.engineWorker=new Worker(new URL("/assets/engineWorker-BDxUaDqs.js",import.meta.url),{type:"module"}),this.possibleTargets=null,this.gameOverOverlay=document.getElementById("gameOverOverlay"),this.gameOverText=document.getElementById("gameOverText"),this.gameOverRestartBtn=document.getElementById("gameOverRestart")}static async create(){const t=new Le;return t.reset(),t.gameOverRestartBtn.onclick=()=>t.reset(),window.addEventListener("resize",()=>t.resize()),t.resize(),await new Promise(e=>{t.engineWorker.onmessage=s=>{const{type:i,data:r}=s.data;i==="ready"?e():i==="searchResult"?t.updateSearchData?.(r):i==="perftResult"?t.updatePerftData?.(r):i==="enginePick"&&t.updateEnginePick?.(r)},t.engineWorker.postMessage({type:"init"})}),t}removeTargetHighlights(){this.chessBoard.removeMarkers(j.dot),this.chessBoard.removeMarkers(j.circle),this.possibleTargets=null}removeMoveHighlights(){this.chessBoard.removeMarkers(ft),this.chessBoard.removeMarkers(pt)}addTargetHighlights(t){const e=this.chessGame.moves({square:t,verbose:!0});this.removeTargetHighlights(),this.possibleTargets=new Set;for(let s=0;s<e.length;s++){const i=e[s].to,n=this.chessGame.get(i)!==void 0?j.circle:j.dot;this.chessBoard.addMarker(n,i),this.possibleTargets.add(i)}}addMoveHighlight(t){ei(t)%2===0?this.chessBoard.addMarker(pt,t):this.chessBoard.addMarker(ft,t)}addMoveHighlights(t,e){this.addMoveHighlight(t),this.addMoveHighlight(e)}makeEngineMove(){const t="fen "+this.chessGame.fen();this.engineWorker.postMessage({type:"search",data:{position:t,tc:"wtime 10000 btime 10000 winc 0 binc 0"}})}showGameOver(t){this.gameOverText.textContent=t,this.gameOverOverlay.classList.add("visible"),this.gameOverOverlay.setAttribute("aria-hidden","false")}hideGameOver(){this.gameOverOverlay.classList.remove("visible"),this.gameOverOverlay.setAttribute("aria-hidden","true")}gameOver(){if(this.chessGame.isCheckmate()){const t=this.chessGame.turn(),e=t!==this.player,s=t==="b";this.evalBar.updateEvaluation(s?"Mate":"Mated",{val:1,w:s?1e3:0,d:0,l:s?0:1e3}),this.showGameOver(e?"You win!":"You lose!")}else this.evalBar.updateEvaluation("cp",{val:0,w:0,d:1e3,l:0}),this.showGameOver("It's a draw!")}async applyMoveToGame(t,e=!1){const s=this.chessGame.move(t);await this.chessBoard.setPosition(this.chessGame.fen(),!0),this.removeMoveHighlights(),this.addMoveHighlights(s.from,s.to),this.chessGame.isGameOver()?this.gameOver():e&&this.makeEngineMove()}moveEventHandler(t){switch(t.type){case se.moveInputStarted:return this.addTargetHighlights(t.square),!0;case se.validateMoveInput:const[e,s,i]=[t.squareFrom,t.squareTo,t.piece],n=i.charAt(0)!=this.player||!this.possibleTargets?.has(s);if(this.removeTargetHighlights(),n)return!1;const o=i.charAt(1)==="p",d=s.charAt(1),f=d=="8"&&this.player===F.white||d=="1"&&this.player===F.black;return o&&f?(this.chessBoard.showPromotionDialog(s,this.player,m=>{m&&m.piece?this.applyMoveToGame({from:e,to:s,promotion:m.piece.charAt(1)},!0):this.chessBoard.movePiece(s,e,!1)}),!0):(this.applyMoveToGame({from:e,to:s},!0),!0);case se.moveInputCanceled:this.removeTargetHighlights()}}initChessBoard(){const t={position:this.chessGame.fen(),orientation:this.player,responsive:!0,animationDuration:200,style:{cssClass:"green",showCoordinates:!1,borderType:"none",aspectRatio:1,moveFromMarker:j.frame,moveToMarker:j.frame},sprite:{url:"/vendor/chessboard-sprite-staunty.svg",size:40,cache:!0},extensions:[{class:Js}]},e=document.getElementById("board"),s=new Zs(e,t);return s.enableMoveInput(i=>this.moveEventHandler(i)),s}resize(){const t=document.getElementById("evalBar");t.style.height="0px",this.chessBoard.view.handleResize();const s=document.getElementById("board").getBoundingClientRect();t.style.height=s.height+"px"}async reset(){this.resize(),this.hideGameOver(),this.removeMoveHighlights(),this.chessGame.reset(),this.evalBar.reset(),await this.chessBoard.setPosition(this.chessGame.fen(),!0),this.player==="b"&&(await this.chessBoard.setOrientation(this.player),this.makeEngineMove())}updatePerftData(t){console.log("Perft speed: ",t.nps)}updateSearchData(t){console.log("Search speed: ",t.nps);const[e,s]=this.getWhiteScore(t.score_type,t.score);this.evalBar.updateEvaluation(e,s)}getWhiteScore(t,e){if(this.player=="b")return[t,e];t==="Mate"?t="Mated":t==="Mated"?t="Mate":e.val=-e.val;const[s,i]=[e.w,e.l];return e.w=i,e.l=s,[t,e]}async updateEnginePick(t){console.log("Engine pick: ",t),this.applyMoveToGame(t)}}function ti(h){return h===0?0:h<7?-(.322495*Math.pow(h,2))+7.26599*h+4.11834:8*h/145+5881/145}class si{constructor(t){this.minRoomPercent=10,this.container=document.getElementById(t),this.blackDiv=this.container.querySelector(".eval-bar-black"),this.whiteDiv=this.container.querySelector(".eval-bar-white"),this.scoreDivWhite=this.container.querySelector(".eval-bar-score.white"),this.scoreDivBlack=this.container.querySelector(".eval-bar-score.black")}reset(){this.blackDiv.style.height="50%",this.whiteDiv.style.height="50%",this.scoreDivWhite.style.display="none",this.scoreDivBlack.style.display="none"}updateEvaluation(t,e){let s=.5,i="",r=!0,n=!1;if(t==="Cp"){const o=e.val/100,d=ti(Math.abs(o)),f=Math.min(50-this.minRoomPercent,d);i=(o>0?"+":"")+o.toFixed(2),s=(50+(o>0?f:-f))/100,r=!0,n=!1}else t==="Mate"?(s=1,i=`M${e.val}`,r=!0,n=!1):t==="Mated"&&(s=0,i=`-M${e.val}`,r=!1,n=!0);this.whiteDiv.style.height=`${s*100}%`,this.blackDiv.style.height=`${(1-s)*100}%`,this.scoreDivWhite.style.display=r?"block":"none",this.scoreDivBlack.style.display=n?"block":"none",r&&(this.scoreDivWhite.textContent=i,this.scoreDivWhite.style.color="#222",this.scoreDivWhite.style.top="2px"),n&&(this.scoreDivBlack.textContent=i,this.scoreDivBlack.style.color="#fff",this.scoreDivBlack.style.bottom="2px")}}const ii=await Le.create();class ri{constructor(){this.currentPage=this.getInitialPage(),this.setupNavigation(),this.loadPage(this.currentPage),this.setupExternalLinks(),this.setupPopState()}getInitialPage(){const t=window.location.hash.slice(1);return t&&["home","about","chess","github"].includes(t)?t:"home"}setupNavigation(){document.querySelectorAll(".nav-link").forEach(e=>{e.addEventListener("click",s=>{s.preventDefault();const i=e.getAttribute("data-page");i&&i!==this.currentPage&&this.loadPage(i)})}),document.addEventListener("keydown",e=>{switch(e.key){case"1":e.preventDefault(),this.loadPage("home");break;case"2":e.preventDefault(),this.loadPage("about");break;case"3":e.preventDefault(),this.loadPage("chess");break;case"4":e.preventDefault(),this.loadPage("github");break}})}loadPage(t){document.querySelectorAll(".page").forEach(i=>{i.id===`page-${t}`?i.classList.add("active"):i.classList.remove("active")}),this.currentPage=t,this.updateNavigation(t),window.scrollTo(0,0);const s=t==="home"?"/":`/#${t}`;history.pushState({page:t},"",s),document.title="asgobbi / "+t,t==="chess"&&ii.reset()}updateNavigation(t){document.querySelectorAll(".nav-link").forEach(e=>{e.getAttribute("data-page")===t?e.classList.add("active"):e.classList.remove("active")})}setupExternalLinks(){const t='a[href^="http"]:not([href*="'+window.location.host+'"]),a[target="_blank"]';document.querySelectorAll(t).forEach(s=>{s.setAttribute("target","_blank"),s.setAttribute("rel","noopener noreferrer")})}setupPopState(){window.addEventListener("popstate",t=>{t.state&&t.state.page?this.loadPage(t.state.page):this.loadPage("home")})}}window.terminalSite=new ri;document.addEventListener("keydown",h=>{if(h.key==="Tab"&&h.target===document.body){const t=document.querySelector(".nav-link");t&&(h.preventDefault(),t.focus())}});
