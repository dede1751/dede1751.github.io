(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const n of r.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&s(n)}).observe(document,{childList:!0,subtree:!0});function t(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(i){if(i.ep)return;i.ep=!0;const r=t(i);fetch(i.href,r)}})();var $e=(h=>(h[h.WDL=0]="WDL",h[h.CP=1]="CP",h))($e||{});class dt{scoreType;container;whiteDiv;greyDiv;blackDiv;scoreDivWhite;scoreDivGrey;scoreDivBlack;minRoomPercent=5;constructor(e,t){this.scoreType=t,this.container=document.getElementById(e),this.container.innerHTML=`
      <div class="eval-bar-outer" style="height: 100%;">
        <div class="eval-bar-black">
          <div class="eval-bar-score black" style="display:none"></div>
        </div>
        <div class="eval-bar-grey">
          <div class="eval-bar-score grey" style="display:none"></div>
        </div>
        <div class="eval-bar-white">
          <div class="eval-bar-score white" style="display:none"></div>
        </div>
      </div>
    `,this.whiteDiv=this.container.querySelector(".eval-bar-white"),this.greyDiv=this.container.querySelector(".eval-bar-grey"),this.blackDiv=this.container.querySelector(".eval-bar-black"),this.scoreDivWhite=this.container.querySelector(".eval-bar-score.white"),this.scoreDivGrey=this.container.querySelector(".eval-bar-score.grey"),this.scoreDivBlack=this.container.querySelector(".eval-bar-score.black")}reset(){this.scoreType===1?(this.whiteDiv.style.height="50%",this.greyDiv.style.display="none",this.blackDiv.style.height="50%"):(this.whiteDiv.style.height="33%",this.greyDiv.style.height="34%",this.blackDiv.style.height="33%"),this.scoreDivWhite.style.display="none",this.scoreDivGrey.style.display="none",this.scoreDivBlack.style.display="none"}setHeight(e){this.container.style.height=e}updateEvaluation(e,t,s=!1){function i(r,n){let a=r,c={val:n.val,w:n.l,d:n.d,l:n.w};return a==="Mate"?a="Mated":a==="Mated"?a="Mate":c.val=-c.val,[a,c]}s&&([e,t]=i(e,t)),this.scoreType===1?this.updateEvalCP(e,t):this.updateEvalWDL(t)}updateEvalCP(e,t){var s=.5,i="",r=!0,n=!1;if(e==="Cp"){let a=function(b){return b===0?0:b<7?-(.322495*Math.pow(b,2))+7.26599*b+4.11834:8*b/145+40.55862068965517};const c=t.val/100,p=a(Math.abs(c)),g=Math.min(50-this.minRoomPercent,p);Math.abs(c)<.1?i="0.0":i=(c>0?"+":"")+c.toFixed(1),s=(50+(c>0?g:-g))/100,r=!0,n=!1}else e==="Mate"?(s=1,i=`M${t.val}`,r=!0,n=!1):e==="Mated"&&(s=0,i=`-M${t.val}`,r=!1,n=!0);this.whiteDiv.style.height=`${s*100}%`,this.blackDiv.style.height=`${(1-s)*100}%`,this.scoreDivWhite.style.display=r?"block":"none",this.scoreDivBlack.style.display=n?"block":"none",r&&(this.scoreDivWhite.textContent=i,this.scoreDivWhite.style.top="2px"),n&&(this.scoreDivBlack.textContent=i,this.scoreDivBlack.style.bottom="2px")}updateEvalWDL(e){const[t,s,i]=[e.w/10,e.d/10,e.l/10];this.whiteDiv.style.height=`${t}%`,this.greyDiv.style.height=`${s}%`,this.blackDiv.style.height=`${i}%`;const r=t>this.minRoomPercent,n=s>this.minRoomPercent,a=i>this.minRoomPercent;if(this.scoreDivWhite.style.display=r?"block":"none",this.scoreDivGrey.style.display=n?"block":"none",this.scoreDivBlack.style.display=a?"block":"none",r){const c=t===100?"100":t.toFixed(1);this.scoreDivWhite.textContent=`${c}%`}if(n){const c=s===100?"100":s.toFixed(1);this.scoreDivGrey.textContent=`${c}%`}if(a){const c=i===100?"100":i.toFixed(1);this.scoreDivBlack.textContent=`${c}%`}}}const pt=new URL("/assets/carp_wasm_bg-DIWw2oFb.wasm",import.meta.url).toString(),Ps=WebAssembly.compileStreaming?WebAssembly.compileStreaming(fetch(pt)):fetch(pt).then(h=>h.arrayBuffer()).then(WebAssembly.compile);function Is(h){return h!==null?{comment:h,variations:[]}:{variations:[]}}function qs(h,e,t,s,i){const r={move:h,variations:i};return e&&(r.suffix=e),t&&(r.nag=t),s!==null&&(r.comment=s),r}function Ts(...h){const[e,...t]=h;let s=e;for(const i of t)i!==null&&(s.variations=[i,...i.variations],i.variations=[],s=i);return e}function Ms(h,e){if(e.marker&&e.marker.comment){let t=e.root;for(;;){const s=t.variations[0];if(!s){t.comment=e.marker.comment;break}t=s}}return{headers:h,root:e.root,result:(e.marker&&e.marker.result)??void 0}}function xs(h,e){function t(){this.constructor=h}t.prototype=e.prototype,h.prototype=new t}function ne(h,e,t,s){var i=Error.call(this,h);return Object.setPrototypeOf&&Object.setPrototypeOf(i,ne.prototype),i.expected=e,i.found=t,i.location=s,i.name="SyntaxError",i}xs(ne,Error);function Ie(h,e,t){return t=t||" ",h.length>e?h:(e-=h.length,t+=t.repeat(e),h+t.slice(0,e))}ne.prototype.format=function(h){var e="Error: "+this.message;if(this.location){var t=null,s;for(s=0;s<h.length;s++)if(h[s].source===this.location.source){t=h[s].text.split(/\r\n|\n|\r/g);break}var i=this.location.start,r=this.location.source&&typeof this.location.source.offset=="function"?this.location.source.offset(i):i,n=this.location.source+":"+r.line+":"+r.column;if(t){var a=this.location.end,c=Ie("",r.line.toString().length," "),p=t[i.line-1],g=i.line===a.line?a.column:p.length+1,b=g-i.column||1;e+=`
 --> `+n+`
`+c+` |
`+r.line+" | "+p+`
`+c+" | "+Ie("",i.column-1," ")+Ie("",b,"^")}else e+=`
 at `+n}return e};ne.buildMessage=function(h,e){var t={literal:function(p){return'"'+i(p.text)+'"'},class:function(p){var g=p.parts.map(function(b){return Array.isArray(b)?r(b[0])+"-"+r(b[1]):r(b)});return"["+(p.inverted?"^":"")+g.join("")+"]"},any:function(){return"any character"},end:function(){return"end of input"},other:function(p){return p.description}};function s(p){return p.charCodeAt(0).toString(16).toUpperCase()}function i(p){return p.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(g){return"\\x0"+s(g)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(g){return"\\x"+s(g)})}function r(p){return p.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(g){return"\\x0"+s(g)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(g){return"\\x"+s(g)})}function n(p){return t[p.type](p)}function a(p){var g=p.map(n),b,v;if(g.sort(),g.length>0){for(b=1,v=1;b<g.length;b++)g[b-1]!==g[b]&&(g[v]=g[b],v++);g.length=v}switch(g.length){case 1:return g[0];case 2:return g[0]+" or "+g[1];default:return g.slice(0,-1).join(", ")+", or "+g[g.length-1]}}function c(p){return p?'"'+i(p)+'"':"end of input"}return"Expected "+a(h)+" but "+c(e)+" found."};function As(h,e){e=e!==void 0?e:{};var t={},s=e.grammarSource,i={pgn:at},r=at,n="[",a='"',c="]",p=".",g="O-O-O",b="O-O",v="0-0-0",_="0-0",P="$",q="{",z="}",_e=";",Se="(",Et=")",Fe="1-0",Ge="0-1",Ue="1/2-1/2",Ct="*",Ee=/^[a-zA-Z]/,Ke=/^[^"]/,ue=/^[0-9]/,He=/^[.]/,We=/^[a-zA-Z1-8\-=]/,Pt=/^[+#]/,ze=/^[!?]/,Ve=/^[^}]/,je=/^[^\r\n]/,Ye=/^[ \t\r\n]/,It=G("tag pair"),qt=L("[",!1),Qe=L('"',!1),Tt=L("]",!1),Mt=G("tag name"),Ce=H([["a","z"],["A","Z"]],!1,!1),xt=G("tag value"),Xe=H(['"'],!0,!1),At=G("move number"),de=H([["0","9"]],!1,!1),Lt=L(".",!1),Ze=H(["."],!1,!1),Dt=G("standard algebraic notation"),Ot=L("O-O-O",!1),$t=L("O-O",!1),Nt=L("0-0-0",!1),Bt=L("0-0",!1),Je=H([["a","z"],["A","Z"],["1","8"],"-","="],!1,!1),Rt=H(["+","#"],!1,!1),Ft=G("suffix annotation"),et=H(["!","?"],!1,!1),Gt=G("NAG"),Ut=L("$",!1),Kt=G("brace comment"),Ht=L("{",!1),tt=H(["}"],!0,!1),Wt=L("}",!1),zt=G("rest of line comment"),Vt=L(";",!1),st=H(["\r",`
`],!0,!1),jt=G("variation"),Yt=L("(",!1),Qt=L(")",!1),Xt=G("game termination marker"),Zt=L("1-0",!1),Jt=L("0-1",!1),es=L("1/2-1/2",!1),ts=L("*",!1),ss=G("whitespace"),it=H([" ","	","\r",`
`],!1,!1),is=function(o,u){return Ms(o,u)},rs=function(o){return Object.fromEntries(o)},ns=function(o,u){return[o,u]},as=function(o,u){return{root:o,marker:u}},os=function(o,u){return Ts(Is(o),...u.flat())},hs=function(o,u,d,w,k){return qs(o,u,d,w,k)},ls=function(o){return o},cs=function(o){return o.replace(/[\r\n]+/g," ")},us=function(o){return o.trim()},ds=function(o){return o},ps=function(o,u){return{result:o,comment:u}},l=e.peg$currPos|0,se=[{line:1,column:1}],K=l,pe=e.peg$maxFailExpected||[],f=e.peg$silentFails|0,ae;if(e.startRule){if(!(e.startRule in i))throw new Error(`Can't start parsing from rule "`+e.startRule+'".');r=i[e.startRule]}function L(o,u){return{type:"literal",text:o,ignoreCase:u}}function H(o,u,d){return{type:"class",parts:o,inverted:u,ignoreCase:d}}function fs(){return{type:"end"}}function G(o){return{type:"other",description:o}}function rt(o){var u=se[o],d;if(u)return u;if(o>=se.length)d=se.length-1;else for(d=o;!se[--d];);for(u=se[d],u={line:u.line,column:u.column};d<o;)h.charCodeAt(d)===10?(u.line++,u.column=1):u.column++,d++;return se[o]=u,u}function nt(o,u,d){var w=rt(o),k=rt(u),I={source:s,start:{offset:o,line:w.line,column:w.column},end:{offset:u,line:k.line,column:k.column}};return I}function y(o){l<K||(l>K&&(K=l,pe=[]),pe.push(o))}function gs(o,u,d){return new ne(ne.buildMessage(o,u),o,u,d)}function at(){var o,u,d;return o=l,u=vs(),d=ys(),o=is(u,d),o}function vs(){var o,u,d;for(o=l,u=[],d=ot();d!==t;)u.push(d),d=ot();return d=N(),o=rs(u),o}function ot(){var o,u,d,w,k,I,J;return f++,o=l,N(),h.charCodeAt(l)===91?(u=n,l++):(u=t,f===0&&y(qt)),u!==t?(N(),d=ms(),d!==t?(N(),h.charCodeAt(l)===34?(w=a,l++):(w=t,f===0&&y(Qe)),w!==t?(k=bs(),h.charCodeAt(l)===34?(I=a,l++):(I=t,f===0&&y(Qe)),I!==t?(N(),h.charCodeAt(l)===93?(J=c,l++):(J=t,f===0&&y(Tt)),J!==t?o=ns(d,k):(l=o,o=t)):(l=o,o=t)):(l=o,o=t)):(l=o,o=t)):(l=o,o=t),f--,o===t&&f===0&&y(It),o}function ms(){var o,u,d;if(f++,o=l,u=[],d=h.charAt(l),Ee.test(d)?l++:(d=t,f===0&&y(Ce)),d!==t)for(;d!==t;)u.push(d),d=h.charAt(l),Ee.test(d)?l++:(d=t,f===0&&y(Ce));else u=t;return u!==t?o=h.substring(o,l):o=u,f--,o===t&&(u=t,f===0&&y(Mt)),o}function bs(){var o,u,d;for(f++,o=l,u=[],d=h.charAt(l),Ke.test(d)?l++:(d=t,f===0&&y(Xe));d!==t;)u.push(d),d=h.charAt(l),Ke.test(d)?l++:(d=t,f===0&&y(Xe));return o=h.substring(o,l),f--,u=t,f===0&&y(xt),o}function ys(){var o,u,d;return o=l,u=ht(),N(),d=Cs(),d===t&&(d=null),N(),o=as(u,d),o}function ht(){var o,u,d,w;for(o=l,u=Pe(),u===t&&(u=null),d=[],w=lt();w!==t;)d.push(w),w=lt();return o=os(u,d),o}function lt(){var o,u,d,w,k,I,J,fe;if(o=l,N(),ws(),N(),u=ks(),u!==t){for(d=_s(),d===t&&(d=null),w=[],k=ct();k!==t;)w.push(k),k=ct();for(k=N(),I=Pe(),I===t&&(I=null),J=[],fe=ut();fe!==t;)J.push(fe),fe=ut();o=hs(u,d,w,I,J)}else l=o,o=t;return o}function ws(){var o,u,d,w,k,I;for(f++,o=l,u=[],d=h.charAt(l),ue.test(d)?l++:(d=t,f===0&&y(de));d!==t;)u.push(d),d=h.charAt(l),ue.test(d)?l++:(d=t,f===0&&y(de));if(h.charCodeAt(l)===46?(d=p,l++):(d=t,f===0&&y(Lt)),d!==t){for(w=N(),k=[],I=h.charAt(l),He.test(I)?l++:(I=t,f===0&&y(Ze));I!==t;)k.push(I),I=h.charAt(l),He.test(I)?l++:(I=t,f===0&&y(Ze));u=[u,d,w,k],o=u}else l=o,o=t;return f--,o===t&&(u=t,f===0&&y(At)),o}function ks(){var o,u,d,w,k,I;if(f++,o=l,u=l,h.substr(l,5)===g?(d=g,l+=5):(d=t,f===0&&y(Ot)),d===t&&(h.substr(l,3)===b?(d=b,l+=3):(d=t,f===0&&y($t)),d===t&&(h.substr(l,5)===v?(d=v,l+=5):(d=t,f===0&&y(Nt)),d===t&&(h.substr(l,3)===_?(d=_,l+=3):(d=t,f===0&&y(Bt)),d===t))))if(d=l,w=h.charAt(l),Ee.test(w)?l++:(w=t,f===0&&y(Ce)),w!==t){if(k=[],I=h.charAt(l),We.test(I)?l++:(I=t,f===0&&y(Je)),I!==t)for(;I!==t;)k.push(I),I=h.charAt(l),We.test(I)?l++:(I=t,f===0&&y(Je));else k=t;k!==t?(w=[w,k],d=w):(l=d,d=t)}else l=d,d=t;return d!==t?(w=h.charAt(l),Pt.test(w)?l++:(w=t,f===0&&y(Rt)),w===t&&(w=null),d=[d,w],u=d):(l=u,u=t),u!==t?o=h.substring(o,l):o=u,f--,o===t&&(u=t,f===0&&y(Dt)),o}function _s(){var o,u,d;for(f++,o=l,u=[],d=h.charAt(l),ze.test(d)?l++:(d=t,f===0&&y(et));d!==t;)u.push(d),u.length>=2?d=t:(d=h.charAt(l),ze.test(d)?l++:(d=t,f===0&&y(et)));return u.length<1?(l=o,o=t):o=u,f--,o===t&&(u=t,f===0&&y(Ft)),o}function ct(){var o,u,d,w,k;if(f++,o=l,N(),h.charCodeAt(l)===36?(u=P,l++):(u=t,f===0&&y(Ut)),u!==t){if(d=l,w=[],k=h.charAt(l),ue.test(k)?l++:(k=t,f===0&&y(de)),k!==t)for(;k!==t;)w.push(k),k=h.charAt(l),ue.test(k)?l++:(k=t,f===0&&y(de));else w=t;w!==t?d=h.substring(d,l):d=w,d!==t?o=ls(d):(l=o,o=t)}else l=o,o=t;return f--,o===t&&f===0&&y(Gt),o}function Pe(){var o;return o=Ss(),o===t&&(o=Es()),o}function Ss(){var o,u,d,w,k;if(f++,o=l,h.charCodeAt(l)===123?(u=q,l++):(u=t,f===0&&y(Ht)),u!==t){for(d=l,w=[],k=h.charAt(l),Ve.test(k)?l++:(k=t,f===0&&y(tt));k!==t;)w.push(k),k=h.charAt(l),Ve.test(k)?l++:(k=t,f===0&&y(tt));d=h.substring(d,l),h.charCodeAt(l)===125?(w=z,l++):(w=t,f===0&&y(Wt)),w!==t?o=cs(d):(l=o,o=t)}else l=o,o=t;return f--,o===t&&(u=t,f===0&&y(Kt)),o}function Es(){var o,u,d,w,k;if(f++,o=l,h.charCodeAt(l)===59?(u=_e,l++):(u=t,f===0&&y(Vt)),u!==t){for(d=l,w=[],k=h.charAt(l),je.test(k)?l++:(k=t,f===0&&y(st));k!==t;)w.push(k),k=h.charAt(l),je.test(k)?l++:(k=t,f===0&&y(st));d=h.substring(d,l),o=us(d)}else l=o,o=t;return f--,o===t&&(u=t,f===0&&y(zt)),o}function ut(){var o,u,d,w;return f++,o=l,N(),h.charCodeAt(l)===40?(u=Se,l++):(u=t,f===0&&y(Yt)),u!==t?(d=ht(),d!==t?(N(),h.charCodeAt(l)===41?(w=Et,l++):(w=t,f===0&&y(Qt)),w!==t?o=ds(d):(l=o,o=t)):(l=o,o=t)):(l=o,o=t),f--,o===t&&f===0&&y(jt),o}function Cs(){var o,u,d;return f++,o=l,h.substr(l,3)===Fe?(u=Fe,l+=3):(u=t,f===0&&y(Zt)),u===t&&(h.substr(l,3)===Ge?(u=Ge,l+=3):(u=t,f===0&&y(Jt)),u===t&&(h.substr(l,7)===Ue?(u=Ue,l+=7):(u=t,f===0&&y(es)),u===t&&(h.charCodeAt(l)===42?(u=Ct,l++):(u=t,f===0&&y(ts))))),u!==t?(N(),d=Pe(),d===t&&(d=null),o=ps(u,d)):(l=o,o=t),f--,o===t&&(u=t,f===0&&y(Xt)),o}function N(){var o,u;for(f++,o=[],u=h.charAt(l),Ye.test(u)?l++:(u=t,f===0&&y(it));u!==t;)o.push(u),u=h.charAt(l),Ye.test(u)?l++:(u=t,f===0&&y(it));return f--,u=t,f===0&&y(ss),o}if(ae=r(),e.peg$library)return{peg$result:ae,peg$currPos:l,peg$FAILED:t,peg$maxFailExpected:pe,peg$maxFailPos:K};if(ae!==t&&l===h.length)return ae;throw ae!==t&&l<h.length&&y(fs()),gs(pe,K<h.length?h.charAt(K):null,K<h.length?nt(K,K+1):nt(K,K))}/**
 * @license
 * Copyright (c) 2025, Jeff Hlywa (jhlywa@gmail.com)
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are met:
 *
 * 1. Redistributions of source code must retain the above copyright notice,
 *    this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright notice,
 *    this list of conditions and the following disclaimer in the documentation
 *    and/or other materials provided with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
 * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE
 * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
 * POSSIBILITY OF SUCH DAMAGE.
 */const be=0xffffffffffffffffn;function qe(h,e){return(h<<e|h>>64n-e)&0xffffffffffffffffn}function ft(h,e){return h*e&be}function Ls(h){return function(){let e=BigInt(h&be),t=BigInt(h>>64n&be);const s=ft(qe(ft(e,5n),7n),9n);return t^=e,e=(qe(e,24n)^t^t<<16n)&be,t=qe(t,37n),h=t<<64n|e,s}}const ke=Ls(0xa187eb39cdcaed8f31c4b365b102e01en),Ds=Array.from({length:2},()=>Array.from({length:6},()=>Array.from({length:128},()=>ke()))),Os=Array.from({length:8},()=>ke()),$s=Array.from({length:16},()=>ke()),Te=ke(),$="w",B="b",x="p",Ne="n",ye="b",le="r",X="q",A="k",Me="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1";class ge{color;from;to;piece;captured;promotion;flags;san;lan;before;after;constructor(e,t){const{color:s,piece:i,from:r,to:n,flags:a,captured:c,promotion:p}=t,g=D(r),b=D(n);this.color=s,this.piece=i,this.from=g,this.to=b,this.san=e._moveToSan(t,e._moves({legal:!0})),this.lan=g+b,this.before=e.fen(),e._makeMove(t),this.after=e.fen(),e._undoMove(),this.flags="";for(const v in E)E[v]&a&&(this.flags+=ee[v]);c&&(this.captured=c),p&&(this.promotion=p,this.lan+=p)}isCapture(){return this.flags.indexOf(ee.CAPTURE)>-1}isPromotion(){return this.flags.indexOf(ee.PROMOTION)>-1}isEnPassant(){return this.flags.indexOf(ee.EP_CAPTURE)>-1}isKingsideCastle(){return this.flags.indexOf(ee.KSIDE_CASTLE)>-1}isQueensideCastle(){return this.flags.indexOf(ee.QSIDE_CASTLE)>-1}isBigPawn(){return this.flags.indexOf(ee.BIG_PAWN)>-1}}const O=-1,ee={NORMAL:"n",CAPTURE:"c",BIG_PAWN:"b",EP_CAPTURE:"e",PROMOTION:"p",KSIDE_CASTLE:"k",QSIDE_CASTLE:"q",NULL_MOVE:"-"},E={NORMAL:1,CAPTURE:2,BIG_PAWN:4,EP_CAPTURE:8,PROMOTION:16,KSIDE_CASTLE:32,QSIDE_CASTLE:64,NULL_MOVE:128},Be={Event:"?",Site:"?",Date:"????.??.??",Round:"?",White:"?",Black:"?",Result:"*"},Ns={WhiteTitle:null,BlackTitle:null,WhiteElo:null,BlackElo:null,WhiteUSCF:null,BlackUSCF:null,WhiteNA:null,BlackNA:null,WhiteType:null,BlackType:null,EventDate:null,EventSponsor:null,Section:null,Stage:null,Board:null,Opening:null,Variation:null,SubVariation:null,ECO:null,NIC:null,Time:null,UTCTime:null,UTCDate:null,TimeControl:null,SetUp:null,FEN:null,Termination:null,Annotator:null,Mode:null,PlyCount:null},Bs={...Be,...Ns},S={a8:0,b8:1,c8:2,d8:3,e8:4,f8:5,g8:6,h8:7,a7:16,b7:17,c7:18,d7:19,e7:20,f7:21,g7:22,h7:23,a6:32,b6:33,c6:34,d6:35,e6:36,f6:37,g6:38,h6:39,a5:48,b5:49,c5:50,d5:51,e5:52,f5:53,g5:54,h5:55,a4:64,b4:65,c4:66,d4:67,e4:68,f4:69,g4:70,h4:71,a3:80,b3:81,c3:82,d3:83,e3:84,f3:85,g3:86,h3:87,a2:96,b2:97,c2:98,d2:99,e2:100,f2:101,g2:102,h2:103,a1:112,b1:113,c1:114,d1:115,e1:116,f1:117,g1:118,h1:119},xe={b:[16,32,17,15],w:[-16,-32,-17,-15]},gt={n:[-18,-33,-31,-14,18,33,31,14],b:[-17,-15,17,15],r:[-16,1,16,-1],q:[-17,-16,-15,1,17,16,15,-1],k:[-17,-16,-15,1,17,16,15,-1]},Rs=[20,0,0,0,0,0,0,24,0,0,0,0,0,0,20,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,24,24,24,24,24,24,56,0,56,24,24,24,24,24,24,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,20,0,0,0,0,0,0,24,0,0,0,0,0,0,20],Fs=[17,0,0,0,0,0,0,16,0,0,0,0,0,0,15,0,0,17,0,0,0,0,0,16,0,0,0,0,0,15,0,0,0,0,17,0,0,0,0,16,0,0,0,0,15,0,0,0,0,0,0,17,0,0,0,16,0,0,0,15,0,0,0,0,0,0,0,0,17,0,0,16,0,0,15,0,0,0,0,0,0,0,0,0,0,17,0,16,0,15,0,0,0,0,0,0,0,0,0,0,0,0,17,16,15,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,-15,-16,-17,0,0,0,0,0,0,0,0,0,0,0,0,-15,0,-16,0,-17,0,0,0,0,0,0,0,0,0,0,-15,0,0,-16,0,0,-17,0,0,0,0,0,0,0,0,-15,0,0,0,-16,0,0,0,-17,0,0,0,0,0,0,-15,0,0,0,0,-16,0,0,0,0,-17,0,0,0,0,-15,0,0,0,0,0,-16,0,0,0,0,0,-17,0,0,-15,0,0,0,0,0,0,-16,0,0,0,0,0,0,-17],Gs={p:1,n:2,b:4,r:8,q:16,k:32},Us="pnbrqkPNBRQK",vt=[Ne,ye,le,X],Ks=7,Hs=6,Ws=1,zs=0,ve={[A]:E.KSIDE_CASTLE,[X]:E.QSIDE_CASTLE},j={w:[{square:S.a1,flag:E.QSIDE_CASTLE},{square:S.h1,flag:E.KSIDE_CASTLE}],b:[{square:S.a8,flag:E.QSIDE_CASTLE},{square:S.h8,flag:E.KSIDE_CASTLE}]},Vs={b:Ws,w:Hs},Ae="--";function te(h){return h>>4}function ce(h){return h&15}function _t(h){return"0123456789".indexOf(h)!==-1}function D(h){const e=ce(h),t=te(h);return"abcdefgh".substring(e,e+1)+"87654321".substring(t,t+1)}function oe(h){return h===$?B:$}function St(h){const e=h.split(/\s+/);if(e.length!==6)return{ok:!1,error:"Invalid FEN: must contain six space-delimited fields"};const t=parseInt(e[5],10);if(isNaN(t)||t<=0)return{ok:!1,error:"Invalid FEN: move number must be a positive integer"};const s=parseInt(e[4],10);if(isNaN(s)||s<0)return{ok:!1,error:"Invalid FEN: half move counter number must be a non-negative integer"};if(!/^(-|[abcdefgh][36])$/.test(e[3]))return{ok:!1,error:"Invalid FEN: en-passant square is invalid"};if(/[^kKqQ-]/.test(e[2]))return{ok:!1,error:"Invalid FEN: castling availability is invalid"};if(!/^(w|b)$/.test(e[1]))return{ok:!1,error:"Invalid FEN: side-to-move is invalid"};const i=e[0].split("/");if(i.length!==8)return{ok:!1,error:"Invalid FEN: piece data does not contain 8 '/'-delimited rows"};for(let n=0;n<i.length;n++){let a=0,c=!1;for(let p=0;p<i[n].length;p++)if(_t(i[n][p])){if(c)return{ok:!1,error:"Invalid FEN: piece data is invalid (consecutive number)"};a+=parseInt(i[n][p],10),c=!0}else{if(!/^[prnbqkPRNBQK]$/.test(i[n][p]))return{ok:!1,error:"Invalid FEN: piece data is invalid (invalid piece)"};a+=1,c=!1}if(a!==8)return{ok:!1,error:"Invalid FEN: piece data is invalid (too many squares in rank)"}}if(e[3][1]=="3"&&e[1]=="w"||e[3][1]=="6"&&e[1]=="b")return{ok:!1,error:"Invalid FEN: illegal en-passant square"};const r=[{color:"white",regex:/K/g},{color:"black",regex:/k/g}];for(const{color:n,regex:a}of r){if(!a.test(e[0]))return{ok:!1,error:`Invalid FEN: missing ${n} king`};if((e[0].match(a)||[]).length>1)return{ok:!1,error:`Invalid FEN: too many ${n} kings`}}return Array.from(i[0]+i[7]).some(n=>n.toUpperCase()==="P")?{ok:!1,error:"Invalid FEN: some pawns are on the edge rows"}:{ok:!0}}function js(h,e){const t=h.from,s=h.to,i=h.piece;let r=0,n=0,a=0;for(let c=0,p=e.length;c<p;c++){const g=e[c].from,b=e[c].to,v=e[c].piece;i===v&&t!==g&&s===b&&(r++,te(t)===te(g)&&n++,ce(t)===ce(g)&&a++)}return r>0?n>0&&a>0?D(t):a>0?D(t).charAt(1):D(t).charAt(0):""}function Y(h,e,t,s,i,r=void 0,n=E.NORMAL){const a=te(s);if(i===x&&(a===Ks||a===zs))for(let c=0;c<vt.length;c++){const p=vt[c];h.push({color:e,from:t,to:s,piece:i,captured:r,promotion:p,flags:n|E.PROMOTION})}else h.push({color:e,from:t,to:s,piece:i,captured:r,flags:n})}function mt(h){let e=h.charAt(0);return e>="a"&&e<="h"?h.match(/[a-h]\d.*[a-h]\d/)?void 0:x:(e=e.toLowerCase(),e==="o"?A:e)}function Le(h){return h.replace(/=/,"").replace(/[+#]?[?!]*$/,"")}class bt{_board=new Array(128);_turn=$;_header={};_kings={w:O,b:O};_epSquare=-1;_halfMoves=0;_moveNumber=0;_history=[];_comments={};_castling={w:0,b:0};_hash=0n;_positionCount=new Map;constructor(e=Me,{skipValidation:t=!1}={}){this.load(e,{skipValidation:t})}clear({preserveHeaders:e=!1}={}){this._board=new Array(128),this._kings={w:O,b:O},this._turn=$,this._castling={w:0,b:0},this._epSquare=O,this._halfMoves=0,this._moveNumber=1,this._history=[],this._comments={},this._header=e?this._header:{...Bs},this._hash=this._computeHash(),this._positionCount=new Map,this._header.SetUp=null,this._header.FEN=null}load(e,{skipValidation:t=!1,preserveHeaders:s=!1}={}){let i=e.split(/\s+/);if(i.length>=2&&i.length<6){const a=["-","-","0","1"];e=i.concat(a.slice(-(6-i.length))).join(" ")}if(i=e.split(/\s+/),!t){const{ok:a,error:c}=St(e);if(!a)throw new Error(c)}const r=i[0];let n=0;this.clear({preserveHeaders:s});for(let a=0;a<r.length;a++){const c=r.charAt(a);if(c==="/")n+=8;else if(_t(c))n+=parseInt(c,10);else{const p=c<"a"?$:B;this._put({type:c.toLowerCase(),color:p},D(n)),n++}}this._turn=i[1],i[2].indexOf("K")>-1&&(this._castling.w|=E.KSIDE_CASTLE),i[2].indexOf("Q")>-1&&(this._castling.w|=E.QSIDE_CASTLE),i[2].indexOf("k")>-1&&(this._castling.b|=E.KSIDE_CASTLE),i[2].indexOf("q")>-1&&(this._castling.b|=E.QSIDE_CASTLE),this._epSquare=i[3]==="-"?O:S[i[3]],this._halfMoves=parseInt(i[4],10),this._moveNumber=parseInt(i[5],10),this._hash=this._computeHash(),this._updateSetup(e),this._incPositionCount()}fen({forceEnpassantSquare:e=!1}={}){let t=0,s="";for(let n=S.a8;n<=S.h1;n++){if(this._board[n]){t>0&&(s+=t,t=0);const{color:a,type:c}=this._board[n];s+=a===$?c.toUpperCase():c.toLowerCase()}else t++;n+1&136&&(t>0&&(s+=t),n!==S.h1&&(s+="/"),t=0,n+=8)}let i="";this._castling[$]&E.KSIDE_CASTLE&&(i+="K"),this._castling[$]&E.QSIDE_CASTLE&&(i+="Q"),this._castling[B]&E.KSIDE_CASTLE&&(i+="k"),this._castling[B]&E.QSIDE_CASTLE&&(i+="q"),i=i||"-";let r="-";if(this._epSquare!==O)if(e)r=D(this._epSquare);else{const n=this._epSquare+(this._turn===$?16:-16),a=[n+1,n-1];for(const c of a){if(c&136)continue;const p=this._turn;if(this._board[c]?.color===p&&this._board[c]?.type===x){this._makeMove({color:p,from:c,to:this._epSquare,piece:x,captured:x,flags:E.EP_CAPTURE});const g=!this._isKingAttacked(p);if(this._undoMove(),g){r=D(this._epSquare);break}}}}return[s,this._turn,i,r,this._halfMoves,this._moveNumber].join(" ")}_pieceKey(e){if(!this._board[e])return 0n;const{color:t,type:s}=this._board[e],i={w:0,b:1}[t],r={p:0,n:1,b:2,r:3,q:4,k:5}[s];return Ds[i][r][e]}_epKey(){return this._epSquare===O?0n:Os[this._epSquare&7]}_castlingKey(){const e=this._castling.w>>5|this._castling.b>>3;return $s[e]}_computeHash(){let e=0n;for(let t=S.a8;t<=S.h1;t++){if(t&136){t+=7;continue}this._board[t]&&(e^=this._pieceKey(t))}return e^=this._epKey(),e^=this._castlingKey(),this._turn==="b"&&(e^=Te),e}_updateSetup(e){this._history.length>0||(e!==Me?(this._header.SetUp="1",this._header.FEN=e):(this._header.SetUp=null,this._header.FEN=null))}reset(){this.load(Me)}get(e){return this._board[S[e]]}findPiece(e){const t=[];for(let s=S.a8;s<=S.h1;s++){if(s&136){s+=7;continue}!this._board[s]||this._board[s]?.color!==e.color||this._board[s].color===e.color&&this._board[s].type===e.type&&t.push(D(s))}return t}put({type:e,color:t},s){return this._put({type:e,color:t},s)?(this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),!0):!1}_set(e,t){this._hash^=this._pieceKey(e),this._board[e]=t,this._hash^=this._pieceKey(e)}_put({type:e,color:t},s){if(Us.indexOf(e.toLowerCase())===-1||!(s in S))return!1;const i=S[s];if(e==A&&!(this._kings[t]==O||this._kings[t]==i))return!1;const r=this._board[i];return r&&r.type===A&&(this._kings[r.color]=O),this._set(i,{type:e,color:t}),e===A&&(this._kings[t]=i),!0}_clear(e){this._hash^=this._pieceKey(e),delete this._board[e]}remove(e){const t=this.get(e);return this._clear(S[e]),t&&t.type===A&&(this._kings[t.color]=O),this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),t}_updateCastlingRights(){this._hash^=this._castlingKey();const e=this._board[S.e1]?.type===A&&this._board[S.e1]?.color===$,t=this._board[S.e8]?.type===A&&this._board[S.e8]?.color===B;(!e||this._board[S.a1]?.type!==le||this._board[S.a1]?.color!==$)&&(this._castling.w&=-65),(!e||this._board[S.h1]?.type!==le||this._board[S.h1]?.color!==$)&&(this._castling.w&=-33),(!t||this._board[S.a8]?.type!==le||this._board[S.a8]?.color!==B)&&(this._castling.b&=-65),(!t||this._board[S.h8]?.type!==le||this._board[S.h8]?.color!==B)&&(this._castling.b&=-33),this._hash^=this._castlingKey()}_updateEnPassantSquare(){if(this._epSquare===O)return;const e=this._epSquare+(this._turn===$?-16:16),t=this._epSquare+(this._turn===$?16:-16),s=[t+1,t-1];if(this._board[e]!==null||this._board[this._epSquare]!==null||this._board[t]?.color!==oe(this._turn)||this._board[t]?.type!==x){this._hash^=this._epKey(),this._epSquare=O;return}const i=r=>!(r&136)&&this._board[r]?.color===this._turn&&this._board[r]?.type===x;s.some(i)||(this._hash^=this._epKey(),this._epSquare=O)}_attacked(e,t,s){const i=[];for(let r=S.a8;r<=S.h1;r++){if(r&136){r+=7;continue}if(this._board[r]===void 0||this._board[r].color!==e)continue;const n=this._board[r],a=r-t;if(a===0)continue;const c=a+119;if(Rs[c]&Gs[n.type]){if(n.type===x){if(a>0&&n.color===$||a<=0&&n.color===B)if(s)i.push(D(r));else return!0;continue}if(n.type==="n"||n.type==="k")if(s){i.push(D(r));continue}else return!0;const p=Fs[c];let g=r+p,b=!1;for(;g!==t;){if(this._board[g]!=null){b=!0;break}g+=p}if(!b)if(s){i.push(D(r));continue}else return!0}}return s?i:!1}attackers(e,t){return t?this._attacked(t,S[e],!0):this._attacked(this._turn,S[e],!0)}_isKingAttacked(e){const t=this._kings[e];return t===-1?!1:this._attacked(oe(e),t)}hash(){return this._hash.toString(16)}isAttacked(e,t){return this._attacked(t,S[e])}isCheck(){return this._isKingAttacked(this._turn)}inCheck(){return this.isCheck()}isCheckmate(){return this.isCheck()&&this._moves().length===0}isStalemate(){return!this.isCheck()&&this._moves().length===0}isInsufficientMaterial(){const e={b:0,n:0,r:0,q:0,k:0,p:0},t=[];let s=0,i=0;for(let r=S.a8;r<=S.h1;r++){if(i=(i+1)%2,r&136){r+=7;continue}const n=this._board[r];n&&(e[n.type]=n.type in e?e[n.type]+1:1,n.type===ye&&t.push(i),s++)}if(s===2)return!0;if(s===3&&(e[ye]===1||e[Ne]===1))return!0;if(s===e[ye]+2){let r=0;const n=t.length;for(let a=0;a<n;a++)r+=t[a];if(r===0||r===n)return!0}return!1}isThreefoldRepetition(){return this._getPositionCount(this._hash)>=3}isDrawByFiftyMoves(){return this._halfMoves>=100}isDraw(){return this.isDrawByFiftyMoves()||this.isStalemate()||this.isInsufficientMaterial()||this.isThreefoldRepetition()}isGameOver(){return this.isCheckmate()||this.isDraw()}moves({verbose:e=!1,square:t=void 0,piece:s=void 0}={}){const i=this._moves({square:t,piece:s});return e?i.map(r=>new ge(this,r)):i.map(r=>this._moveToSan(r,i))}_moves({legal:e=!0,piece:t=void 0,square:s=void 0}={}){const i=s?s.toLowerCase():void 0,r=t?.toLowerCase(),n=[],a=this._turn,c=oe(a);let p=S.a8,g=S.h1,b=!1;if(i)if(i in S)p=g=S[i],b=!0;else return[];for(let _=p;_<=g;_++){if(_&136){_+=7;continue}if(!this._board[_]||this._board[_].color===c)continue;const{type:P}=this._board[_];let q;if(P===x){if(r&&r!==P)continue;q=_+xe[a][0],this._board[q]||(Y(n,a,_,q,x),q=_+xe[a][1],Vs[a]===te(_)&&!this._board[q]&&Y(n,a,_,q,x,void 0,E.BIG_PAWN));for(let z=2;z<4;z++)q=_+xe[a][z],!(q&136)&&(this._board[q]?.color===c?Y(n,a,_,q,x,this._board[q].type,E.CAPTURE):q===this._epSquare&&Y(n,a,_,q,x,x,E.EP_CAPTURE))}else{if(r&&r!==P)continue;for(let z=0,_e=gt[P].length;z<_e;z++){const Se=gt[P][z];for(q=_;q+=Se,!(q&136);){if(!this._board[q])Y(n,a,_,q,P);else{if(this._board[q].color===a)break;Y(n,a,_,q,P,this._board[q].type,E.CAPTURE);break}if(P===Ne||P===A)break}}}}if((r===void 0||r===A)&&(!b||g===this._kings[a])){if(this._castling[a]&E.KSIDE_CASTLE){const _=this._kings[a],P=_+2;!this._board[_+1]&&!this._board[P]&&!this._attacked(c,this._kings[a])&&!this._attacked(c,_+1)&&!this._attacked(c,P)&&Y(n,a,this._kings[a],P,A,void 0,E.KSIDE_CASTLE)}if(this._castling[a]&E.QSIDE_CASTLE){const _=this._kings[a],P=_-2;!this._board[_-1]&&!this._board[_-2]&&!this._board[_-3]&&!this._attacked(c,this._kings[a])&&!this._attacked(c,_-1)&&!this._attacked(c,P)&&Y(n,a,this._kings[a],P,A,void 0,E.QSIDE_CASTLE)}}if(!e||this._kings[a]===-1)return n;const v=[];for(let _=0,P=n.length;_<P;_++)this._makeMove(n[_]),this._isKingAttacked(a)||v.push(n[_]),this._undoMove();return v}move(e,{strict:t=!1}={}){let s=null;if(typeof e=="string")s=this._moveFromSan(e,t);else if(e===null)s=this._moveFromSan(Ae,t);else if(typeof e=="object"){const r=this._moves();for(let n=0,a=r.length;n<a;n++)if(e.from===D(r[n].from)&&e.to===D(r[n].to)&&(!("promotion"in r[n])||e.promotion===r[n].promotion)){s=r[n];break}}if(!s)throw typeof e=="string"?new Error(`Invalid move: ${e}`):new Error(`Invalid move: ${JSON.stringify(e)}`);if(this.isCheck()&&s.flags&E.NULL_MOVE)throw new Error("Null move not allowed when in check");const i=new ge(this,s);return this._makeMove(s),this._incPositionCount(),i}_push(e){this._history.push({move:e,kings:{b:this._kings.b,w:this._kings.w},turn:this._turn,castling:{b:this._castling.b,w:this._castling.w},epSquare:this._epSquare,halfMoves:this._halfMoves,moveNumber:this._moveNumber})}_movePiece(e,t){this._hash^=this._pieceKey(e),this._board[t]=this._board[e],delete this._board[e],this._hash^=this._pieceKey(t)}_makeMove(e){const t=this._turn,s=oe(t);if(this._push(e),e.flags&E.NULL_MOVE){t===B&&this._moveNumber++,this._halfMoves++,this._turn=s,this._epSquare=O;return}if(this._hash^=this._epKey(),this._hash^=this._castlingKey(),e.captured&&(this._hash^=this._pieceKey(e.to)),this._movePiece(e.from,e.to),e.flags&E.EP_CAPTURE&&(this._turn===B?this._clear(e.to-16):this._clear(e.to+16)),e.promotion&&(this._clear(e.to),this._set(e.to,{type:e.promotion,color:t})),this._board[e.to].type===A){if(this._kings[t]=e.to,e.flags&E.KSIDE_CASTLE){const i=e.to-1,r=e.to+1;this._movePiece(r,i)}else if(e.flags&E.QSIDE_CASTLE){const i=e.to+1,r=e.to-2;this._movePiece(r,i)}this._castling[t]=0}if(this._castling[t]){for(let i=0,r=j[t].length;i<r;i++)if(e.from===j[t][i].square&&this._castling[t]&j[t][i].flag){this._castling[t]^=j[t][i].flag;break}}if(this._castling[s]){for(let i=0,r=j[s].length;i<r;i++)if(e.to===j[s][i].square&&this._castling[s]&j[s][i].flag){this._castling[s]^=j[s][i].flag;break}}if(this._hash^=this._castlingKey(),e.flags&E.BIG_PAWN){let i;t===B?i=e.to-16:i=e.to+16,!(e.to-1&136)&&this._board[e.to-1]?.type===x&&this._board[e.to-1]?.color===s||!(e.to+1&136)&&this._board[e.to+1]?.type===x&&this._board[e.to+1]?.color===s?(this._epSquare=i,this._hash^=this._epKey()):this._epSquare=O}else this._epSquare=O;e.piece===x?this._halfMoves=0:e.flags&(E.CAPTURE|E.EP_CAPTURE)?this._halfMoves=0:this._halfMoves++,t===B&&this._moveNumber++,this._turn=s,this._hash^=Te}undo(){const e=this._hash,t=this._undoMove();if(t){const s=new ge(this,t);return this._decPositionCount(e),s}return null}_undoMove(){const e=this._history.pop();if(e===void 0)return null;this._hash^=this._epKey(),this._hash^=this._castlingKey();const t=e.move;this._kings=e.kings,this._turn=e.turn,this._castling=e.castling,this._epSquare=e.epSquare,this._halfMoves=e.halfMoves,this._moveNumber=e.moveNumber,this._hash^=this._epKey(),this._hash^=this._castlingKey(),this._hash^=Te;const s=this._turn,i=oe(s);if(t.flags&E.NULL_MOVE)return t;if(this._movePiece(t.to,t.from),t.piece&&(this._clear(t.from),this._set(t.from,{type:t.piece,color:s})),t.captured)if(t.flags&E.EP_CAPTURE){let r;s===B?r=t.to-16:r=t.to+16,this._set(r,{type:x,color:i})}else this._set(t.to,{type:t.captured,color:i});if(t.flags&(E.KSIDE_CASTLE|E.QSIDE_CASTLE)){let r,n;t.flags&E.KSIDE_CASTLE?(r=t.to+1,n=t.to-1):(r=t.to-2,n=t.to+1),this._movePiece(n,r)}return t}pgn({newline:e=`
`,maxWidth:t=0}={}){const s=[];let i=!1;for(const v in this._header)this._header[v]&&s.push(`[${v} "${this._header[v]}"]`+e),i=!0;i&&this._history.length&&s.push(e);const r=v=>{const _=this._comments[this.fen()];if(typeof _<"u"){const P=v.length>0?" ":"";v=`${v}${P}{${_}}`}return v},n=[];for(;this._history.length>0;)n.push(this._undoMove());const a=[];let c="";for(n.length===0&&a.push(r(""));n.length>0;){c=r(c);const v=n.pop();if(!v)break;if(!this._history.length&&v.color==="b"){const _=`${this._moveNumber}. ...`;c=c?`${c} ${_}`:_}else v.color==="w"&&(c.length&&a.push(c),c=this._moveNumber+".");c=c+" "+this._moveToSan(v,this._moves({legal:!0})),this._makeMove(v)}if(c.length&&a.push(r(c)),a.push(this._header.Result||"*"),t===0)return s.join("")+a.join(" ");const p=function(){return s.length>0&&s[s.length-1]===" "?(s.pop(),!0):!1},g=function(v,_){for(const P of _.split(" "))if(P){if(v+P.length>t){for(;p();)v--;s.push(e),v=0}s.push(P),v+=P.length,s.push(" "),v++}return p()&&v--,v};let b=0;for(let v=0;v<a.length;v++){if(b+a[v].length>t&&a[v].includes("{")){b=g(b,a[v]);continue}b+a[v].length>t&&v!==0?(s[s.length-1]===" "&&s.pop(),s.push(e),b=0):v!==0&&(s.push(" "),b++),s.push(a[v]),b+=a[v].length}return s.join("")}header(...e){for(let t=0;t<e.length;t+=2)typeof e[t]=="string"&&typeof e[t+1]=="string"&&(this._header[e[t]]=e[t+1]);return this._header}setHeader(e,t){return this._header[e]=t??Be[e]??null,this.getHeaders()}removeHeader(e){return e in this._header?(this._header[e]=Be[e]||null,!0):!1}getHeaders(){const e={};for(const[t,s]of Object.entries(this._header))s!==null&&(e[t]=s);return e}loadPgn(e,{strict:t=!1,newlineChar:s=`\r?
`}={}){s!==`\r?
`&&(e=e.replace(new RegExp(s,"g"),`
`));const i=As(e);this.reset();const r=i.headers;let n="";for(const p in r)p.toLowerCase()==="fen"&&(n=r[p]),this.header(p,r[p]);if(!t)n&&this.load(n,{preserveHeaders:!0});else if(r.SetUp==="1"){if(!("FEN"in r))throw new Error("Invalid PGN: FEN tag must be supplied with SetUp tag");this.load(r.FEN,{preserveHeaders:!0})}let a=i.root;for(;a;){if(a.move){const p=this._moveFromSan(a.move,t);if(p==null)throw new Error(`Invalid move in PGN: ${a.move}`);this._makeMove(p),this._incPositionCount()}a.comment!==void 0&&(this._comments[this.fen()]=a.comment),a=a.variations[0]}const c=i.result;c&&Object.keys(this._header).length&&this._header.Result!==c&&this.setHeader("Result",c)}_moveToSan(e,t){let s="";if(e.flags&E.KSIDE_CASTLE)s="O-O";else if(e.flags&E.QSIDE_CASTLE)s="O-O-O";else{if(e.flags&E.NULL_MOVE)return Ae;if(e.piece!==x){const i=js(e,t);s+=e.piece.toUpperCase()+i}e.flags&(E.CAPTURE|E.EP_CAPTURE)&&(e.piece===x&&(s+=D(e.from)[0]),s+="x"),s+=D(e.to),e.promotion&&(s+="="+e.promotion.toUpperCase())}return this._makeMove(e),this.isCheck()&&(this.isCheckmate()?s+="#":s+="+"),this._undoMove(),s}_moveFromSan(e,t=!1){let s=Le(e);if(t||(s==="0-0"?s="O-O":s==="0-0-0"&&(s="O-O-O")),s==Ae)return{color:this._turn,from:0,to:0,piece:"k",flags:E.NULL_MOVE};let i=mt(s),r=this._moves({legal:!0,piece:i});for(let v=0,_=r.length;v<_;v++)if(s===Le(this._moveToSan(r[v],r)))return r[v];if(t)return null;let n,a,c,p,g,b=!1;if(a=s.match(/([pnbrqkPNBRQK])?([a-h][1-8])x?-?([a-h][1-8])([qrbnQRBN])?/),a?(n=a[1],c=a[2],p=a[3],g=a[4],c.length==1&&(b=!0)):(a=s.match(/([pnbrqkPNBRQK])?([a-h]?[1-8]?)x?-?([a-h][1-8])([qrbnQRBN])?/),a&&(n=a[1],c=a[2],p=a[3],g=a[4],c.length==1&&(b=!0))),i=mt(s),r=this._moves({legal:!0,piece:n||i}),!p)return null;for(let v=0,_=r.length;v<_;v++)if(c){if((!n||n.toLowerCase()==r[v].piece)&&S[c]==r[v].from&&S[p]==r[v].to&&(!g||g.toLowerCase()==r[v].promotion))return r[v];if(b){const P=D(r[v].from);if((!n||n.toLowerCase()==r[v].piece)&&S[p]==r[v].to&&(c==P[0]||c==P[1])&&(!g||g.toLowerCase()==r[v].promotion))return r[v]}}else if(s===Le(this._moveToSan(r[v],r)).replace("x",""))return r[v];return null}ascii(){let e=`   +------------------------+
`;for(let t=S.a8;t<=S.h1;t++){if(ce(t)===0&&(e+=" "+"87654321"[te(t)]+" |"),this._board[t]){const s=this._board[t].type,r=this._board[t].color===$?s.toUpperCase():s.toLowerCase();e+=" "+r+" "}else e+=" . ";t+1&136&&(e+=`|
`,t+=8)}return e+=`   +------------------------+
`,e+="     a  b  c  d  e  f  g  h",e}perft(e){const t=this._moves({legal:!1});let s=0;const i=this._turn;for(let r=0,n=t.length;r<n;r++)this._makeMove(t[r]),this._isKingAttacked(i)||(e-1>0?s+=this.perft(e-1):s++),this._undoMove();return s}setTurn(e){return this._turn==e?!1:(this.move("--"),!0)}turn(){return this._turn}board(){const e=[];let t=[];for(let s=S.a8;s<=S.h1;s++)this._board[s]==null?t.push(null):t.push({square:D(s),type:this._board[s].type,color:this._board[s].color}),s+1&136&&(e.push(t),t=[],s+=8);return e}squareColor(e){if(e in S){const t=S[e];return(te(t)+ce(t))%2===0?"light":"dark"}return null}history({verbose:e=!1}={}){const t=[],s=[];for(;this._history.length>0;)t.push(this._undoMove());for(;;){const i=t.pop();if(!i)break;e?s.push(new ge(this,i)):s.push(this._moveToSan(i,this._moves())),this._makeMove(i)}return s}_getPositionCount(e){return this._positionCount.get(e)??0}_incPositionCount(){this._positionCount.set(this._hash,(this._positionCount.get(this._hash)??0)+1)}_decPositionCount(e){const t=this._positionCount.get(e)??0;t===1?this._positionCount.delete(e):this._positionCount.set(e,t-1)}_pruneComments(){const e=[],t={},s=i=>{i in this._comments&&(t[i]=this._comments[i])};for(;this._history.length>0;)e.push(this._undoMove());for(s(this.fen());;){const i=e.pop();if(!i)break;this._makeMove(i),s(this.fen())}this._comments=t}getComment(){return this._comments[this.fen()]}setComment(e){this._comments[this.fen()]=e.replace("{","[").replace("}","]")}deleteComment(){return this.removeComment()}removeComment(){const e=this._comments[this.fen()];return delete this._comments[this.fen()],e}getComments(){return this._pruneComments(),Object.keys(this._comments).map(e=>({fen:e,comment:this._comments[e]}))}deleteComments(){return this.removeComments()}removeComments(){return this._pruneComments(),Object.keys(this._comments).map(e=>{const t=this._comments[e];return delete this._comments[e],{fen:e,comment:t}})}setCastlingRights(e,t){for(const i of[A,X])t[i]!==void 0&&(t[i]?this._castling[e]|=ve[i]:this._castling[e]&=~ve[i]);this._updateCastlingRights();const s=this.getCastlingRights(e);return(t[A]===void 0||t[A]===s[A])&&(t[X]===void 0||t[X]===s[X])}getCastlingRights(e){return{[A]:(this._castling[e]&ve[A])!==0,[X]:(this._castling[e]&ve[X])!==0}}moveNumber(){return this._moveNumber}}const we={empty:"8/8/8/8/8/8/8/8"};class M{constructor(e=we.empty){this.squares=new Array(64).fill(null),this.setFen(e)}setFen(e=we.empty){const t=e.replace(/^\s*/,"").replace(/\s*$/,"").split(/\/|\s/);for(let s=0;s<8;s++){const i=t[7-s].replace(/\d/g,r=>{const n=parseInt(r);let a="";for(let c=0;c<n;c++)a+="-";return a});for(let r=0;r<8;r++){const n=i.substring(r,r+1);let a=null;n!=="-"&&(n.toUpperCase()===n?a=`w${n.toLowerCase()}`:a=`b${n}`),this.squares[s*8+r]=a}}}getFen(){let e=new Array(8).fill("");for(let t=0;t<8;t++){let s=0;for(let i=0;i<8;i++){const r=this.squares[t*8+i];if(!r)s++;else{s>0&&(e[7-t]+=s,s=0);const n=r.substring(0,1),a=r.substring(1,2);n==="w"?e[7-t]+=a.toUpperCase():e[7-t]+=a}}s>0&&(e[7-t]+=s,s=0)}return e.join("/")}getPieces(e=void 0,t=void 0,s=["k","q","r","b","n","p"]){const i=[],r=(n,a)=>s.indexOf(n.name)-s.indexOf(a.name);for(let n=0;n<64;n++){const a=this.squares[n];if(a){const c=a.charAt(1),p=a.charAt(0),g=M.indexToSquare(n);if(t&&t!==c||e&&e!==p)continue;i.push({name:c,type:c,color:p,position:g,square:g})}}return s&&i.sort(r),i}movePiece(e,t){if(!this.squares[M.squareToIndex(e)]){console.warn("no piece on",e);return}this.squares[M.squareToIndex(t)]=this.squares[M.squareToIndex(e)],this.squares[M.squareToIndex(e)]=null}setPiece(e,t){this.squares[M.squareToIndex(e)]=t}getPiece(e){return this.squares[M.squareToIndex(e)]}static squareToIndex(e){const t=M.squareToCoordinates(e);return t[0]+t[1]*8}static indexToSquare(e){return this.coordinatesToSquare([Math.floor(e%8),e/8])}static squareToCoordinates(e){const t=e.charCodeAt(0)-97,s=e.charCodeAt(1)-49;return[t,s]}static coordinatesToSquare(e){const t=String.fromCharCode(e[0]+97),s=String.fromCharCode(e[1]+49);return t+s}toString(){return this.getFen()}clone(){const e=new M;return e.squares=this.squares.slice(0),e}}class Ys{constructor(){this.position=new M,this.orientation=void 0,this.inputWhiteEnabled=!1,this.inputBlackEnabled=!1,this.squareSelectEnabled=!1,this.moveInputCallback=null,this.extensionPoints={},this.moveInputProcess=Promise.resolve()}inputEnabled(){return this.inputWhiteEnabled||this.inputBlackEnabled}invokeExtensionPoints(e,t={}){const s=this.extensionPoints[e],i=Object.assign({},t);i.extensionPoint=e;let r=!0;if(s)for(const n of s)n(i)===!1&&(r=!1);return r}}const yt="http://www.w3.org/2000/svg";class C{static createSvg(e=void 0){let t=document.createElementNS(yt,"svg");return e&&(t.setAttribute("width","100%"),t.setAttribute("height","100%"),e.appendChild(t)),t}static addElement(e,t,s={}){let i=document.createElementNS(yt,t);t==="use"&&(s["xlink:href"]=s.href);for(let r in s)if(s.hasOwnProperty(r))if(r.indexOf(":")!==-1){const n=r.split(":");i.setAttributeNS("http://www.w3.org/1999/"+n[0],n[1],s[r])}else i.setAttribute(r,s[r]);return e.appendChild(i),i}static removeElement(e){if(!e){console.warn("removeElement, element is",e);return}e.parentNode?e.parentNode.removeChild(e):console.warn(e,"without parentNode")}}const T={positionChanged:"positionChanged",boardChanged:"boardChanged",moveInputToggled:"moveInputToggled",moveInput:"moveInput",beforeRedrawBoard:"beforeRedrawBoard",afterRedrawBoard:"afterRedrawBoard",redrawBoard:"redrawBoard",animation:"animation",destroy:"destroy"};class Re{constructor(e){this.chessboard=e}registerExtensionPoint(e,t){e===T.redrawBoard&&(console.warn("EXTENSION_POINT.redrawBoard is deprecated, use EXTENSION_POINT.afterRedrawBoard"),e=T.afterRedrawBoard),this.chessboard.state.extensionPoints[e]||(this.chessboard.state.extensionPoints[e]=[]),this.chessboard.state.extensionPoints[e].push(t)}registerMethod(e,t){console.warn("registerMethod is deprecated, just add methods directly to the chessboard instance"),this.chessboard[e]?log.error("method",e,"already exists"):this.chessboard[e]=(...s)=>t.apply(this,s)}}class Z{static delegate(e,t,s,i){const r=function(n){let a=n.target;for(;a&&a!==this;)a.matches(s)&&i.call(a,n),a=a.parentNode};return e.addEventListener(t,r),{remove:function(){e.removeEventListener(t,r)}}}static mergeObjects(e,t){const s=i=>i&&typeof i=="object";if(!s(e)||!s(t))return t;for(const i of Object.keys(t))t[i]instanceof Object&&Object.assign(t[i],Z.mergeObjects(e[i],t[i]));return Object.assign(e||{},t),e}static createDomElement(e){const t=document.createElement("template");return t.innerHTML=e.trim(),t.content.firstChild}static createTask(){let e,t;const s=new Promise(function(i,r){e=i,t=r});return s.resolve=e,s.reject=t,s}static isAbsoluteUrl(e){return e.indexOf("://")!==-1||e.startsWith("/")}}const De={start:"start",frame:"frame",end:"end"};class Qs{constructor(){this.queue=[],this.workingOnPromise=!1,this.stop=!1}async enqueue(e){return new Promise((t,s)=>{this.queue.push({promise:e,resolve:t,reject:s}),this.dequeue()})}dequeue(){if(this.workingOnPromise)return;if(this.stop){this.queue=[],this.stop=!1;return}const e=this.queue.shift();if(e){try{this.workingOnPromise=!0,e.promise().then(t=>{this.workingOnPromise=!1,e.resolve(t),this.dequeue()}).catch(t=>{this.workingOnPromise=!1,e.reject(t),this.dequeue()})}catch(t){this.workingOnPromise=!1,e.reject(t),this.dequeue()}return!0}}destroy(){this.stop=!0}}const W={move:0,appear:1,disappear:2};class re{constructor(e,t,s,i,r){this.view=e,t&&s?(this.animatedElements=this.createAnimation(t.squares,s.squares),this.duration=i,this.callback=r,this.frameHandle=requestAnimationFrame(this.animationStep.bind(this))):console.error("fromPosition",t,"toPosition",s),this.view.positionsAnimationTask=Z.createTask(),this.view.chessboard.state.invokeExtensionPoints(T.animation,{type:De.start})}static seekChanges(e,t){const s=[],i=[],r=[];for(let n=0;n<64;n++){const a=e[n],c=t[n];c!==a&&(c&&s.push({piece:c,index:n}),a&&i.push({piece:a,index:n}))}return s.forEach(n=>{let a=8,c=null;i.forEach(p=>{if(n.piece===p.piece){const g=re.squareDistance(n.index,p.index);g<a&&(c=p,a=g)}}),c?(i.splice(i.indexOf(c),1),r.push({type:W.move,piece:n.piece,atIndex:c.index,toIndex:n.index})):r.push({type:W.appear,piece:n.piece,atIndex:n.index})}),i.forEach(n=>{r.push({type:W.disappear,piece:n.piece,atIndex:n.index})}),r}createAnimation(e,t){const s=re.seekChanges(e,t),i=[];return s.forEach(r=>{const n={type:r.type};switch(r.type){case W.move:n.element=this.view.getPieceElement(M.indexToSquare(r.atIndex)),n.element.parentNode.appendChild(n.element),n.atPoint=this.view.indexToPoint(r.atIndex),n.toPoint=this.view.indexToPoint(r.toIndex);break;case W.appear:n.element=this.view.drawPieceOnSquare(M.indexToSquare(r.atIndex),r.piece),n.element.style.opacity=0;break;case W.disappear:n.element=this.view.getPieceElement(M.indexToSquare(r.atIndex));break}i.push(n)}),i}animationStep(e){if(!this.view||!this.view.chessboard.state)return;this.startTime||(this.startTime=e);const t=e-this.startTime;if(t<=this.duration)this.frameHandle=requestAnimationFrame(this.animationStep.bind(this));else{cancelAnimationFrame(this.frameHandle),this.animatedElements.forEach(r=>{r.type===W.disappear&&C.removeElement(r.element)}),this.view.positionsAnimationTask.resolve(),this.view.chessboard.state.invokeExtensionPoints(T.animation,{type:De.end}),this.callback();return}const s=Math.min(1,t/this.duration);let i=s<.5?2*s*s:-1+(4-2*s)*s;(isNaN(i)||i>.99)&&(i=1),this.animatedElements.forEach(r=>{if(r.element)switch(r.type){case W.move:r.element.transform.baseVal.removeItem(0);const n=this.view.svg.createSVGTransform();n.setTranslate(r.atPoint.x+(r.toPoint.x-r.atPoint.x)*i,r.atPoint.y+(r.toPoint.y-r.atPoint.y)*i),r.element.transform.baseVal.appendItem(n);break;case W.appear:r.element.style.opacity=Math.round(i*100)/100;break;case W.disappear:r.element.style.opacity=Math.round((1-i)*100)/100;break}else console.warn("animatedItem has no element",r)}),this.view.chessboard.state.invokeExtensionPoints(T.animation,{type:De.frame,progress:i})}static squareDistance(e,t){const s=e%8,i=Math.floor(e/8),r=t%8,n=Math.floor(t/8);return Math.max(Math.abs(n-i),Math.abs(r-s))}}class Xs extends Qs{constructor(e){super(),this.chessboard=e}async enqueuePositionChange(e,t,s){return e.getFen()===t.getFen()?Promise.resolve():super.enqueue(()=>new Promise(i=>{let r=s?this.chessboard.props.style.animationDuration:0;this.queue.length>0&&(r=r/(1+Math.pow(this.queue.length/5,2))),new re(this.chessboard.view,e,t,s?r:0,()=>{this.chessboard.view&&this.chessboard.view.redrawPieces(t.squares),i()})}))}async enqueueTurnBoard(e,t,s){return super.enqueue(()=>new Promise(i=>{const r=new M(we.empty);let n=s?this.chessboard.props.style.animationDuration:0;this.queue.length>0&&(n=n/(1+Math.pow(this.queue.length/5,2))),new re(this.chessboard.view,e,r,s?n:0,()=>{this.chessboard.state.orientation=t,this.chessboard.view.redrawBoard(),this.chessboard.view.redrawPieces(r.squares),new re(this.chessboard.view,r,e,s?n:0,()=>{this.chessboard.view.redrawPieces(e.squares),i()})})}))}}const m={waitForInputStart:"waitForInputStart",pieceClickedThreshold:"pieceClickedThreshold",clickTo:"clickTo",secondClickThreshold:"secondClickThreshold",dragTo:"dragTo",clickDragTo:"clickDragTo",moveDone:"moveDone",reset:"reset"},he={secondClick:"secondClick",secondaryClick:"secondaryClick",movedOutOfBoard:"movedOutOfBoard",draggedBack:"draggedBack",clickedAnotherPiece:"clickedAnotherPiece"},wt=4;class Zs{constructor(e){this.view=e,this.chessboard=e.chessboard,this.moveInputState=null,this.fromSquare=null,this.toSquare=null,this.setMoveInputState(m.waitForInputStart)}moveInputStartedCallback(e){const t=this.view.moveInputStartedCallback(e);return t&&(this.chessboard.state.moveInputProcess=Z.createTask(),this.chessboard.state.moveInputProcess.then(s=>{(this.moveInputState===m.waitForInputStart||this.moveInputState===m.moveDone)&&this.view.moveInputFinishedCallback(this.fromSquare,this.toSquare,s)})),t}movingOverSquareCallback(e,t){this.view.movingOverSquareCallback(e,t)}validateMoveInputCallback(e,t){const s=this.view.validateMoveInputCallback(e,t);return this.chessboard.state.moveInputProcess.resolve(s),s}moveInputCanceledCallback(e,t,s){this.view.moveInputCanceledCallback(e,t,s),this.chessboard.state.moveInputProcess.resolve()}setMoveInputState(e,t=void 0){const s=this.moveInputState;switch(this.moveInputState=e,e){case m.waitForInputStart:break;case m.pieceClickedThreshold:if(m.waitForInputStart!==s&&m.clickTo!==s)throw new Error("moveInputState");if(this.pointerMoveListener&&(removeEventListener(this.pointerMoveListener.type,this.pointerMoveListener),this.pointerMoveListener=null),this.pointerUpListener&&(removeEventListener(this.pointerUpListener.type,this.pointerUpListener),this.pointerUpListener=null),this.fromSquare=t.square,this.toSquare=null,this.movedPiece=t.piece,this.startPoint=t.point,!this.pointerMoveListener&&!this.pointerUpListener){if(t.type==="mousedown")this.pointerMoveListener=this.onPointerMove.bind(this),this.pointerMoveListener.type="mousemove",addEventListener("mousemove",this.pointerMoveListener),this.pointerUpListener=this.onPointerUp.bind(this),this.pointerUpListener.type="mouseup",addEventListener("mouseup",this.pointerUpListener);else if(t.type==="touchstart")this.pointerMoveListener=this.onPointerMove.bind(this),this.pointerMoveListener.type="touchmove",addEventListener("touchmove",this.pointerMoveListener),this.pointerUpListener=this.onPointerUp.bind(this),this.pointerUpListener.type="touchend",addEventListener("touchend",this.pointerUpListener);else throw Error("4b74af");this.contextMenuListener||(this.contextMenuListener=this.onContextMenu.bind(this),this.chessboard.view.svg.addEventListener("contextmenu",this.contextMenuListener))}else throw Error("94ad0c");break;case m.clickTo:this.draggablePiece&&(C.removeElement(this.draggablePiece),this.draggablePiece=null),s===m.dragTo&&this.view.setPieceVisibility(t.square,!0);break;case m.secondClickThreshold:if(m.clickTo!==s)throw new Error("moveInputState");this.startPoint=t.point;break;case m.dragTo:if(m.pieceClickedThreshold!==s)throw new Error("moveInputState");this.view.chessboard.state.inputEnabled()&&(this.view.setPieceVisibility(t.square,!1),this.createDraggablePiece(t.piece));break;case m.clickDragTo:if(m.secondClickThreshold!==s)throw new Error("moveInputState");this.view.chessboard.state.inputEnabled()&&(this.view.setPieceVisibility(t.square,!1),this.createDraggablePiece(t.piece));break;case m.moveDone:if([m.dragTo,m.clickTo,m.clickDragTo].indexOf(s)===-1)throw new Error("moveInputState");this.toSquare=t.square,this.toSquare&&this.validateMoveInputCallback(this.fromSquare,this.toSquare)?this.chessboard.movePiece(this.fromSquare,this.toSquare,s===m.clickTo).then(()=>{s===m.clickTo&&this.view.setPieceVisibility(this.toSquare,!0),this.setMoveInputState(m.reset)}):(this.view.setPieceVisibility(this.fromSquare,!0),this.setMoveInputState(m.reset));break;case m.reset:this.fromSquare&&!this.toSquare&&this.movedPiece&&this.chessboard.state.position.setPiece(this.fromSquare,this.movedPiece),this.fromSquare=null,this.toSquare=null,this.movedPiece=null,this.draggablePiece&&(C.removeElement(this.draggablePiece),this.draggablePiece=null),this.pointerMoveListener&&(removeEventListener(this.pointerMoveListener.type,this.pointerMoveListener),this.pointerMoveListener=null),this.pointerUpListener&&(removeEventListener(this.pointerUpListener.type,this.pointerUpListener),this.pointerUpListener=null),this.contextMenuListener&&(removeEventListener("contextmenu",this.contextMenuListener),this.contextMenuListener=null),this.setMoveInputState(m.waitForInputStart);const i=this.view.piecesGroup.querySelectorAll("[visibility=hidden]");for(let r=0;r<i.length;r++)i[r].removeAttribute("visibility");break;default:throw Error(`260b09: moveInputState ${e}`)}}createDraggablePiece(e){if(this.draggablePiece)throw Error("draggablePiece already exists");this.draggablePiece=C.createSvg(document.body),this.draggablePiece.classList.add("cm-chessboard-draggable-piece"),this.draggablePiece.setAttribute("width",this.view.squareWidth),this.draggablePiece.setAttribute("height",this.view.squareHeight),this.draggablePiece.setAttribute("style","pointer-events: none"),this.draggablePiece.name=e;const t=this.chessboard.props.assetsCache?"":this.view.getSpriteUrl(),s=C.addElement(this.draggablePiece,"use",{href:`${t}#${e}`}),i=this.view.squareHeight/this.chessboard.props.style.pieces.tileSize,r=this.draggablePiece.createSVGTransform();r.setScale(i,i),s.transform.baseVal.appendItem(r)}moveDraggablePiece(e,t){this.draggablePiece.setAttribute("style",`pointer-events: none; position: absolute; left: ${e-this.view.squareHeight/2}px; top: ${t-this.view.squareHeight/2}px`)}onPointerDown(e){if(!(e.type==="mousedown"&&e.button===0||e.type==="touchstart"))return;const t=e.target.getAttribute("data-square");if(!t)return;const s=this.chessboard.getPiece(t);let i;if(s&&(i=s?s.substring(0,1):null,(i==="w"&&this.chessboard.state.inputWhiteEnabled||i==="b"&&this.chessboard.state.inputBlackEnabled)&&e.preventDefault()),this.moveInputState!==m.waitForInputStart||this.chessboard.state.inputWhiteEnabled&&i==="w"||this.chessboard.state.inputBlackEnabled&&i==="b"){let r;if(e.type==="mousedown"?r={x:e.clientX,y:e.clientY}:e.type==="touchstart"&&(r={x:e.touches[0].clientX,y:e.touches[0].clientY}),this.moveInputState===m.waitForInputStart&&s&&this.moveInputStartedCallback(t))this.setMoveInputState(m.pieceClickedThreshold,{square:t,piece:s,point:r,type:e.type});else if(this.moveInputState===m.clickTo)if(t===this.fromSquare)this.setMoveInputState(m.secondClickThreshold,{square:t,piece:s,point:r,type:e.type});else{const n=this.chessboard.getPiece(t),a=n?n.substring(0,1):null,c=this.chessboard.getPiece(this.fromSquare),p=c?c.substring(0,1):null;i&&p===a?(this.moveInputCanceledCallback(this.fromSquare,t,he.clickedAnotherPiece),this.moveInputStartedCallback(t)?this.setMoveInputState(m.pieceClickedThreshold,{square:t,piece:n,point:r,type:e.type}):this.setMoveInputState(m.reset)):this.setMoveInputState(m.moveDone,{square:t})}}}onPointerMove(e){let t,s,i,r,n;if(e.type==="mousemove"?(i=e.clientX,r=e.clientY,t=e.pageX,s=e.pageY,n=e.target):e.type==="touchmove"&&(i=e.touches[0].clientX,r=e.touches[0].clientY,t=e.touches[0].pageX,s=e.touches[0].pageY,n=document.elementFromPoint(i,r)),this.moveInputState===m.pieceClickedThreshold||this.moveInputState===m.secondClickThreshold)(Math.abs(this.startPoint.x-i)>wt||Math.abs(this.startPoint.y-r)>wt)&&(this.moveInputState===m.secondClickThreshold?this.setMoveInputState(m.clickDragTo,{square:this.fromSquare,piece:this.movedPiece}):this.setMoveInputState(m.dragTo,{square:this.fromSquare,piece:this.movedPiece}),this.view.chessboard.state.inputEnabled()&&this.moveDraggablePiece(t,s));else if(this.moveInputState===m.dragTo||this.moveInputState===m.clickDragTo||this.moveInputState===m.clickTo){if(n&&n.getAttribute&&n.parentElement===this.view.boardGroup){const a=n.getAttribute("data-square");a!==this.fromSquare&&a!==this.toSquare?(this.toSquare=a,this.movingOverSquareCallback(this.fromSquare,this.toSquare)):a===this.fromSquare&&this.toSquare!==null&&(this.toSquare=null,this.movingOverSquareCallback(this.fromSquare,null))}else this.toSquare!==null&&(this.toSquare=null,this.movingOverSquareCallback(this.fromSquare,null));this.view.chessboard.state.inputEnabled()&&(this.moveInputState===m.dragTo||this.moveInputState===m.clickDragTo)&&this.moveDraggablePiece(t,s)}}onPointerUp(e){let t;if(e.type==="mouseup"?t=e.target:e.type==="touchend"&&(t=document.elementFromPoint(e.changedTouches[0].clientX,e.changedTouches[0].clientY)),t&&t.getAttribute){const s=t.getAttribute("data-square");if(s)this.moveInputState===m.dragTo||this.moveInputState===m.clickDragTo?this.fromSquare===s?this.moveInputState===m.clickDragTo?(this.chessboard.state.position.setPiece(this.fromSquare,this.movedPiece),this.view.setPieceVisibility(this.fromSquare),this.moveInputCanceledCallback(s,null,he.draggedBack),this.setMoveInputState(m.reset)):this.setMoveInputState(m.clickTo,{square:s}):this.setMoveInputState(m.moveDone,{square:s}):this.moveInputState===m.pieceClickedThreshold?this.setMoveInputState(m.clickTo,{square:s}):this.moveInputState===m.secondClickThreshold&&(this.setMoveInputState(m.reset),this.moveInputCanceledCallback(s,null,he.secondClick));else{this.view.redrawPieces();const i=this.fromSquare;this.setMoveInputState(m.reset),this.moveInputCanceledCallback(i,null,he.movedOutOfBoard)}}else this.view.redrawPieces(),this.setMoveInputState(m.reset)}onContextMenu(e){e.preventDefault(),this.view.redrawPieces(),this.setMoveInputState(m.reset),this.moveInputCanceledCallback(this.fromSquare,null,he.secondaryClick)}isDragging(){return this.moveInputState===m.dragTo||this.moveInputState===m.clickDragTo}destroy(){this.setMoveInputState(m.reset)}}const R={white:"w",black:"b"},F={moveInputStarted:"moveInputStarted",movingOverSquare:"movingOverSquare",validateMoveInput:"validateMoveInput",moveInputCanceled:"moveInputCanceled",moveInputFinished:"moveInputFinished"},Js={pointerdown:"pointerdown"},ie={none:"none",thin:"thin",frame:"frame"};class ei{constructor(e){this.chessboard=e,this.visualMoveInput=new Zs(this),e.props.assetsCache&&this.cacheSpriteToDiv("cm-chessboard-sprite",this.getSpriteUrl()),this.container=document.createElement("div"),this.chessboard.context.appendChild(this.container),e.props.responsive&&(typeof ResizeObserver<"u"?(this.resizeObserver=new ResizeObserver(()=>{setTimeout(()=>{this.handleResize()})}),this.resizeObserver.observe(this.chessboard.context)):(this.resizeListener=this.handleResize.bind(this),window.addEventListener("resize",this.resizeListener))),this.positionsAnimationTask=Promise.resolve(),this.pointerDownListener=this.pointerDownHandler.bind(this),this.container.addEventListener("mousedown",this.pointerDownListener),this.container.addEventListener("touchstart",this.pointerDownListener,{passive:!1}),this.createSvgAndGroups(),this.handleResize()}pointerDownHandler(e){this.visualMoveInput.onPointerDown(e)}destroy(){this.visualMoveInput.destroy(),this.resizeObserver&&this.resizeObserver.unobserve(this.chessboard.context),this.resizeListener&&window.removeEventListener("resize",this.resizeListener),this.chessboard.context.removeEventListener("mousedown",this.pointerDownListener),this.chessboard.context.removeEventListener("touchstart",this.pointerDownListener),C.removeElement(this.svg),this.container.remove()}cacheSpriteToDiv(e,t){if(!document.getElementById(e)){const s=document.createElement("div");s.style.transform="scale(0)",s.style.position="absolute",s.setAttribute("aria-hidden","true"),s.id=e,document.body.appendChild(s);const i=new XMLHttpRequest;i.open("GET",t,!0),i.onload=function(){s.insertAdjacentHTML("afterbegin",i.response)},i.send()}}createSvgAndGroups(){this.svg=C.createSvg(this.container);let e=this.chessboard.props.style.cssClass?this.chessboard.props.style.cssClass:"default";this.svg.setAttribute("class","cm-chessboard border-type-"+this.chessboard.props.style.borderType+" "+e),this.svg.setAttribute("role","img"),this.updateMetrics(),this.boardGroup=C.addElement(this.svg,"g",{class:"board"}),this.coordinatesGroup=C.addElement(this.svg,"g",{class:"coordinates","aria-hidden":"true"}),this.markersLayer=C.addElement(this.svg,"g",{class:"markers-layer"}),this.piecesLayer=C.addElement(this.svg,"g",{class:"pieces-layer"}),this.piecesGroup=C.addElement(this.piecesLayer,"g",{class:"pieces"}),this.markersTopLayer=C.addElement(this.svg,"g",{class:"markers-top-layer"}),this.interactiveTopLayer=C.addElement(this.svg,"g",{class:"interactive-top-layer"})}updateMetrics(){const e=this.chessboard.props.style.pieces.tileSize;this.width=this.container.clientWidth,this.height=this.container.clientWidth*(this.chessboard.props.style.aspectRatio||1),this.chessboard.props.style.borderType===ie.frame?this.borderSize=this.width/25:this.chessboard.props.style.borderType===ie.thin?this.borderSize=this.width/320:this.borderSize=0,this.innerWidth=this.width-2*this.borderSize,this.innerHeight=this.height-2*this.borderSize,this.squareWidth=this.innerWidth/8,this.squareHeight=this.innerHeight/8,this.scalingX=this.squareWidth/e,this.scalingY=this.squareHeight/e,this.pieceXTranslate=this.squareWidth/2-e*this.scalingY/2}handleResize(){this.container.style.width=this.chessboard.context.clientWidth+"px",this.container.style.height=this.chessboard.context.clientWidth*this.chessboard.props.style.aspectRatio+"px",(this.container.clientWidth!==this.width||this.container.clientHeight!==this.height)&&(this.updateMetrics(),this.redrawBoard(),this.redrawPieces()),this.svg.setAttribute("width","100%"),this.svg.setAttribute("height","100%")}redrawBoard(){this.chessboard.state.invokeExtensionPoints(T.beforeRedrawBoard),this.redrawSquares(),this.drawCoordinates(),this.chessboard.state.invokeExtensionPoints(T.afterRedrawBoard),this.visualizeInputState()}redrawSquares(){for(;this.boardGroup.firstChild;)this.boardGroup.removeChild(this.boardGroup.lastChild);if(C.addElement(this.boardGroup,"rect",{width:this.width,height:this.height}).setAttribute("class","border"),this.chessboard.props.style.borderType===ie.frame){const t=this.borderSize;C.addElement(this.boardGroup,"rect",{x:t,y:t,width:this.width-t*2,height:this.height-t*2}).setAttribute("class","border-inner")}for(let t=0;t<64;t++){const s=this.chessboard.state.orientation===R.white?t:63-t,r=`square ${(9*s&8)===0?"black":"white"}`,n=this.squareToPoint(M.indexToSquare(s)),a=C.addElement(this.boardGroup,"rect",{x:n.x,y:n.y,width:this.squareWidth,height:this.squareHeight});a.setAttribute("class",r),a.setAttribute("data-square",M.indexToSquare(s))}}drawCoordinates(){if(!this.chessboard.props.style.showCoordinates)return;for(;this.coordinatesGroup.firstChild;)this.coordinatesGroup.removeChild(this.coordinatesGroup.lastChild);const e=this.chessboard.props.style.borderType!==ie.frame;for(let t=0;t<8;t++){let s=this.borderSize+(17+this.chessboard.props.style.pieces.tileSize*t)*this.scalingX,i=this.height-this.scalingY*3.5,r="coordinate file";e&&(s=s+this.scalingX*15.5,r+=t%2?" white":" black");const n=C.addElement(this.coordinatesGroup,"text",{class:r,x:s,y:i,style:`font-size: ${this.scalingY*10}px`});this.chessboard.state.orientation===R.white?n.textContent=String.fromCharCode(97+t):n.textContent=String.fromCharCode(104-t)}for(let t=0;t<8;t++){let s=this.borderSize/3.7,i=this.borderSize+25*this.scalingY+t*this.squareHeight,r="coordinate rank";e&&(r+=t%2?" black":" white",this.chessboard.props.style.borderType===ie.frame?(s=s+this.scalingX*10,i=i-this.scalingY*15):(s=s+this.scalingX*2,i=i-this.scalingY*15));const n=C.addElement(this.coordinatesGroup,"text",{class:r,x:s,y:i,style:`font-size: ${this.scalingY*10}px`});this.chessboard.state.orientation===R.white?n.textContent=""+(8-t):n.textContent=""+(1+t)}}redrawPieces(e=this.chessboard.state.position.squares){const t=Array.from(this.piecesGroup.childNodes),s=this.visualMoveInput.isDragging();for(let i=0;i<64;i++){const r=e[i];if(r){const n=M.indexToSquare(i);this.drawPieceOnSquare(n,r,s&&n===this.visualMoveInput.fromSquare)}}for(const i of t)this.piecesGroup.removeChild(i)}drawPiece(e,t,s){const i=C.addElement(e,"g",{});i.setAttribute("data-piece",t);const r=this.svg.createSVGTransform();r.setTranslate(s.x,s.y),i.transform.baseVal.appendItem(r);const n=this.chessboard.props.assetsCache?"":this.getSpriteUrl(),a=C.addElement(i,"use",{href:`${n}#${t}`,class:"piece"}),c=this.svg.createSVGTransform();return c.setScale(this.scalingY,this.scalingY),a.transform.baseVal.appendItem(c),i}drawPieceOnSquare(e,t,s=!1){const i=C.addElement(this.piecesGroup,"g",{});i.setAttribute("data-piece",t),i.setAttribute("data-square",e),s&&i.setAttribute("visibility","hidden");const r=this.squareToPoint(e),n=this.svg.createSVGTransform();n.setTranslate(r.x,r.y),i.transform.baseVal.appendItem(n);const a=this.chessboard.props.assetsCache?"":this.getSpriteUrl(),c=C.addElement(i,"use",{href:`${a}#${t}`,class:"piece"}),p=this.svg.createSVGTransform();p.setTranslate(this.pieceXTranslate,0),c.transform.baseVal.appendItem(p);const g=this.svg.createSVGTransform();return g.setScale(this.scalingY,this.scalingY),c.transform.baseVal.appendItem(g),i}setPieceVisibility(e,t=!0){const s=this.getPieceElement(e);s?t?s.setAttribute("visibility","visible"):s.setAttribute("visibility","hidden"):console.warn("no piece on",e)}getPieceElement(e){if(!e||e.length<2)return console.warn("invalid square",e),null;const t=this.piecesGroup.querySelector(`g[data-square='${e}']`);return t||(console.warn("no piece on",e),null)}enableMoveInput(e,t=null){if(this.chessboard.state.moveInputCallback)throw Error("moveInput already enabled");t===R.white?this.chessboard.state.inputWhiteEnabled=!0:t===R.black?this.chessboard.state.inputBlackEnabled=!0:(this.chessboard.state.inputWhiteEnabled=!0,this.chessboard.state.inputBlackEnabled=!0),this.chessboard.state.moveInputCallback=e,this.chessboard.state.invokeExtensionPoints(T.moveInputToggled,{enabled:!0,color:t}),this.visualizeInputState()}disableMoveInput(){this.chessboard.state.inputWhiteEnabled=!1,this.chessboard.state.inputBlackEnabled=!1,this.chessboard.state.moveInputCallback=null,this.chessboard.state.invokeExtensionPoints(T.moveInputToggled,{enabled:!1}),this.visualizeInputState()}moveInputStartedCallback(e){const t={chessboard:this.chessboard,type:F.moveInputStarted,square:e,squareFrom:e,piece:this.chessboard.getPiece(e)};return this.chessboard.state.moveInputCallback&&(t.moveInputCallbackResult=this.chessboard.state.moveInputCallback(t)),this.chessboard.state.invokeExtensionPoints(T.moveInput,t),t.moveInputCallbackResult}movingOverSquareCallback(e,t){const s={chessboard:this.chessboard,type:F.movingOverSquare,squareFrom:e,squareTo:t,piece:this.chessboard.getPiece(e)};this.chessboard.state.moveInputCallback&&(s.moveInputCallbackResult=this.chessboard.state.moveInputCallback(s)),this.chessboard.state.invokeExtensionPoints(T.moveInput,s)}validateMoveInputCallback(e,t){const s={chessboard:this.chessboard,type:F.validateMoveInput,squareFrom:e,squareTo:t,piece:this.chessboard.getPiece(e)};return this.chessboard.state.moveInputCallback&&(s.moveInputCallbackResult=this.chessboard.state.moveInputCallback(s)),this.chessboard.state.invokeExtensionPoints(T.moveInput,s),s.moveInputCallbackResult}moveInputCanceledCallback(e,t,s){const i={chessboard:this.chessboard,type:F.moveInputCanceled,reason:s,squareFrom:e,squareTo:t};this.chessboard.state.moveInputCallback&&this.chessboard.state.moveInputCallback(i),this.chessboard.state.invokeExtensionPoints(T.moveInput,i)}moveInputFinishedCallback(e,t,s){const i={chessboard:this.chessboard,type:F.moveInputFinished,squareFrom:e,squareTo:t,legalMove:s};this.chessboard.state.moveInputCallback&&this.chessboard.state.moveInputCallback(i),this.chessboard.state.invokeExtensionPoints(T.moveInput,i)}visualizeInputState(){this.chessboard.state&&(this.chessboard.state.inputWhiteEnabled||this.chessboard.state.inputBlackEnabled?this.boardGroup.setAttribute("class","board input-enabled"):this.boardGroup.setAttribute("class","board"))}indexToPoint(e){let t,s;return this.chessboard.state.orientation===R.white?(t=this.borderSize+e%8*this.squareWidth,s=this.borderSize+(7-Math.floor(e/8))*this.squareHeight):(t=this.borderSize+(7-e%8)*this.squareWidth,s=this.borderSize+Math.floor(e/8)*this.squareHeight),{x:t,y:s}}squareToPoint(e){const t=M.squareToIndex(e);return this.indexToPoint(t)}getSpriteUrl(){return Z.isAbsoluteUrl(this.chessboard.props.style.pieces.file)?this.chessboard.props.style.pieces.file:this.chessboard.props.assetsUrl+this.chessboard.props.style.pieces.file}}const Q={wp:"wp",wb:"wb",wn:"wn",wr:"wr",wq:"wq",wk:"wk",bp:"bp",bb:"bb",bn:"bn",br:"br",bq:"bq",bk:"bk"},ti={svgSprite:"svgSprite"};class si{constructor(e,t={}){if(!e)throw new Error("container element is "+e);this.context=e,this.id=(Math.random()+1).toString(36).substring(2,8),this.extensions=[],this.props={position:we.empty,orientation:R.white,responsive:!0,assetsUrl:"./assets/",assetsCache:!0,style:{cssClass:"default",showCoordinates:!0,borderType:ie.none,aspectRatio:1,pieces:{type:ti.svgSprite,file:"pieces/standard.svg",tileSize:40},animationDuration:300},extensions:[]},Z.mergeObjects(this.props,t),this.state=new Ys,this.view=new ei(this),this.positionAnimationsQueue=new Xs(this),this.state.orientation=this.props.orientation;for(const s of this.props.extensions)this.addExtension(s.class,s.props);this.view.redrawBoard(),this.state.position=new M(this.props.position),this.view.redrawPieces(),this.state.invokeExtensionPoints(T.positionChanged),this.initialized=Promise.resolve()}async setPiece(e,t,s=!1){const i=this.state.position.clone();return this.state.position.setPiece(e,t),this.state.invokeExtensionPoints(T.positionChanged),this.positionAnimationsQueue.enqueuePositionChange(i,this.state.position.clone(),s)}async movePiece(e,t,s=!1){const i=this.state.position.clone();return this.state.position.movePiece(e,t),this.state.invokeExtensionPoints(T.positionChanged),this.positionAnimationsQueue.enqueuePositionChange(i,this.state.position.clone(),s)}async setPosition(e,t=!1){const s=this.state.position.clone(),i=new M(e);return s.getFen()!==i.getFen()&&(this.state.position.setFen(e),this.state.invokeExtensionPoints(T.positionChanged)),this.positionAnimationsQueue.enqueuePositionChange(s,this.state.position.clone(),t)}async setOrientation(e,t=!1){const s=this.state.position.clone();if(this.boardTurning){console.warn("setOrientation is only once in queue allowed");return}return this.boardTurning=!0,this.positionAnimationsQueue.enqueueTurnBoard(s,e,t).then(()=>{this.boardTurning=!1,this.state.invokeExtensionPoints(T.boardChanged)})}getPiece(e){return this.state.position.getPiece(e)}getPosition(){return this.state.position.getFen()}getOrientation(){return this.state.orientation}enableMoveInput(e,t=void 0){this.view.enableMoveInput(e,t)}disableMoveInput(){this.view.disableMoveInput()}isMoveInputEnabled(){return this.state.inputWhiteEnabled||this.state.inputBlackEnabled}enableSquareSelect(e=Js.pointerdown,t){this.squareSelectListener||(this.squareSelectListener=function(s){const i=s.target.getAttribute("data-square");t({eventType:s.type,event:s,chessboard:this,square:i})}),this.context.addEventListener(e,this.squareSelectListener),this.state.squareSelectEnabled=!0,this.view.visualizeInputState()}disableSquareSelect(e){this.context.removeEventListener(e,this.squareSelectListener),this.squareSelectListener=void 0,this.state.squareSelectEnabled=!1,this.view.visualizeInputState()}isSquareSelectEnabled(){return this.state.squareSelectEnabled}addExtension(e,t){if(this.getExtension(e))throw Error('extension "'+e.name+'" already added');this.extensions.push(new e(this,t))}getExtension(e){for(const t of this.extensions)if(t instanceof e)return t;return null}destroy(){this.state.invokeExtensionPoints(T.destroy),this.positionAnimationsQueue.destroy(),this.view.destroy(),this.view=void 0,this.state=void 0}}const V={frame:{class:"marker-frame",slice:"markerFrame"},circle:{class:"marker-circle",slice:"markerCircle"},dot:{class:"marker-dot",slice:"markerDot",position:"above"},bevel:{class:"marker-bevel",slice:"markerBevel"}};class ii extends Re{constructor(e,t={}){super(e),this.registerExtensionPoint(T.afterRedrawBoard,()=>{this.onRedrawBoard()}),this.props={autoMarkers:V.frame,sprite:"extensions/markers/markers.svg"},Object.assign(this.props,t),e.props.assetsCache&&e.view.cacheSpriteToDiv("cm-chessboard-markers",this.getSpriteUrl()),e.addMarker=this.addMarker.bind(this),e.getMarkers=this.getMarkers.bind(this),e.removeMarkers=this.removeMarkers.bind(this),e.addLegalMovesMarkers=this.addLegalMovesMarkers.bind(this),e.removeLegalMovesMarkers=this.removeLegalMovesMarkers.bind(this),this.markerGroupDown=C.addElement(e.view.markersLayer,"g",{class:"markers"}),this.markerGroupUp=C.addElement(e.view.markersTopLayer,"g",{class:"markers"}),this.markers=[],this.props.autoMarkers&&(Object.assign(this.props.autoMarkers,this.props.autoMarkers),this.registerExtensionPoint(T.moveInput,s=>{this.drawAutoMarkers(s)}))}drawAutoMarkers(e){e.type!==F.moveInputFinished&&this.removeMarkers(this.props.autoMarkers),!(e.type===F.moveInputStarted&&!e.moveInputCallbackResult)&&(e.type===F.moveInputStarted||e.type===F.movingOverSquare)&&(e.squareFrom&&this.addMarker(this.props.autoMarkers,e.squareFrom),e.squareTo&&this.addMarker(this.props.autoMarkers,e.squareTo))}onRedrawBoard(){for(;this.markerGroupUp.firstChild;)this.markerGroupUp.removeChild(this.markerGroupUp.firstChild);for(;this.markerGroupDown.firstChild;)this.markerGroupDown.removeChild(this.markerGroupDown.firstChild);this.markers.forEach(e=>{this.drawMarker(e)})}addLegalMovesMarkers(e){for(const t of e)t.promotion&&t.promotion!=="q"||(this.chessboard.getPiece(t.to)?this.chessboard.addMarker(V.bevel,t.to):this.chessboard.addMarker(V.dot,t.to))}removeLegalMovesMarkers(){this.chessboard.removeMarkers(V.bevel),this.chessboard.removeMarkers(V.dot)}drawMarker(e){let t;e.type.position==="above"?t=C.addElement(this.markerGroupUp,"g"):t=C.addElement(this.markerGroupDown,"g"),t.setAttribute("data-square",e.square);const s=this.chessboard.view.squareToPoint(e.square),i=this.chessboard.view.svg.createSVGTransform();i.setTranslate(s.x,s.y),t.transform.baseVal.appendItem(i);const r=this.chessboard.props.assetsCache?"":this.getSpriteUrl(),n=C.addElement(t,"use",{href:`${r}#${e.type.slice}`,class:"marker "+e.type.class}),a=this.chessboard.view.svg.createSVGTransform();return a.setScale(this.chessboard.view.scalingX,this.chessboard.view.scalingY),n.transform.baseVal.appendItem(a),t}addMarker(e,t){if(typeof e=="string"||typeof t=="object"){console.error("changed the signature of `addMarker` to `(type, square)` with v5.1.x");return}this.markers.push(new ri(t,e)),this.onRedrawBoard()}getMarkers(e=void 0,t=void 0){if(typeof e=="string"||typeof t=="object"){console.error("changed the signature of `getMarkers` to `(type, square)` with v5.1.x");return}let s=[];return this.markers.forEach(i=>{i.matches(t,e)&&s.push(i)}),s}removeMarkers(e=void 0,t=void 0){if(typeof e=="string"||typeof t=="object"){console.error("changed the signature of `removeMarkers` to `(type, square)` with v5.1.x");return}this.markers=this.markers.filter(s=>!s.matches(t,e)),this.onRedrawBoard()}getSpriteUrl(){return Z.isAbsoluteUrl(this.props.sprite)?this.props.sprite:this.chessboard.props.assetsUrl+this.props.sprite}}class ri{constructor(e,t){this.square=e,this.type=t}matches(e=void 0,t=void 0){if(!t&&!e)return!0;if(t){if(e){if(this.type===t&&e===this.square)return!0}else if(this.type===t)return!0}else if(e===this.square)return!0;return!1}}const U={hidden:"hidden",displayRequested:"displayRequested",shown:"shown"},Oe={pieceSelected:"pieceSelected",canceled:"canceled"};class ni extends Re{constructor(e){super(e),this.registerExtensionPoint(T.afterRedrawBoard,this.extensionPointRedrawBoard.bind(this)),e.showPromotionDialog=this.showPromotionDialog.bind(this),e.isPromotionDialogShown=this.isPromotionDialogShown.bind(this),this.promotionDialogGroup=C.addElement(e.view.interactiveTopLayer,"g",{class:"promotion-dialog-group"}),this.state={displayState:U.hidden,callback:null,dialogParams:{square:null,color:null}}}showPromotionDialog(e,t,s){this.state.dialogParams.square=e,this.state.dialogParams.color=t,this.state.callback=s,this.setDisplayState(U.displayRequested),setTimeout(()=>{this.chessboard.view.positionsAnimationTask.then(()=>{this.setDisplayState(U.shown)})})}isPromotionDialogShown(){return this.state.displayState===U.shown||this.state.displayState===U.displayRequested}extensionPointRedrawBoard(){this.redrawDialog()}drawPieceButton(e,t){const s=this.chessboard.view.squareWidth,i=this.chessboard.view.squareHeight;C.addElement(this.promotionDialogGroup,"rect",{x:t.x,y:t.y,width:s,height:i,class:"promotion-dialog-button","data-piece":e}),this.chessboard.view.drawPiece(this.promotionDialogGroup,e,t)}redrawDialog(){for(;this.promotionDialogGroup.firstChild;)this.promotionDialogGroup.removeChild(this.promotionDialogGroup.firstChild);if(this.state.displayState===U.shown){const e=this.chessboard.view.squareWidth,t=this.chessboard.view.squareHeight,s=this.chessboard.view.squareToPoint(this.state.dialogParams.square);s.x=s.x+e/2,s.y=s.y+t/2;let i=!1;const r=parseInt(this.state.dialogParams.square.charAt(1),10);(this.chessboard.getOrientation()===R.white&&r<5||this.chessboard.getOrientation()===R.black&&r>=5)&&(i=!0);const n=i?-4*t:0,a=s.x+e>this.chessboard.view.width?-e:0;C.addElement(this.promotionDialogGroup,"rect",{x:s.x+a,y:s.y+n,width:e,height:t*4,class:"promotion-dialog"});const c=this.state.dialogParams;i?(this.drawPieceButton(Q[c.color+"q"],{x:s.x+a,y:s.y-t}),this.drawPieceButton(Q[c.color+"r"],{x:s.x+a,y:s.y-t*2}),this.drawPieceButton(Q[c.color+"b"],{x:s.x+a,y:s.y-t*3}),this.drawPieceButton(Q[c.color+"n"],{x:s.x+a,y:s.y-t*4})):(this.drawPieceButton(Q[c.color+"q"],{x:s.x+a,y:s.y}),this.drawPieceButton(Q[c.color+"r"],{x:s.x+a,y:s.y+t}),this.drawPieceButton(Q[c.color+"b"],{x:s.x+a,y:s.y+t*2}),this.drawPieceButton(Q[c.color+"n"],{x:s.x+a,y:s.y+t*3}))}}promotionDialogOnClickPiece(e){e.button!==2&&(e.target.dataset.piece?(this.state.callback&&this.state.callback({type:Oe.pieceSelected,square:this.state.dialogParams.square,piece:e.target.dataset.piece}),this.setDisplayState(U.hidden)):this.promotionDialogOnCancel(e))}promotionDialogOnCancel(e){this.state.displayState===U.shown&&(e.preventDefault(),this.setDisplayState(U.hidden),this.state.callback&&this.state.callback({type:Oe.canceled}))}contextMenu(e){e.preventDefault(),this.setDisplayState(U.hidden),this.state.callback&&this.state.callback({type:Oe.canceled})}setDisplayState(e){this.state.displayState=e,e===U.shown?(this.clickDelegate=Z.delegate(this.chessboard.view.svg,"pointerdown","*",this.promotionDialogOnClickPiece.bind(this)),this.contextMenuListener=this.contextMenu.bind(this),this.chessboard.view.svg.addEventListener("contextmenu",this.contextMenuListener)):e===U.hidden&&(this.clickDelegate.remove(),this.chessboard.view.svg.removeEventListener("contextmenu",this.contextMenuListener)),this.redrawDialog()}}class ai extends Re{constructor(e){super(e),e.addHtmlLayer=this.addHtmlLayer.bind(this),e.removeHtmlLayer=this.removeHtmlLayer.bind(this)}addHtmlLayer(e){const t=document.createElement("div");return this.chessboard.context.appendChild(t),this.chessboard.context.style.position="relative",t.classList.add("html-layer"),t.style.position="absolute",t.style.top="0",t.style.left="0",t.style.bottom="0",t.style.right="0",t.innerHTML=e,t}removeHtmlLayer(e){this.chessboard.context.removeChild(e)}}const me={white:{class:"customMarkerWhite",slice:"markerSquare"},black:{class:"customMarkerBlack",slice:"markerSquare"}},oi=`
<div class="overlay-content">
  <div id="gameOverText" class="overlay-text"></div>
  <div id="gameOverRestart" class="game-over-arrow" role="button" aria-label="Restart game" title="Restart game" tabindex="0">
    ⟳
  </div>
</div>
`,hi=`
<div class="overlay-content">
  <div class="loading-spinner"></div>
  <div class="overlay-text"></div>
</div>
`;class kt{layer;overlayText;constructor(e){this.layer=e,this.overlayText=this.layer.querySelector(".overlay-text"),this.hide()}show(e){e!==null&&(this.overlayText.textContent=e),this.layer.classList.add("visible"),this.layer.setAttribute("aria-hidden","false")}hide(){this.layer.classList.remove("visible"),this.layer.setAttribute("aria-hidden","true")}}class li{player=R.white;searchMode="depth";chessGame=new bt;cpBar=new dt("cpBar",$e.CP);wdlBar=new dt("wdlBar",$e.WDL);chessBoard=this.initChessBoard();engineWorker=null;workerState="uninitialized";workerPromise=null;selectedSquare=null;possibleTargets=null;gameOverOverlay;loadingOverlay;fenInput=document.querySelector("#fenInput");searchInput=document.querySelector("#searchInput");constructor(){const e=this.chessBoard.addHtmlLayer(oi),t=this.chessBoard.addHtmlLayer(hi);this.gameOverOverlay=new kt(e),this.loadingOverlay=new kt(t),document.getElementById("gameOverRestart").onclick=async()=>{this.initEngine(!0),await this.startGame()};const s=document.getElementById("searchMode"),i=s.querySelectorAll(".mode-btn");s.addEventListener("click",r=>{const a=r.target.closest(".mode-btn");if(!a)return;i.forEach(v=>v.classList.remove("selected")),a.classList.add("selected"),this.searchMode=a.dataset.mode;let c,p,g,b;this.searchMode==="depth"?[c,p,g,b]=["18","1","30","1"]:[c,p,g,b]=["1000","1","999999","1000"],this.searchInput.value=c,this.searchInput.min=p,this.searchInput.max=g,this.searchInput.step=b}),this.fenInput.addEventListener("focus",()=>this.fenInput.select()),this.searchInput.addEventListener("focus",()=>this.searchInput.select()),this.fenInput.addEventListener("blur",async()=>{const r=this.fenInput.value.trim()??"";!r||!St(r).ok?this.fenInput.value=this.chessGame.fen():r!==this.chessGame.fen()&&(this.initEngine(!0),await this.startGame(r))}),this.searchInput.addEventListener("blur",()=>{function r(p,g,b){return Math.min(Math.max(p,g),b)}const n=Number(this.searchInput.value),a=Number(this.searchInput.min),c=Number(this.searchInput.max);this.searchInput.value=r(n,a,c).toFixed(0)}),window.addEventListener("resize",()=>this.resize()),this.resize()}initChessBoard(){const e={orientation:this.player,responsive:!0,animationDuration:200,assetsUrl:"/vendor/",assetsCache:!0,style:{cssClass:"green",showCoordinates:!1,borderType:"thin",aspectRatio:1,pieces:{file:"staunty.svg",tileSize:40}},extensions:[{class:ni},{class:ii,props:{autoMarkers:null,sprite:"markers.svg"}},{class:ai}]},t=document.getElementById("board");return new si(t,e)}async initEngine(e=!1){if(this.workerState!=="uninitialized"&&!e)return this.workerPromise;this.workerState="initializing",this.loadingOverlay.show("Loading..."),this.engineWorker&&this.engineWorker.terminate();const t=new Worker(new URL("/assets/engineWorker-ucyctyhw.js",import.meta.url),{type:"module"});this.engineWorker=t;const s=await Ps,i=r=>{const{type:n,data:a}=r.data??{};n==="searchResult"?this.updateSearchData?.(a):n==="perftResult"?this.updatePerftData?.(a):n==="enginePick"&&this.updateEnginePick?.(a)};return this.workerPromise=new Promise(r=>{const n=a=>{a.data?.type==="ready"&&(t.removeEventListener("message",n),t.addEventListener("message",i),this.workerState="initialized",this.loadingOverlay.hide(),r())};t.addEventListener("message",n)}),t.postMessage({type:"init",module:s}),this.workerPromise}addCustomMarker(e){function t(s){const i=s.charCodeAt(0)-97;return 8*(parseInt(s.charAt(1))-1)+i}t(e)%2===0?this.chessBoard.addMarker(me.black,e):this.chessBoard.addMarker(me.white,e)}removeSelectionMarkers(){this.selectedSquare!==null&&(this.chessBoard.removeMarkers(V.circle),this.chessBoard.removeMarkers(V.dot),this.chessBoard.removeMarkers(void 0,this.selectedSquare),this.possibleTargets=null,this.selectedSquare=null)}removeAllMarkers(){this.removeSelectionMarkers(),this.chessBoard.removeMarkers(me.black),this.chessBoard.removeMarkers(me.white)}addSelectionMarkers(e){const t=this.chessGame.moves({square:e,verbose:!0});this.possibleTargets=new Set,this.selectedSquare=e,this.addCustomMarker(e),t.forEach(s=>{const i=s.to,n=s.isCapture()||s.isEnPassant()?V.circle:V.dot;this.chessBoard.addMarker(n,i),this.possibleTargets.add(i)})}addMoveMarkers(e,t){this.addCustomMarker(e),this.addCustomMarker(t)}makeEngineMove(){if(this.workerState!=="initialized")return;const e="fen "+this.chessGame.fen(),t=`${this.searchMode} ${this.searchInput.value}`;this.engineWorker.postMessage({type:"search",data:{position:e,tc:t}})}disableMoveInput(){this.chessBoard.disableMoveInput(),this.chessBoard.view?.visualMoveInput?.destroy?.()}setTurn(e){this.disableMoveInput(),e===this.player?this.chessBoard.enableMoveInput(t=>this.moveEventHandler(t)):this.makeEngineMove()}gameOver(){let e,t,s;if(this.chessGame.isCheckmate()){const i=this.chessGame.turn(),r=i!==this.player,n=i==="b";e=n?"Mate":"Mated",t={val:1,w:n?1e3:0,d:0,l:n?0:1e3},s=r?"You win!":"You lose!"}else e="Cp",t={val:0,w:0,d:1e3,l:0},s="It's a draw!";this.cpBar.updateEvaluation(e,t),this.wdlBar.updateEvaluation(e,t),this.gameOverOverlay.show(s),this.disableMoveInput()}async applyMoveToGame(e){const t=this.chessGame.move(e);this.fenInput.value=this.chessGame.fen(),this.removeAllMarkers(),await this.chessBoard.setPosition(this.chessGame.fen(),!0),this.addMoveMarkers(t.from,t.to),this.chessGame.isGameOver()?this.gameOver():this.setTurn(this.chessGame.turn())}moveEventHandler(e){const t=document.activeElement;switch(t?.tagName==="INPUT"&&t.blur(),console.log("[MOVE EVENT]: ",e),e.type){case F.moveInputStarted:return this.addSelectionMarkers(e.square),!0;case F.validateMoveInput:const[s,i,r]=[e.squareFrom,e.squareTo,e.piece];if(r.charAt(0)!=this.player||!this.possibleTargets?.has(i))return!1;const c=r.charAt(1)==="p",p=i.charAt(1),g=p=="8"&&this.player===R.white||p=="1"&&this.player===R.black;return c&&g?(this.chessBoard.showPromotionDialog(i,this.player,b=>{b&&b.piece?this.applyMoveToGame({from:s,to:i,promotion:b.piece.charAt(1)}):this.chessBoard.movePiece(i,s,!1)}),!0):(this.applyMoveToGame({from:s,to:i}),!0);case F.moveInputFinished:case F.moveInputCanceled:return this.removeSelectionMarkers(),!0}}resize(){this.cpBar.setHeight("0px"),this.wdlBar.setHeight("0px"),this.chessBoard.view.handleResize();const t=document.getElementById("board").getBoundingClientRect().height+"px";this.cpBar.setHeight(t),this.wdlBar.setHeight(t)}async startGame(e){this.resize(),this.gameOverOverlay.hide(),this.removeAllMarkers(),this.cpBar.reset(),this.wdlBar.reset(),this.chessGame=new bt(e),this.player=this.chessGame.turn(),this.fenInput.value=this.chessGame.fen(),await this.workerPromise,await this.chessBoard.setPosition(this.chessGame.fen(),!0),await this.chessBoard.setOrientation(this.player),this.setTurn(this.chessGame.turn())}updatePerftData(e){console.log("Perft speed: ",e.nps)}updateSearchData(e){console.log(`[DEPTH ${e.depth}] Search speed: ${e.nps}`);const t=e.score_type,s=e.score,i=this.player===R.white;this.cpBar.updateEvaluation(t,s,i),this.wdlBar.updateEvaluation(t,s,i)}updateEnginePick(e){console.log("Engine pick: ",e),this.applyMoveToGame(e)}}class ci{currentPage="";chessApp=new li;constructor(){this.setupNavigation(),this.setupExternalLinks(),this.setupPopState(),window.addEventListener("hashchange",()=>this.routeFromHash()),this.routeFromHash(),this.chessApp.initEngine()}async loadPage(e){if(this.currentPage===e)return;document.querySelectorAll(".page").forEach(s=>{s.id===`page-${e}`?s.classList.add("active"):s.classList.remove("active")}),this.currentPage=e,this.updateNavigation(e),window.scrollTo(0,0),document.title="asgobbi / "+e,e==="chess"?await this.chessApp.startGame():this.chessApp.initEngine(!0)}getCurrentPage(){const e=(window.location.hash||"").slice(1);return["home","about","chess","github"].includes(e)?e:"home"}routeFromHash(){const e=this.getCurrentPage();(!window.location.hash||window.location.hash.slice(1)!==e)&&(window.location.hash=e),this.loadPage(e)}setupNavigation(){document.addEventListener("keydown",t=>{if(t.key==="Tab"&&t.target===document.body){const s=document.querySelector(".nav-link");s&&(t.preventDefault(),s.focus())}}),document.querySelectorAll(".nav-link").forEach(t=>{t.addEventListener("click",s=>{s.preventDefault();const i=t.getAttribute("data-page");i&&(window.location.hash=i)})}),document.addEventListener("keydown",t=>{const s=t.target;if(s?.tagName==="INPUT"){(t.key==="Escape"||t.key==="Enter")&&s.blur();return}const i={1:"home",2:"about",3:"chess",4:"github"};i[t.key]&&(t.preventDefault(),window.location.hash=i[t.key])})}updateNavigation(e){document.querySelectorAll(".nav-link").forEach(t=>{t.getAttribute("data-page")===e?t.classList.add("active"):t.classList.remove("active")})}setupExternalLinks(){const e='a[href^="http"]:not([href*="'+window.location.origin+'"]),a[target="_blank"]';document.querySelectorAll(e).forEach(s=>{s.setAttribute("target","_blank"),s.setAttribute("rel","noopener noreferrer")})}setupPopState(){window.addEventListener("popstate",e=>{e.state&&e.state.page?this.loadPage(e.state.page):this.routeFromHash()})}}window.terminalSite=new ci;
