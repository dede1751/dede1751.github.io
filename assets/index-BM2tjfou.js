(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const n of r.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&s(n)}).observe(document,{childList:!0,subtree:!0});function t(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(i){if(i.ep)return;i.ep=!0;const r=t(i);fetch(i.href,r)}})();var $e=(h=>(h[h.WDL=0]="WDL",h[h.CP=1]="CP",h))($e||{});class dt{scoreType;container;whiteDiv;greyDiv;blackDiv;scoreDivWhite;scoreDivGrey;scoreDivBlack;minRoomPercent=5;constructor(e,t){this.scoreType=t,this.container=document.getElementById(e),this.container.innerHTML=`
      <div class="eval-bar-outer" style="height: 100%;">
        <div class="eval-bar-black">
          <div class="eval-bar-score black" style="display:none"></div>
        </div>
        <div class="eval-bar-grey">
          <div class="eval-bar-score grey" style="display:none"></div>
        </div>
        <div class="eval-bar-white">
          <div class="eval-bar-score white" style="display:none"></div>
        </div>
      </div>
    `,this.whiteDiv=this.container.querySelector(".eval-bar-white"),this.greyDiv=this.container.querySelector(".eval-bar-grey"),this.blackDiv=this.container.querySelector(".eval-bar-black"),this.scoreDivWhite=this.container.querySelector(".eval-bar-score.white"),this.scoreDivGrey=this.container.querySelector(".eval-bar-score.grey"),this.scoreDivBlack=this.container.querySelector(".eval-bar-score.black")}reset(){this.scoreType===1?(this.whiteDiv.style.height="50%",this.greyDiv.style.display="none",this.blackDiv.style.height="50%"):(this.whiteDiv.style.height="33%",this.greyDiv.style.height="34%",this.blackDiv.style.height="33%"),this.scoreDivWhite.style.display="none",this.scoreDivGrey.style.display="none",this.scoreDivBlack.style.display="none"}setHeight(e){this.container.style.height=e}updateEvaluation(e,t,s=!1){function i(r,n){let o=r,d={val:n.val,w:n.l,d:n.d,l:n.w};return o==="Mate"?o="Mated":o==="Mated"?o="Mate":d.val=-d.val,[o,d]}s&&([e,t]=i(e,t)),this.scoreType===1?this.updateEvalCP(e,t):this.updateEvalWDL(t)}updateEvalCP(e,t){var s=.5,i="",r=!0,n=!1;if(e==="Cp"){let o=function(E){return E===0?0:E<7?-(.322495*Math.pow(E,2))+7.26599*E+4.11834:8*E/145+40.55862068965517};const d=t.val/100,p=o(Math.abs(d)),g=Math.min(50-this.minRoomPercent,p);Math.abs(d)<.1?i="0.0":i=(d>0?"+":"")+d.toFixed(1),s=(50+(d>0?g:-g))/100,r=!0,n=!1}else e==="Mate"?(s=1,i=`M${t.val}`,r=!0,n=!1):e==="Mated"&&(s=0,i=`-M${t.val}`,r=!1,n=!0);this.whiteDiv.style.height=`${s*100}%`,this.blackDiv.style.height=`${(1-s)*100}%`,this.scoreDivWhite.style.display=r?"block":"none",this.scoreDivBlack.style.display=n?"block":"none",r&&(this.scoreDivWhite.textContent=i,this.scoreDivWhite.style.top="2px"),n&&(this.scoreDivBlack.textContent=i,this.scoreDivBlack.style.bottom="2px")}updateEvalWDL(e){const[t,s,i]=[e.w/10,e.d/10,e.l/10];this.whiteDiv.style.height=`${t}%`,this.greyDiv.style.height=`${s}%`,this.blackDiv.style.height=`${i}%`;const r=t>this.minRoomPercent,n=s>this.minRoomPercent,o=i>this.minRoomPercent;if(this.scoreDivWhite.style.display=r?"block":"none",this.scoreDivGrey.style.display=n?"block":"none",this.scoreDivBlack.style.display=o?"block":"none",r){const d=t===100?"100":t.toFixed(1);this.scoreDivWhite.textContent=`${d}%`}if(n){const d=s===100?"100":s.toFixed(1);this.scoreDivGrey.textContent=`${d}%`}if(o){const d=i===100?"100":i.toFixed(1);this.scoreDivBlack.textContent=`${d}%`}}}const pt=new URL("/assets/carp_wasm_bg-DIWw2oFb.wasm",import.meta.url).toString(),Cs=WebAssembly.compileStreaming?WebAssembly.compileStreaming(fetch(pt)):fetch(pt).then(h=>h.arrayBuffer()).then(WebAssembly.compile);function qs(h){return h!==null?{comment:h,variations:[]}:{variations:[]}}function Is(h,e,t,s,i){const r={move:h,variations:i};return e&&(r.suffix=e),t&&(r.nag=t),s!==null&&(r.comment=s),r}function Ts(...h){const[e,...t]=h;let s=e;for(const i of t)i!==null&&(s.variations=[i,...i.variations],i.variations=[],s=i);return e}function xs(h,e){if(e.marker&&e.marker.comment){let t=e.root;for(;;){const s=t.variations[0];if(!s){t.comment=e.marker.comment;break}t=s}}return{headers:h,root:e.root,result:(e.marker&&e.marker.result)??void 0}}function Ms(h,e){function t(){this.constructor=h}t.prototype=e.prototype,h.prototype=new t}function re(h,e,t,s){var i=Error.call(this,h);return Object.setPrototypeOf&&Object.setPrototypeOf(i,re.prototype),i.expected=e,i.found=t,i.location=s,i.name="SyntaxError",i}Ms(re,Error);function qe(h,e,t){return t=t||" ",h.length>e?h:(e-=h.length,t+=t.repeat(e),h+t.slice(0,e))}re.prototype.format=function(h){var e="Error: "+this.message;if(this.location){var t=null,s;for(s=0;s<h.length;s++)if(h[s].source===this.location.source){t=h[s].text.split(/\r\n|\n|\r/g);break}var i=this.location.start,r=this.location.source&&typeof this.location.source.offset=="function"?this.location.source.offset(i):i,n=this.location.source+":"+r.line+":"+r.column;if(t){var o=this.location.end,d=qe("",r.line.toString().length," "),p=t[i.line-1],g=i.line===o.line?o.column:p.length+1,E=g-i.column||1;e+=`
 --> `+n+`
`+d+` |
`+r.line+" | "+p+`
`+d+" | "+qe("",i.column-1," ")+qe("",E,"^")}else e+=`
 at `+n}return e};re.buildMessage=function(h,e){var t={literal:function(p){return'"'+i(p.text)+'"'},class:function(p){var g=p.parts.map(function(E){return Array.isArray(E)?r(E[0])+"-"+r(E[1]):r(E)});return"["+(p.inverted?"^":"")+g.join("")+"]"},any:function(){return"any character"},end:function(){return"end of input"},other:function(p){return p.description}};function s(p){return p.charCodeAt(0).toString(16).toUpperCase()}function i(p){return p.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(g){return"\\x0"+s(g)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(g){return"\\x"+s(g)})}function r(p){return p.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(g){return"\\x0"+s(g)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(g){return"\\x"+s(g)})}function n(p){return t[p.type](p)}function o(p){var g=p.map(n),E,v;if(g.sort(),g.length>0){for(E=1,v=1;E<g.length;E++)g[E-1]!==g[E]&&(g[v]=g[E],v++);g.length=v}switch(g.length){case 1:return g[0];case 2:return g[0]+" or "+g[1];default:return g.slice(0,-1).join(", ")+", or "+g[g.length-1]}}function d(p){return p?'"'+i(p)+'"':"end of input"}return"Expected "+o(h)+" but "+d(e)+" found."};function As(h,e){e=e!==void 0?e:{};var t={},s=e.grammarSource,i={pgn:ot},r=ot,n="[",o='"',d="]",p=".",g="O-O-O",E="O-O",v="0-0-0",k="0-0",C="$",I="{",z="}",_e=";",Se="(",Et=")",Fe="1-0",Ge="0-1",Ue="1/2-1/2",Pt="*",Ee=/^[a-zA-Z]/,Ke=/^[^"]/,ue=/^[0-9]/,We=/^[.]/,He=/^[a-zA-Z1-8\-=]/,Ct=/^[+#]/,ze=/^[!?]/,Ve=/^[^}]/,je=/^[^\r\n]/,Ye=/^[ \t\r\n]/,qt=G("tag pair"),It=L("[",!1),Qe=L('"',!1),Tt=L("]",!1),xt=G("tag name"),Pe=W([["a","z"],["A","Z"]],!1,!1),Mt=G("tag value"),Xe=W(['"'],!0,!1),At=G("move number"),de=W([["0","9"]],!1,!1),Lt=L(".",!1),Ze=W(["."],!1,!1),Dt=G("standard algebraic notation"),Ot=L("O-O-O",!1),$t=L("O-O",!1),Bt=L("0-0-0",!1),Nt=L("0-0",!1),Je=W([["a","z"],["A","Z"],["1","8"],"-","="],!1,!1),Rt=W(["+","#"],!1,!1),Ft=G("suffix annotation"),et=W(["!","?"],!1,!1),Gt=G("NAG"),Ut=L("$",!1),Kt=G("brace comment"),Wt=L("{",!1),tt=W(["}"],!0,!1),Ht=L("}",!1),zt=G("rest of line comment"),Vt=L(";",!1),st=W(["\r",`
`],!0,!1),jt=G("variation"),Yt=L("(",!1),Qt=L(")",!1),Xt=G("game termination marker"),Zt=L("1-0",!1),Jt=L("0-1",!1),es=L("1/2-1/2",!1),ts=L("*",!1),ss=G("whitespace"),it=W([" ","	","\r",`
`],!1,!1),is=function(a,c){return xs(a,c)},rs=function(a){return Object.fromEntries(a)},ns=function(a,c){return[a,c]},os=function(a,c){return{root:a,marker:c}},as=function(a,c){return Ts(qs(a),...c.flat())},hs=function(a,c,u,y,w){return Is(a,c,u,y,w)},ls=function(a){return a},cs=function(a){return a.replace(/[\r\n]+/g," ")},us=function(a){return a.trim()},ds=function(a){return a},ps=function(a,c){return{result:a,comment:c}},l=e.peg$currPos|0,te=[{line:1,column:1}],K=l,pe=e.peg$maxFailExpected||[],f=e.peg$silentFails|0,ne;if(e.startRule){if(!(e.startRule in i))throw new Error(`Can't start parsing from rule "`+e.startRule+'".');r=i[e.startRule]}function L(a,c){return{type:"literal",text:a,ignoreCase:c}}function W(a,c,u){return{type:"class",parts:a,inverted:c,ignoreCase:u}}function fs(){return{type:"end"}}function G(a){return{type:"other",description:a}}function rt(a){var c=te[a],u;if(c)return c;if(a>=te.length)u=te.length-1;else for(u=a;!te[--u];);for(c=te[u],c={line:c.line,column:c.column};u<a;)h.charCodeAt(u)===10?(c.line++,c.column=1):c.column++,u++;return te[a]=c,c}function nt(a,c,u){var y=rt(a),w=rt(c),q={source:s,start:{offset:a,line:y.line,column:y.column},end:{offset:c,line:w.line,column:w.column}};return q}function b(a){l<K||(l>K&&(K=l,pe=[]),pe.push(a))}function gs(a,c,u){return new re(re.buildMessage(a,c),a,c,u)}function ot(){var a,c,u;return a=l,c=vs(),u=ys(),a=is(c,u),a}function vs(){var a,c,u;for(a=l,c=[],u=at();u!==t;)c.push(u),u=at();return u=B(),a=rs(c),a}function at(){var a,c,u,y,w,q,Z;return f++,a=l,B(),h.charCodeAt(l)===91?(c=n,l++):(c=t,f===0&&b(It)),c!==t?(B(),u=ms(),u!==t?(B(),h.charCodeAt(l)===34?(y=o,l++):(y=t,f===0&&b(Qe)),y!==t?(w=bs(),h.charCodeAt(l)===34?(q=o,l++):(q=t,f===0&&b(Qe)),q!==t?(B(),h.charCodeAt(l)===93?(Z=d,l++):(Z=t,f===0&&b(Tt)),Z!==t?a=ns(u,w):(l=a,a=t)):(l=a,a=t)):(l=a,a=t)):(l=a,a=t)):(l=a,a=t),f--,a===t&&f===0&&b(qt),a}function ms(){var a,c,u;if(f++,a=l,c=[],u=h.charAt(l),Ee.test(u)?l++:(u=t,f===0&&b(Pe)),u!==t)for(;u!==t;)c.push(u),u=h.charAt(l),Ee.test(u)?l++:(u=t,f===0&&b(Pe));else c=t;return c!==t?a=h.substring(a,l):a=c,f--,a===t&&(c=t,f===0&&b(xt)),a}function bs(){var a,c,u;for(f++,a=l,c=[],u=h.charAt(l),Ke.test(u)?l++:(u=t,f===0&&b(Xe));u!==t;)c.push(u),u=h.charAt(l),Ke.test(u)?l++:(u=t,f===0&&b(Xe));return a=h.substring(a,l),f--,c=t,f===0&&b(Mt),a}function ys(){var a,c,u;return a=l,c=ht(),B(),u=Ps(),u===t&&(u=null),B(),a=os(c,u),a}function ht(){var a,c,u,y;for(a=l,c=Ce(),c===t&&(c=null),u=[],y=lt();y!==t;)u.push(y),y=lt();return a=as(c,u),a}function lt(){var a,c,u,y,w,q,Z,fe;if(a=l,B(),ws(),B(),c=ks(),c!==t){for(u=_s(),u===t&&(u=null),y=[],w=ct();w!==t;)y.push(w),w=ct();for(w=B(),q=Ce(),q===t&&(q=null),Z=[],fe=ut();fe!==t;)Z.push(fe),fe=ut();a=hs(c,u,y,q,Z)}else l=a,a=t;return a}function ws(){var a,c,u,y,w,q;for(f++,a=l,c=[],u=h.charAt(l),ue.test(u)?l++:(u=t,f===0&&b(de));u!==t;)c.push(u),u=h.charAt(l),ue.test(u)?l++:(u=t,f===0&&b(de));if(h.charCodeAt(l)===46?(u=p,l++):(u=t,f===0&&b(Lt)),u!==t){for(y=B(),w=[],q=h.charAt(l),We.test(q)?l++:(q=t,f===0&&b(Ze));q!==t;)w.push(q),q=h.charAt(l),We.test(q)?l++:(q=t,f===0&&b(Ze));c=[c,u,y,w],a=c}else l=a,a=t;return f--,a===t&&(c=t,f===0&&b(At)),a}function ks(){var a,c,u,y,w,q;if(f++,a=l,c=l,h.substr(l,5)===g?(u=g,l+=5):(u=t,f===0&&b(Ot)),u===t&&(h.substr(l,3)===E?(u=E,l+=3):(u=t,f===0&&b($t)),u===t&&(h.substr(l,5)===v?(u=v,l+=5):(u=t,f===0&&b(Bt)),u===t&&(h.substr(l,3)===k?(u=k,l+=3):(u=t,f===0&&b(Nt)),u===t))))if(u=l,y=h.charAt(l),Ee.test(y)?l++:(y=t,f===0&&b(Pe)),y!==t){if(w=[],q=h.charAt(l),He.test(q)?l++:(q=t,f===0&&b(Je)),q!==t)for(;q!==t;)w.push(q),q=h.charAt(l),He.test(q)?l++:(q=t,f===0&&b(Je));else w=t;w!==t?(y=[y,w],u=y):(l=u,u=t)}else l=u,u=t;return u!==t?(y=h.charAt(l),Ct.test(y)?l++:(y=t,f===0&&b(Rt)),y===t&&(y=null),u=[u,y],c=u):(l=c,c=t),c!==t?a=h.substring(a,l):a=c,f--,a===t&&(c=t,f===0&&b(Dt)),a}function _s(){var a,c,u;for(f++,a=l,c=[],u=h.charAt(l),ze.test(u)?l++:(u=t,f===0&&b(et));u!==t;)c.push(u),c.length>=2?u=t:(u=h.charAt(l),ze.test(u)?l++:(u=t,f===0&&b(et)));return c.length<1?(l=a,a=t):a=c,f--,a===t&&(c=t,f===0&&b(Ft)),a}function ct(){var a,c,u,y,w;if(f++,a=l,B(),h.charCodeAt(l)===36?(c=C,l++):(c=t,f===0&&b(Ut)),c!==t){if(u=l,y=[],w=h.charAt(l),ue.test(w)?l++:(w=t,f===0&&b(de)),w!==t)for(;w!==t;)y.push(w),w=h.charAt(l),ue.test(w)?l++:(w=t,f===0&&b(de));else y=t;y!==t?u=h.substring(u,l):u=y,u!==t?a=ls(u):(l=a,a=t)}else l=a,a=t;return f--,a===t&&f===0&&b(Gt),a}function Ce(){var a;return a=Ss(),a===t&&(a=Es()),a}function Ss(){var a,c,u,y,w;if(f++,a=l,h.charCodeAt(l)===123?(c=I,l++):(c=t,f===0&&b(Wt)),c!==t){for(u=l,y=[],w=h.charAt(l),Ve.test(w)?l++:(w=t,f===0&&b(tt));w!==t;)y.push(w),w=h.charAt(l),Ve.test(w)?l++:(w=t,f===0&&b(tt));u=h.substring(u,l),h.charCodeAt(l)===125?(y=z,l++):(y=t,f===0&&b(Ht)),y!==t?a=cs(u):(l=a,a=t)}else l=a,a=t;return f--,a===t&&(c=t,f===0&&b(Kt)),a}function Es(){var a,c,u,y,w;if(f++,a=l,h.charCodeAt(l)===59?(c=_e,l++):(c=t,f===0&&b(Vt)),c!==t){for(u=l,y=[],w=h.charAt(l),je.test(w)?l++:(w=t,f===0&&b(st));w!==t;)y.push(w),w=h.charAt(l),je.test(w)?l++:(w=t,f===0&&b(st));u=h.substring(u,l),a=us(u)}else l=a,a=t;return f--,a===t&&(c=t,f===0&&b(zt)),a}function ut(){var a,c,u,y;return f++,a=l,B(),h.charCodeAt(l)===40?(c=Se,l++):(c=t,f===0&&b(Yt)),c!==t?(u=ht(),u!==t?(B(),h.charCodeAt(l)===41?(y=Et,l++):(y=t,f===0&&b(Qt)),y!==t?a=ds(u):(l=a,a=t)):(l=a,a=t)):(l=a,a=t),f--,a===t&&f===0&&b(jt),a}function Ps(){var a,c,u;return f++,a=l,h.substr(l,3)===Fe?(c=Fe,l+=3):(c=t,f===0&&b(Zt)),c===t&&(h.substr(l,3)===Ge?(c=Ge,l+=3):(c=t,f===0&&b(Jt)),c===t&&(h.substr(l,7)===Ue?(c=Ue,l+=7):(c=t,f===0&&b(es)),c===t&&(h.charCodeAt(l)===42?(c=Pt,l++):(c=t,f===0&&b(ts))))),c!==t?(B(),u=Ce(),u===t&&(u=null),a=ps(c,u)):(l=a,a=t),f--,a===t&&(c=t,f===0&&b(Xt)),a}function B(){var a,c;for(f++,a=[],c=h.charAt(l),Ye.test(c)?l++:(c=t,f===0&&b(it));c!==t;)a.push(c),c=h.charAt(l),Ye.test(c)?l++:(c=t,f===0&&b(it));return f--,c=t,f===0&&b(ss),a}if(ne=r(),e.peg$library)return{peg$result:ne,peg$currPos:l,peg$FAILED:t,peg$maxFailExpected:pe,peg$maxFailPos:K};if(ne!==t&&l===h.length)return ne;throw ne!==t&&l<h.length&&b(fs()),gs(pe,K<h.length?h.charAt(K):null,K<h.length?nt(K,K+1):nt(K,K))}/**
 * @license
 * Copyright (c) 2025, Jeff Hlywa (jhlywa@gmail.com)
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are met:
 *
 * 1. Redistributions of source code must retain the above copyright notice,
 *    this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright notice,
 *    this list of conditions and the following disclaimer in the documentation
 *    and/or other materials provided with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
 * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE
 * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
 * POSSIBILITY OF SUCH DAMAGE.
 */const be=0xffffffffffffffffn;function Ie(h,e){return(h<<e|h>>64n-e)&0xffffffffffffffffn}function ft(h,e){return h*e&be}function Ls(h){return function(){let e=BigInt(h&be),t=BigInt(h>>64n&be);const s=ft(Ie(ft(e,5n),7n),9n);return t^=e,e=(Ie(e,24n)^t^t<<16n)&be,t=Ie(t,37n),h=t<<64n|e,s}}const ke=Ls(0xa187eb39cdcaed8f31c4b365b102e01en),Ds=Array.from({length:2},()=>Array.from({length:6},()=>Array.from({length:128},()=>ke()))),Os=Array.from({length:8},()=>ke()),$s=Array.from({length:16},()=>ke()),Te=ke(),$="w",N="b",M="p",Be="n",ye="b",le="r",Q="q",A="k",xe="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1";class ge{color;from;to;piece;captured;promotion;flags;san;lan;before;after;constructor(e,t){const{color:s,piece:i,from:r,to:n,flags:o,captured:d,promotion:p}=t,g=D(r),E=D(n);this.color=s,this.piece=i,this.from=g,this.to=E,this.san=e._moveToSan(t,e._moves({legal:!0})),this.lan=g+E,this.before=e.fen(),e._makeMove(t),this.after=e.fen(),e._undoMove(),this.flags="";for(const v in S)S[v]&o&&(this.flags+=J[v]);d&&(this.captured=d),p&&(this.promotion=p,this.lan+=p)}isCapture(){return this.flags.indexOf(J.CAPTURE)>-1}isPromotion(){return this.flags.indexOf(J.PROMOTION)>-1}isEnPassant(){return this.flags.indexOf(J.EP_CAPTURE)>-1}isKingsideCastle(){return this.flags.indexOf(J.KSIDE_CASTLE)>-1}isQueensideCastle(){return this.flags.indexOf(J.QSIDE_CASTLE)>-1}isBigPawn(){return this.flags.indexOf(J.BIG_PAWN)>-1}}const O=-1,J={NORMAL:"n",CAPTURE:"c",BIG_PAWN:"b",EP_CAPTURE:"e",PROMOTION:"p",KSIDE_CASTLE:"k",QSIDE_CASTLE:"q",NULL_MOVE:"-"},S={NORMAL:1,CAPTURE:2,BIG_PAWN:4,EP_CAPTURE:8,PROMOTION:16,KSIDE_CASTLE:32,QSIDE_CASTLE:64,NULL_MOVE:128},Ne={Event:"?",Site:"?",Date:"????.??.??",Round:"?",White:"?",Black:"?",Result:"*"},Bs={WhiteTitle:null,BlackTitle:null,WhiteElo:null,BlackElo:null,WhiteUSCF:null,BlackUSCF:null,WhiteNA:null,BlackNA:null,WhiteType:null,BlackType:null,EventDate:null,EventSponsor:null,Section:null,Stage:null,Board:null,Opening:null,Variation:null,SubVariation:null,ECO:null,NIC:null,Time:null,UTCTime:null,UTCDate:null,TimeControl:null,SetUp:null,FEN:null,Termination:null,Annotator:null,Mode:null,PlyCount:null},Ns={...Ne,...Bs},_={a8:0,b8:1,c8:2,d8:3,e8:4,f8:5,g8:6,h8:7,a7:16,b7:17,c7:18,d7:19,e7:20,f7:21,g7:22,h7:23,a6:32,b6:33,c6:34,d6:35,e6:36,f6:37,g6:38,h6:39,a5:48,b5:49,c5:50,d5:51,e5:52,f5:53,g5:54,h5:55,a4:64,b4:65,c4:66,d4:67,e4:68,f4:69,g4:70,h4:71,a3:80,b3:81,c3:82,d3:83,e3:84,f3:85,g3:86,h3:87,a2:96,b2:97,c2:98,d2:99,e2:100,f2:101,g2:102,h2:103,a1:112,b1:113,c1:114,d1:115,e1:116,f1:117,g1:118,h1:119},Me={b:[16,32,17,15],w:[-16,-32,-17,-15]},gt={n:[-18,-33,-31,-14,18,33,31,14],b:[-17,-15,17,15],r:[-16,1,16,-1],q:[-17,-16,-15,1,17,16,15,-1],k:[-17,-16,-15,1,17,16,15,-1]},Rs=[20,0,0,0,0,0,0,24,0,0,0,0,0,0,20,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,24,24,24,24,24,24,56,0,56,24,24,24,24,24,24,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,20,0,0,0,0,0,0,24,0,0,0,0,0,0,20],Fs=[17,0,0,0,0,0,0,16,0,0,0,0,0,0,15,0,0,17,0,0,0,0,0,16,0,0,0,0,0,15,0,0,0,0,17,0,0,0,0,16,0,0,0,0,15,0,0,0,0,0,0,17,0,0,0,16,0,0,0,15,0,0,0,0,0,0,0,0,17,0,0,16,0,0,15,0,0,0,0,0,0,0,0,0,0,17,0,16,0,15,0,0,0,0,0,0,0,0,0,0,0,0,17,16,15,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,-15,-16,-17,0,0,0,0,0,0,0,0,0,0,0,0,-15,0,-16,0,-17,0,0,0,0,0,0,0,0,0,0,-15,0,0,-16,0,0,-17,0,0,0,0,0,0,0,0,-15,0,0,0,-16,0,0,0,-17,0,0,0,0,0,0,-15,0,0,0,0,-16,0,0,0,0,-17,0,0,0,0,-15,0,0,0,0,0,-16,0,0,0,0,0,-17,0,0,-15,0,0,0,0,0,0,-16,0,0,0,0,0,0,-17],Gs={p:1,n:2,b:4,r:8,q:16,k:32},Us="pnbrqkPNBRQK",vt=[Be,ye,le,Q],Ks=7,Ws=6,Hs=1,zs=0,ve={[A]:S.KSIDE_CASTLE,[Q]:S.QSIDE_CASTLE},V={w:[{square:_.a1,flag:S.QSIDE_CASTLE},{square:_.h1,flag:S.KSIDE_CASTLE}],b:[{square:_.a8,flag:S.QSIDE_CASTLE},{square:_.h8,flag:S.KSIDE_CASTLE}]},Vs={b:Hs,w:Ws},Ae="--";function ee(h){return h>>4}function ce(h){return h&15}function _t(h){return"0123456789".indexOf(h)!==-1}function D(h){const e=ce(h),t=ee(h);return"abcdefgh".substring(e,e+1)+"87654321".substring(t,t+1)}function oe(h){return h===$?N:$}function St(h){const e=h.split(/\s+/);if(e.length!==6)return{ok:!1,error:"Invalid FEN: must contain six space-delimited fields"};const t=parseInt(e[5],10);if(isNaN(t)||t<=0)return{ok:!1,error:"Invalid FEN: move number must be a positive integer"};const s=parseInt(e[4],10);if(isNaN(s)||s<0)return{ok:!1,error:"Invalid FEN: half move counter number must be a non-negative integer"};if(!/^(-|[abcdefgh][36])$/.test(e[3]))return{ok:!1,error:"Invalid FEN: en-passant square is invalid"};if(/[^kKqQ-]/.test(e[2]))return{ok:!1,error:"Invalid FEN: castling availability is invalid"};if(!/^(w|b)$/.test(e[1]))return{ok:!1,error:"Invalid FEN: side-to-move is invalid"};const i=e[0].split("/");if(i.length!==8)return{ok:!1,error:"Invalid FEN: piece data does not contain 8 '/'-delimited rows"};for(let n=0;n<i.length;n++){let o=0,d=!1;for(let p=0;p<i[n].length;p++)if(_t(i[n][p])){if(d)return{ok:!1,error:"Invalid FEN: piece data is invalid (consecutive number)"};o+=parseInt(i[n][p],10),d=!0}else{if(!/^[prnbqkPRNBQK]$/.test(i[n][p]))return{ok:!1,error:"Invalid FEN: piece data is invalid (invalid piece)"};o+=1,d=!1}if(o!==8)return{ok:!1,error:"Invalid FEN: piece data is invalid (too many squares in rank)"}}if(e[3][1]=="3"&&e[1]=="w"||e[3][1]=="6"&&e[1]=="b")return{ok:!1,error:"Invalid FEN: illegal en-passant square"};const r=[{color:"white",regex:/K/g},{color:"black",regex:/k/g}];for(const{color:n,regex:o}of r){if(!o.test(e[0]))return{ok:!1,error:`Invalid FEN: missing ${n} king`};if((e[0].match(o)||[]).length>1)return{ok:!1,error:`Invalid FEN: too many ${n} kings`}}return Array.from(i[0]+i[7]).some(n=>n.toUpperCase()==="P")?{ok:!1,error:"Invalid FEN: some pawns are on the edge rows"}:{ok:!0}}function js(h,e){const t=h.from,s=h.to,i=h.piece;let r=0,n=0,o=0;for(let d=0,p=e.length;d<p;d++){const g=e[d].from,E=e[d].to,v=e[d].piece;i===v&&t!==g&&s===E&&(r++,ee(t)===ee(g)&&n++,ce(t)===ce(g)&&o++)}return r>0?n>0&&o>0?D(t):o>0?D(t).charAt(1):D(t).charAt(0):""}function j(h,e,t,s,i,r=void 0,n=S.NORMAL){const o=ee(s);if(i===M&&(o===Ks||o===zs))for(let d=0;d<vt.length;d++){const p=vt[d];h.push({color:e,from:t,to:s,piece:i,captured:r,promotion:p,flags:n|S.PROMOTION})}else h.push({color:e,from:t,to:s,piece:i,captured:r,flags:n})}function mt(h){let e=h.charAt(0);return e>="a"&&e<="h"?h.match(/[a-h]\d.*[a-h]\d/)?void 0:M:(e=e.toLowerCase(),e==="o"?A:e)}function Le(h){return h.replace(/=/,"").replace(/[+#]?[?!]*$/,"")}class bt{_board=new Array(128);_turn=$;_header={};_kings={w:O,b:O};_epSquare=-1;_halfMoves=0;_moveNumber=0;_history=[];_comments={};_castling={w:0,b:0};_hash=0n;_positionCount=new Map;constructor(e=xe,{skipValidation:t=!1}={}){this.load(e,{skipValidation:t})}clear({preserveHeaders:e=!1}={}){this._board=new Array(128),this._kings={w:O,b:O},this._turn=$,this._castling={w:0,b:0},this._epSquare=O,this._halfMoves=0,this._moveNumber=1,this._history=[],this._comments={},this._header=e?this._header:{...Ns},this._hash=this._computeHash(),this._positionCount=new Map,this._header.SetUp=null,this._header.FEN=null}load(e,{skipValidation:t=!1,preserveHeaders:s=!1}={}){let i=e.split(/\s+/);if(i.length>=2&&i.length<6){const o=["-","-","0","1"];e=i.concat(o.slice(-(6-i.length))).join(" ")}if(i=e.split(/\s+/),!t){const{ok:o,error:d}=St(e);if(!o)throw new Error(d)}const r=i[0];let n=0;this.clear({preserveHeaders:s});for(let o=0;o<r.length;o++){const d=r.charAt(o);if(d==="/")n+=8;else if(_t(d))n+=parseInt(d,10);else{const p=d<"a"?$:N;this._put({type:d.toLowerCase(),color:p},D(n)),n++}}this._turn=i[1],i[2].indexOf("K")>-1&&(this._castling.w|=S.KSIDE_CASTLE),i[2].indexOf("Q")>-1&&(this._castling.w|=S.QSIDE_CASTLE),i[2].indexOf("k")>-1&&(this._castling.b|=S.KSIDE_CASTLE),i[2].indexOf("q")>-1&&(this._castling.b|=S.QSIDE_CASTLE),this._epSquare=i[3]==="-"?O:_[i[3]],this._halfMoves=parseInt(i[4],10),this._moveNumber=parseInt(i[5],10),this._hash=this._computeHash(),this._updateSetup(e),this._incPositionCount()}fen({forceEnpassantSquare:e=!1}={}){let t=0,s="";for(let n=_.a8;n<=_.h1;n++){if(this._board[n]){t>0&&(s+=t,t=0);const{color:o,type:d}=this._board[n];s+=o===$?d.toUpperCase():d.toLowerCase()}else t++;n+1&136&&(t>0&&(s+=t),n!==_.h1&&(s+="/"),t=0,n+=8)}let i="";this._castling[$]&S.KSIDE_CASTLE&&(i+="K"),this._castling[$]&S.QSIDE_CASTLE&&(i+="Q"),this._castling[N]&S.KSIDE_CASTLE&&(i+="k"),this._castling[N]&S.QSIDE_CASTLE&&(i+="q"),i=i||"-";let r="-";if(this._epSquare!==O)if(e)r=D(this._epSquare);else{const n=this._epSquare+(this._turn===$?16:-16),o=[n+1,n-1];for(const d of o){if(d&136)continue;const p=this._turn;if(this._board[d]?.color===p&&this._board[d]?.type===M){this._makeMove({color:p,from:d,to:this._epSquare,piece:M,captured:M,flags:S.EP_CAPTURE});const g=!this._isKingAttacked(p);if(this._undoMove(),g){r=D(this._epSquare);break}}}}return[s,this._turn,i,r,this._halfMoves,this._moveNumber].join(" ")}_pieceKey(e){if(!this._board[e])return 0n;const{color:t,type:s}=this._board[e],i={w:0,b:1}[t],r={p:0,n:1,b:2,r:3,q:4,k:5}[s];return Ds[i][r][e]}_epKey(){return this._epSquare===O?0n:Os[this._epSquare&7]}_castlingKey(){const e=this._castling.w>>5|this._castling.b>>3;return $s[e]}_computeHash(){let e=0n;for(let t=_.a8;t<=_.h1;t++){if(t&136){t+=7;continue}this._board[t]&&(e^=this._pieceKey(t))}return e^=this._epKey(),e^=this._castlingKey(),this._turn==="b"&&(e^=Te),e}_updateSetup(e){this._history.length>0||(e!==xe?(this._header.SetUp="1",this._header.FEN=e):(this._header.SetUp=null,this._header.FEN=null))}reset(){this.load(xe)}get(e){return this._board[_[e]]}findPiece(e){const t=[];for(let s=_.a8;s<=_.h1;s++){if(s&136){s+=7;continue}!this._board[s]||this._board[s]?.color!==e.color||this._board[s].color===e.color&&this._board[s].type===e.type&&t.push(D(s))}return t}put({type:e,color:t},s){return this._put({type:e,color:t},s)?(this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),!0):!1}_set(e,t){this._hash^=this._pieceKey(e),this._board[e]=t,this._hash^=this._pieceKey(e)}_put({type:e,color:t},s){if(Us.indexOf(e.toLowerCase())===-1||!(s in _))return!1;const i=_[s];if(e==A&&!(this._kings[t]==O||this._kings[t]==i))return!1;const r=this._board[i];return r&&r.type===A&&(this._kings[r.color]=O),this._set(i,{type:e,color:t}),e===A&&(this._kings[t]=i),!0}_clear(e){this._hash^=this._pieceKey(e),delete this._board[e]}remove(e){const t=this.get(e);return this._clear(_[e]),t&&t.type===A&&(this._kings[t.color]=O),this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),t}_updateCastlingRights(){this._hash^=this._castlingKey();const e=this._board[_.e1]?.type===A&&this._board[_.e1]?.color===$,t=this._board[_.e8]?.type===A&&this._board[_.e8]?.color===N;(!e||this._board[_.a1]?.type!==le||this._board[_.a1]?.color!==$)&&(this._castling.w&=-65),(!e||this._board[_.h1]?.type!==le||this._board[_.h1]?.color!==$)&&(this._castling.w&=-33),(!t||this._board[_.a8]?.type!==le||this._board[_.a8]?.color!==N)&&(this._castling.b&=-65),(!t||this._board[_.h8]?.type!==le||this._board[_.h8]?.color!==N)&&(this._castling.b&=-33),this._hash^=this._castlingKey()}_updateEnPassantSquare(){if(this._epSquare===O)return;const e=this._epSquare+(this._turn===$?-16:16),t=this._epSquare+(this._turn===$?16:-16),s=[t+1,t-1];if(this._board[e]!==null||this._board[this._epSquare]!==null||this._board[t]?.color!==oe(this._turn)||this._board[t]?.type!==M){this._hash^=this._epKey(),this._epSquare=O;return}const i=r=>!(r&136)&&this._board[r]?.color===this._turn&&this._board[r]?.type===M;s.some(i)||(this._hash^=this._epKey(),this._epSquare=O)}_attacked(e,t,s){const i=[];for(let r=_.a8;r<=_.h1;r++){if(r&136){r+=7;continue}if(this._board[r]===void 0||this._board[r].color!==e)continue;const n=this._board[r],o=r-t;if(o===0)continue;const d=o+119;if(Rs[d]&Gs[n.type]){if(n.type===M){if(o>0&&n.color===$||o<=0&&n.color===N)if(s)i.push(D(r));else return!0;continue}if(n.type==="n"||n.type==="k")if(s){i.push(D(r));continue}else return!0;const p=Fs[d];let g=r+p,E=!1;for(;g!==t;){if(this._board[g]!=null){E=!0;break}g+=p}if(!E)if(s){i.push(D(r));continue}else return!0}}return s?i:!1}attackers(e,t){return t?this._attacked(t,_[e],!0):this._attacked(this._turn,_[e],!0)}_isKingAttacked(e){const t=this._kings[e];return t===-1?!1:this._attacked(oe(e),t)}hash(){return this._hash.toString(16)}isAttacked(e,t){return this._attacked(t,_[e])}isCheck(){return this._isKingAttacked(this._turn)}inCheck(){return this.isCheck()}isCheckmate(){return this.isCheck()&&this._moves().length===0}isStalemate(){return!this.isCheck()&&this._moves().length===0}isInsufficientMaterial(){const e={b:0,n:0,r:0,q:0,k:0,p:0},t=[];let s=0,i=0;for(let r=_.a8;r<=_.h1;r++){if(i=(i+1)%2,r&136){r+=7;continue}const n=this._board[r];n&&(e[n.type]=n.type in e?e[n.type]+1:1,n.type===ye&&t.push(i),s++)}if(s===2)return!0;if(s===3&&(e[ye]===1||e[Be]===1))return!0;if(s===e[ye]+2){let r=0;const n=t.length;for(let o=0;o<n;o++)r+=t[o];if(r===0||r===n)return!0}return!1}isThreefoldRepetition(){return this._getPositionCount(this._hash)>=3}isDrawByFiftyMoves(){return this._halfMoves>=100}isDraw(){return this.isDrawByFiftyMoves()||this.isStalemate()||this.isInsufficientMaterial()||this.isThreefoldRepetition()}isGameOver(){return this.isCheckmate()||this.isDraw()}moves({verbose:e=!1,square:t=void 0,piece:s=void 0}={}){const i=this._moves({square:t,piece:s});return e?i.map(r=>new ge(this,r)):i.map(r=>this._moveToSan(r,i))}_moves({legal:e=!0,piece:t=void 0,square:s=void 0}={}){const i=s?s.toLowerCase():void 0,r=t?.toLowerCase(),n=[],o=this._turn,d=oe(o);let p=_.a8,g=_.h1,E=!1;if(i)if(i in _)p=g=_[i],E=!0;else return[];for(let k=p;k<=g;k++){if(k&136){k+=7;continue}if(!this._board[k]||this._board[k].color===d)continue;const{type:C}=this._board[k];let I;if(C===M){if(r&&r!==C)continue;I=k+Me[o][0],this._board[I]||(j(n,o,k,I,M),I=k+Me[o][1],Vs[o]===ee(k)&&!this._board[I]&&j(n,o,k,I,M,void 0,S.BIG_PAWN));for(let z=2;z<4;z++)I=k+Me[o][z],!(I&136)&&(this._board[I]?.color===d?j(n,o,k,I,M,this._board[I].type,S.CAPTURE):I===this._epSquare&&j(n,o,k,I,M,M,S.EP_CAPTURE))}else{if(r&&r!==C)continue;for(let z=0,_e=gt[C].length;z<_e;z++){const Se=gt[C][z];for(I=k;I+=Se,!(I&136);){if(!this._board[I])j(n,o,k,I,C);else{if(this._board[I].color===o)break;j(n,o,k,I,C,this._board[I].type,S.CAPTURE);break}if(C===Be||C===A)break}}}}if((r===void 0||r===A)&&(!E||g===this._kings[o])){if(this._castling[o]&S.KSIDE_CASTLE){const k=this._kings[o],C=k+2;!this._board[k+1]&&!this._board[C]&&!this._attacked(d,this._kings[o])&&!this._attacked(d,k+1)&&!this._attacked(d,C)&&j(n,o,this._kings[o],C,A,void 0,S.KSIDE_CASTLE)}if(this._castling[o]&S.QSIDE_CASTLE){const k=this._kings[o],C=k-2;!this._board[k-1]&&!this._board[k-2]&&!this._board[k-3]&&!this._attacked(d,this._kings[o])&&!this._attacked(d,k-1)&&!this._attacked(d,C)&&j(n,o,this._kings[o],C,A,void 0,S.QSIDE_CASTLE)}}if(!e||this._kings[o]===-1)return n;const v=[];for(let k=0,C=n.length;k<C;k++)this._makeMove(n[k]),this._isKingAttacked(o)||v.push(n[k]),this._undoMove();return v}move(e,{strict:t=!1}={}){let s=null;if(typeof e=="string")s=this._moveFromSan(e,t);else if(e===null)s=this._moveFromSan(Ae,t);else if(typeof e=="object"){const r=this._moves();for(let n=0,o=r.length;n<o;n++)if(e.from===D(r[n].from)&&e.to===D(r[n].to)&&(!("promotion"in r[n])||e.promotion===r[n].promotion)){s=r[n];break}}if(!s)throw typeof e=="string"?new Error(`Invalid move: ${e}`):new Error(`Invalid move: ${JSON.stringify(e)}`);if(this.isCheck()&&s.flags&S.NULL_MOVE)throw new Error("Null move not allowed when in check");const i=new ge(this,s);return this._makeMove(s),this._incPositionCount(),i}_push(e){this._history.push({move:e,kings:{b:this._kings.b,w:this._kings.w},turn:this._turn,castling:{b:this._castling.b,w:this._castling.w},epSquare:this._epSquare,halfMoves:this._halfMoves,moveNumber:this._moveNumber})}_movePiece(e,t){this._hash^=this._pieceKey(e),this._board[t]=this._board[e],delete this._board[e],this._hash^=this._pieceKey(t)}_makeMove(e){const t=this._turn,s=oe(t);if(this._push(e),e.flags&S.NULL_MOVE){t===N&&this._moveNumber++,this._halfMoves++,this._turn=s,this._epSquare=O;return}if(this._hash^=this._epKey(),this._hash^=this._castlingKey(),e.captured&&(this._hash^=this._pieceKey(e.to)),this._movePiece(e.from,e.to),e.flags&S.EP_CAPTURE&&(this._turn===N?this._clear(e.to-16):this._clear(e.to+16)),e.promotion&&(this._clear(e.to),this._set(e.to,{type:e.promotion,color:t})),this._board[e.to].type===A){if(this._kings[t]=e.to,e.flags&S.KSIDE_CASTLE){const i=e.to-1,r=e.to+1;this._movePiece(r,i)}else if(e.flags&S.QSIDE_CASTLE){const i=e.to+1,r=e.to-2;this._movePiece(r,i)}this._castling[t]=0}if(this._castling[t]){for(let i=0,r=V[t].length;i<r;i++)if(e.from===V[t][i].square&&this._castling[t]&V[t][i].flag){this._castling[t]^=V[t][i].flag;break}}if(this._castling[s]){for(let i=0,r=V[s].length;i<r;i++)if(e.to===V[s][i].square&&this._castling[s]&V[s][i].flag){this._castling[s]^=V[s][i].flag;break}}if(this._hash^=this._castlingKey(),e.flags&S.BIG_PAWN){let i;t===N?i=e.to-16:i=e.to+16,!(e.to-1&136)&&this._board[e.to-1]?.type===M&&this._board[e.to-1]?.color===s||!(e.to+1&136)&&this._board[e.to+1]?.type===M&&this._board[e.to+1]?.color===s?(this._epSquare=i,this._hash^=this._epKey()):this._epSquare=O}else this._epSquare=O;e.piece===M?this._halfMoves=0:e.flags&(S.CAPTURE|S.EP_CAPTURE)?this._halfMoves=0:this._halfMoves++,t===N&&this._moveNumber++,this._turn=s,this._hash^=Te}undo(){const e=this._hash,t=this._undoMove();if(t){const s=new ge(this,t);return this._decPositionCount(e),s}return null}_undoMove(){const e=this._history.pop();if(e===void 0)return null;this._hash^=this._epKey(),this._hash^=this._castlingKey();const t=e.move;this._kings=e.kings,this._turn=e.turn,this._castling=e.castling,this._epSquare=e.epSquare,this._halfMoves=e.halfMoves,this._moveNumber=e.moveNumber,this._hash^=this._epKey(),this._hash^=this._castlingKey(),this._hash^=Te;const s=this._turn,i=oe(s);if(t.flags&S.NULL_MOVE)return t;if(this._movePiece(t.to,t.from),t.piece&&(this._clear(t.from),this._set(t.from,{type:t.piece,color:s})),t.captured)if(t.flags&S.EP_CAPTURE){let r;s===N?r=t.to-16:r=t.to+16,this._set(r,{type:M,color:i})}else this._set(t.to,{type:t.captured,color:i});if(t.flags&(S.KSIDE_CASTLE|S.QSIDE_CASTLE)){let r,n;t.flags&S.KSIDE_CASTLE?(r=t.to+1,n=t.to-1):(r=t.to-2,n=t.to+1),this._movePiece(n,r)}return t}pgn({newline:e=`
`,maxWidth:t=0}={}){const s=[];let i=!1;for(const v in this._header)this._header[v]&&s.push(`[${v} "${this._header[v]}"]`+e),i=!0;i&&this._history.length&&s.push(e);const r=v=>{const k=this._comments[this.fen()];if(typeof k<"u"){const C=v.length>0?" ":"";v=`${v}${C}{${k}}`}return v},n=[];for(;this._history.length>0;)n.push(this._undoMove());const o=[];let d="";for(n.length===0&&o.push(r(""));n.length>0;){d=r(d);const v=n.pop();if(!v)break;if(!this._history.length&&v.color==="b"){const k=`${this._moveNumber}. ...`;d=d?`${d} ${k}`:k}else v.color==="w"&&(d.length&&o.push(d),d=this._moveNumber+".");d=d+" "+this._moveToSan(v,this._moves({legal:!0})),this._makeMove(v)}if(d.length&&o.push(r(d)),o.push(this._header.Result||"*"),t===0)return s.join("")+o.join(" ");const p=function(){return s.length>0&&s[s.length-1]===" "?(s.pop(),!0):!1},g=function(v,k){for(const C of k.split(" "))if(C){if(v+C.length>t){for(;p();)v--;s.push(e),v=0}s.push(C),v+=C.length,s.push(" "),v++}return p()&&v--,v};let E=0;for(let v=0;v<o.length;v++){if(E+o[v].length>t&&o[v].includes("{")){E=g(E,o[v]);continue}E+o[v].length>t&&v!==0?(s[s.length-1]===" "&&s.pop(),s.push(e),E=0):v!==0&&(s.push(" "),E++),s.push(o[v]),E+=o[v].length}return s.join("")}header(...e){for(let t=0;t<e.length;t+=2)typeof e[t]=="string"&&typeof e[t+1]=="string"&&(this._header[e[t]]=e[t+1]);return this._header}setHeader(e,t){return this._header[e]=t??Ne[e]??null,this.getHeaders()}removeHeader(e){return e in this._header?(this._header[e]=Ne[e]||null,!0):!1}getHeaders(){const e={};for(const[t,s]of Object.entries(this._header))s!==null&&(e[t]=s);return e}loadPgn(e,{strict:t=!1,newlineChar:s=`\r?
`}={}){s!==`\r?
`&&(e=e.replace(new RegExp(s,"g"),`
`));const i=As(e);this.reset();const r=i.headers;let n="";for(const p in r)p.toLowerCase()==="fen"&&(n=r[p]),this.header(p,r[p]);if(!t)n&&this.load(n,{preserveHeaders:!0});else if(r.SetUp==="1"){if(!("FEN"in r))throw new Error("Invalid PGN: FEN tag must be supplied with SetUp tag");this.load(r.FEN,{preserveHeaders:!0})}let o=i.root;for(;o;){if(o.move){const p=this._moveFromSan(o.move,t);if(p==null)throw new Error(`Invalid move in PGN: ${o.move}`);this._makeMove(p),this._incPositionCount()}o.comment!==void 0&&(this._comments[this.fen()]=o.comment),o=o.variations[0]}const d=i.result;d&&Object.keys(this._header).length&&this._header.Result!==d&&this.setHeader("Result",d)}_moveToSan(e,t){let s="";if(e.flags&S.KSIDE_CASTLE)s="O-O";else if(e.flags&S.QSIDE_CASTLE)s="O-O-O";else{if(e.flags&S.NULL_MOVE)return Ae;if(e.piece!==M){const i=js(e,t);s+=e.piece.toUpperCase()+i}e.flags&(S.CAPTURE|S.EP_CAPTURE)&&(e.piece===M&&(s+=D(e.from)[0]),s+="x"),s+=D(e.to),e.promotion&&(s+="="+e.promotion.toUpperCase())}return this._makeMove(e),this.isCheck()&&(this.isCheckmate()?s+="#":s+="+"),this._undoMove(),s}_moveFromSan(e,t=!1){let s=Le(e);if(t||(s==="0-0"?s="O-O":s==="0-0-0"&&(s="O-O-O")),s==Ae)return{color:this._turn,from:0,to:0,piece:"k",flags:S.NULL_MOVE};let i=mt(s),r=this._moves({legal:!0,piece:i});for(let v=0,k=r.length;v<k;v++)if(s===Le(this._moveToSan(r[v],r)))return r[v];if(t)return null;let n,o,d,p,g,E=!1;if(o=s.match(/([pnbrqkPNBRQK])?([a-h][1-8])x?-?([a-h][1-8])([qrbnQRBN])?/),o?(n=o[1],d=o[2],p=o[3],g=o[4],d.length==1&&(E=!0)):(o=s.match(/([pnbrqkPNBRQK])?([a-h]?[1-8]?)x?-?([a-h][1-8])([qrbnQRBN])?/),o&&(n=o[1],d=o[2],p=o[3],g=o[4],d.length==1&&(E=!0))),i=mt(s),r=this._moves({legal:!0,piece:n||i}),!p)return null;for(let v=0,k=r.length;v<k;v++)if(d){if((!n||n.toLowerCase()==r[v].piece)&&_[d]==r[v].from&&_[p]==r[v].to&&(!g||g.toLowerCase()==r[v].promotion))return r[v];if(E){const C=D(r[v].from);if((!n||n.toLowerCase()==r[v].piece)&&_[p]==r[v].to&&(d==C[0]||d==C[1])&&(!g||g.toLowerCase()==r[v].promotion))return r[v]}}else if(s===Le(this._moveToSan(r[v],r)).replace("x",""))return r[v];return null}ascii(){let e=`   +------------------------+
`;for(let t=_.a8;t<=_.h1;t++){if(ce(t)===0&&(e+=" "+"87654321"[ee(t)]+" |"),this._board[t]){const s=this._board[t].type,r=this._board[t].color===$?s.toUpperCase():s.toLowerCase();e+=" "+r+" "}else e+=" . ";t+1&136&&(e+=`|
`,t+=8)}return e+=`   +------------------------+
`,e+="     a  b  c  d  e  f  g  h",e}perft(e){const t=this._moves({legal:!1});let s=0;const i=this._turn;for(let r=0,n=t.length;r<n;r++)this._makeMove(t[r]),this._isKingAttacked(i)||(e-1>0?s+=this.perft(e-1):s++),this._undoMove();return s}setTurn(e){return this._turn==e?!1:(this.move("--"),!0)}turn(){return this._turn}board(){const e=[];let t=[];for(let s=_.a8;s<=_.h1;s++)this._board[s]==null?t.push(null):t.push({square:D(s),type:this._board[s].type,color:this._board[s].color}),s+1&136&&(e.push(t),t=[],s+=8);return e}squareColor(e){if(e in _){const t=_[e];return(ee(t)+ce(t))%2===0?"light":"dark"}return null}history({verbose:e=!1}={}){const t=[],s=[];for(;this._history.length>0;)t.push(this._undoMove());for(;;){const i=t.pop();if(!i)break;e?s.push(new ge(this,i)):s.push(this._moveToSan(i,this._moves())),this._makeMove(i)}return s}_getPositionCount(e){return this._positionCount.get(e)??0}_incPositionCount(){this._positionCount.set(this._hash,(this._positionCount.get(this._hash)??0)+1)}_decPositionCount(e){const t=this._positionCount.get(e)??0;t===1?this._positionCount.delete(e):this._positionCount.set(e,t-1)}_pruneComments(){const e=[],t={},s=i=>{i in this._comments&&(t[i]=this._comments[i])};for(;this._history.length>0;)e.push(this._undoMove());for(s(this.fen());;){const i=e.pop();if(!i)break;this._makeMove(i),s(this.fen())}this._comments=t}getComment(){return this._comments[this.fen()]}setComment(e){this._comments[this.fen()]=e.replace("{","[").replace("}","]")}deleteComment(){return this.removeComment()}removeComment(){const e=this._comments[this.fen()];return delete this._comments[this.fen()],e}getComments(){return this._pruneComments(),Object.keys(this._comments).map(e=>({fen:e,comment:this._comments[e]}))}deleteComments(){return this.removeComments()}removeComments(){return this._pruneComments(),Object.keys(this._comments).map(e=>{const t=this._comments[e];return delete this._comments[e],{fen:e,comment:t}})}setCastlingRights(e,t){for(const i of[A,Q])t[i]!==void 0&&(t[i]?this._castling[e]|=ve[i]:this._castling[e]&=~ve[i]);this._updateCastlingRights();const s=this.getCastlingRights(e);return(t[A]===void 0||t[A]===s[A])&&(t[Q]===void 0||t[Q]===s[Q])}getCastlingRights(e){return{[A]:(this._castling[e]&ve[A])!==0,[Q]:(this._castling[e]&ve[Q])!==0}}moveNumber(){return this._moveNumber}}const we={empty:"8/8/8/8/8/8/8/8"};class x{constructor(e=we.empty){this.squares=new Array(64).fill(null),this.setFen(e)}setFen(e=we.empty){const t=e.replace(/^\s*/,"").replace(/\s*$/,"").split(/\/|\s/);for(let s=0;s<8;s++){const i=t[7-s].replace(/\d/g,r=>{const n=parseInt(r);let o="";for(let d=0;d<n;d++)o+="-";return o});for(let r=0;r<8;r++){const n=i.substring(r,r+1);let o=null;n!=="-"&&(n.toUpperCase()===n?o=`w${n.toLowerCase()}`:o=`b${n}`),this.squares[s*8+r]=o}}}getFen(){let e=new Array(8).fill("");for(let t=0;t<8;t++){let s=0;for(let i=0;i<8;i++){const r=this.squares[t*8+i];if(!r)s++;else{s>0&&(e[7-t]+=s,s=0);const n=r.substring(0,1),o=r.substring(1,2);n==="w"?e[7-t]+=o.toUpperCase():e[7-t]+=o}}s>0&&(e[7-t]+=s,s=0)}return e.join("/")}getPieces(e=void 0,t=void 0,s=["k","q","r","b","n","p"]){const i=[],r=(n,o)=>s.indexOf(n.name)-s.indexOf(o.name);for(let n=0;n<64;n++){const o=this.squares[n];if(o){const d=o.charAt(1),p=o.charAt(0),g=x.indexToSquare(n);if(t&&t!==d||e&&e!==p)continue;i.push({name:d,type:d,color:p,position:g,square:g})}}return s&&i.sort(r),i}movePiece(e,t){if(!this.squares[x.squareToIndex(e)]){console.warn("no piece on",e);return}this.squares[x.squareToIndex(t)]=this.squares[x.squareToIndex(e)],this.squares[x.squareToIndex(e)]=null}setPiece(e,t){this.squares[x.squareToIndex(e)]=t}getPiece(e){return this.squares[x.squareToIndex(e)]}static squareToIndex(e){const t=x.squareToCoordinates(e);return t[0]+t[1]*8}static indexToSquare(e){return this.coordinatesToSquare([Math.floor(e%8),e/8])}static squareToCoordinates(e){const t=e.charCodeAt(0)-97,s=e.charCodeAt(1)-49;return[t,s]}static coordinatesToSquare(e){const t=String.fromCharCode(e[0]+97),s=String.fromCharCode(e[1]+49);return t+s}toString(){return this.getFen()}clone(){const e=new x;return e.squares=this.squares.slice(0),e}}class Ys{constructor(){this.position=new x,this.orientation=void 0,this.inputWhiteEnabled=!1,this.inputBlackEnabled=!1,this.squareSelectEnabled=!1,this.moveInputCallback=null,this.extensionPoints={},this.moveInputProcess=Promise.resolve()}inputEnabled(){return this.inputWhiteEnabled||this.inputBlackEnabled}invokeExtensionPoints(e,t={}){const s=this.extensionPoints[e],i=Object.assign({},t);i.extensionPoint=e;let r=!0;if(s)for(const n of s)n(i)===!1&&(r=!1);return r}}const yt="http://www.w3.org/2000/svg";class P{static createSvg(e=void 0){let t=document.createElementNS(yt,"svg");return e&&(t.setAttribute("width","100%"),t.setAttribute("height","100%"),e.appendChild(t)),t}static addElement(e,t,s={}){let i=document.createElementNS(yt,t);t==="use"&&(s["xlink:href"]=s.href);for(let r in s)if(s.hasOwnProperty(r))if(r.indexOf(":")!==-1){const n=r.split(":");i.setAttributeNS("http://www.w3.org/1999/"+n[0],n[1],s[r])}else i.setAttribute(r,s[r]);return e.appendChild(i),i}static removeElement(e){if(!e){console.warn("removeElement, element is",e);return}e.parentNode?e.parentNode.removeChild(e):console.warn(e,"without parentNode")}}const T={positionChanged:"positionChanged",boardChanged:"boardChanged",moveInputToggled:"moveInputToggled",moveInput:"moveInput",beforeRedrawBoard:"beforeRedrawBoard",afterRedrawBoard:"afterRedrawBoard",redrawBoard:"redrawBoard",animation:"animation",destroy:"destroy"};class Re{constructor(e){this.chessboard=e}registerExtensionPoint(e,t){e===T.redrawBoard&&(console.warn("EXTENSION_POINT.redrawBoard is deprecated, use EXTENSION_POINT.afterRedrawBoard"),e=T.afterRedrawBoard),this.chessboard.state.extensionPoints[e]||(this.chessboard.state.extensionPoints[e]=[]),this.chessboard.state.extensionPoints[e].push(t)}registerMethod(e,t){console.warn("registerMethod is deprecated, just add methods directly to the chessboard instance"),this.chessboard[e]?log.error("method",e,"already exists"):this.chessboard[e]=(...s)=>t.apply(this,s)}}class X{static delegate(e,t,s,i){const r=function(n){let o=n.target;for(;o&&o!==this;)o.matches(s)&&i.call(o,n),o=o.parentNode};return e.addEventListener(t,r),{remove:function(){e.removeEventListener(t,r)}}}static mergeObjects(e,t){const s=i=>i&&typeof i=="object";if(!s(e)||!s(t))return t;for(const i of Object.keys(t))t[i]instanceof Object&&Object.assign(t[i],X.mergeObjects(e[i],t[i]));return Object.assign(e||{},t),e}static createDomElement(e){const t=document.createElement("template");return t.innerHTML=e.trim(),t.content.firstChild}static createTask(){let e,t;const s=new Promise(function(i,r){e=i,t=r});return s.resolve=e,s.reject=t,s}static isAbsoluteUrl(e){return e.indexOf("://")!==-1||e.startsWith("/")}}const De={start:"start",frame:"frame",end:"end"};class Qs{constructor(){this.queue=[],this.workingOnPromise=!1,this.stop=!1}async enqueue(e){return new Promise((t,s)=>{this.queue.push({promise:e,resolve:t,reject:s}),this.dequeue()})}dequeue(){if(this.workingOnPromise)return;if(this.stop){this.queue=[],this.stop=!1;return}const e=this.queue.shift();if(e){try{this.workingOnPromise=!0,e.promise().then(t=>{this.workingOnPromise=!1,e.resolve(t),this.dequeue()}).catch(t=>{this.workingOnPromise=!1,e.reject(t),this.dequeue()})}catch(t){this.workingOnPromise=!1,e.reject(t),this.dequeue()}return!0}}destroy(){this.stop=!0}}const H={move:0,appear:1,disappear:2};class ie{constructor(e,t,s,i,r){this.view=e,t&&s?(this.animatedElements=this.createAnimation(t.squares,s.squares),this.duration=i,this.callback=r,this.frameHandle=requestAnimationFrame(this.animationStep.bind(this))):console.error("fromPosition",t,"toPosition",s),this.view.positionsAnimationTask=X.createTask(),this.view.chessboard.state.invokeExtensionPoints(T.animation,{type:De.start})}static seekChanges(e,t){const s=[],i=[],r=[];for(let n=0;n<64;n++){const o=e[n],d=t[n];d!==o&&(d&&s.push({piece:d,index:n}),o&&i.push({piece:o,index:n}))}return s.forEach(n=>{let o=8,d=null;i.forEach(p=>{if(n.piece===p.piece){const g=ie.squareDistance(n.index,p.index);g<o&&(d=p,o=g)}}),d?(i.splice(i.indexOf(d),1),r.push({type:H.move,piece:n.piece,atIndex:d.index,toIndex:n.index})):r.push({type:H.appear,piece:n.piece,atIndex:n.index})}),i.forEach(n=>{r.push({type:H.disappear,piece:n.piece,atIndex:n.index})}),r}createAnimation(e,t){const s=ie.seekChanges(e,t),i=[];return s.forEach(r=>{const n={type:r.type};switch(r.type){case H.move:n.element=this.view.getPieceElement(x.indexToSquare(r.atIndex)),n.element.parentNode.appendChild(n.element),n.atPoint=this.view.indexToPoint(r.atIndex),n.toPoint=this.view.indexToPoint(r.toIndex);break;case H.appear:n.element=this.view.drawPieceOnSquare(x.indexToSquare(r.atIndex),r.piece),n.element.style.opacity=0;break;case H.disappear:n.element=this.view.getPieceElement(x.indexToSquare(r.atIndex));break}i.push(n)}),i}animationStep(e){if(!this.view||!this.view.chessboard.state)return;this.startTime||(this.startTime=e);const t=e-this.startTime;if(t<=this.duration)this.frameHandle=requestAnimationFrame(this.animationStep.bind(this));else{cancelAnimationFrame(this.frameHandle),this.animatedElements.forEach(r=>{r.type===H.disappear&&P.removeElement(r.element)}),this.view.positionsAnimationTask.resolve(),this.view.chessboard.state.invokeExtensionPoints(T.animation,{type:De.end}),this.callback();return}const s=Math.min(1,t/this.duration);let i=s<.5?2*s*s:-1+(4-2*s)*s;(isNaN(i)||i>.99)&&(i=1),this.animatedElements.forEach(r=>{if(r.element)switch(r.type){case H.move:r.element.transform.baseVal.removeItem(0);const n=this.view.svg.createSVGTransform();n.setTranslate(r.atPoint.x+(r.toPoint.x-r.atPoint.x)*i,r.atPoint.y+(r.toPoint.y-r.atPoint.y)*i),r.element.transform.baseVal.appendItem(n);break;case H.appear:r.element.style.opacity=Math.round(i*100)/100;break;case H.disappear:r.element.style.opacity=Math.round((1-i)*100)/100;break}else console.warn("animatedItem has no element",r)}),this.view.chessboard.state.invokeExtensionPoints(T.animation,{type:De.frame,progress:i})}static squareDistance(e,t){const s=e%8,i=Math.floor(e/8),r=t%8,n=Math.floor(t/8);return Math.max(Math.abs(n-i),Math.abs(r-s))}}class Xs extends Qs{constructor(e){super(),this.chessboard=e}async enqueuePositionChange(e,t,s){return e.getFen()===t.getFen()?Promise.resolve():super.enqueue(()=>new Promise(i=>{let r=s?this.chessboard.props.style.animationDuration:0;this.queue.length>0&&(r=r/(1+Math.pow(this.queue.length/5,2))),new ie(this.chessboard.view,e,t,s?r:0,()=>{this.chessboard.view&&this.chessboard.view.redrawPieces(t.squares),i()})}))}async enqueueTurnBoard(e,t,s){return super.enqueue(()=>new Promise(i=>{const r=new x(we.empty);let n=s?this.chessboard.props.style.animationDuration:0;this.queue.length>0&&(n=n/(1+Math.pow(this.queue.length/5,2))),new ie(this.chessboard.view,e,r,s?n:0,()=>{this.chessboard.state.orientation=t,this.chessboard.view.redrawBoard(),this.chessboard.view.redrawPieces(r.squares),new ie(this.chessboard.view,r,e,s?n:0,()=>{this.chessboard.view.redrawPieces(e.squares),i()})})}))}}const m={waitForInputStart:"waitForInputStart",pieceClickedThreshold:"pieceClickedThreshold",clickTo:"clickTo",secondClickThreshold:"secondClickThreshold",dragTo:"dragTo",clickDragTo:"clickDragTo",moveDone:"moveDone",reset:"reset"},ae={secondClick:"secondClick",secondaryClick:"secondaryClick",movedOutOfBoard:"movedOutOfBoard",draggedBack:"draggedBack",clickedAnotherPiece:"clickedAnotherPiece"},wt=4;class Zs{constructor(e){this.view=e,this.chessboard=e.chessboard,this.moveInputState=null,this.fromSquare=null,this.toSquare=null,this.setMoveInputState(m.waitForInputStart)}moveInputStartedCallback(e){const t=this.view.moveInputStartedCallback(e);return t&&(this.chessboard.state.moveInputProcess=X.createTask(),this.chessboard.state.moveInputProcess.then(s=>{(this.moveInputState===m.waitForInputStart||this.moveInputState===m.moveDone)&&this.view.moveInputFinishedCallback(this.fromSquare,this.toSquare,s)})),t}movingOverSquareCallback(e,t){this.view.movingOverSquareCallback(e,t)}validateMoveInputCallback(e,t){const s=this.view.validateMoveInputCallback(e,t);return this.chessboard.state.moveInputProcess.resolve(s),s}moveInputCanceledCallback(e,t,s){this.view.moveInputCanceledCallback(e,t,s),this.chessboard.state.moveInputProcess.resolve()}setMoveInputState(e,t=void 0){const s=this.moveInputState;switch(this.moveInputState=e,e){case m.waitForInputStart:break;case m.pieceClickedThreshold:if(m.waitForInputStart!==s&&m.clickTo!==s)throw new Error("moveInputState");if(this.pointerMoveListener&&(removeEventListener(this.pointerMoveListener.type,this.pointerMoveListener),this.pointerMoveListener=null),this.pointerUpListener&&(removeEventListener(this.pointerUpListener.type,this.pointerUpListener),this.pointerUpListener=null),this.fromSquare=t.square,this.toSquare=null,this.movedPiece=t.piece,this.startPoint=t.point,!this.pointerMoveListener&&!this.pointerUpListener){if(t.type==="mousedown")this.pointerMoveListener=this.onPointerMove.bind(this),this.pointerMoveListener.type="mousemove",addEventListener("mousemove",this.pointerMoveListener),this.pointerUpListener=this.onPointerUp.bind(this),this.pointerUpListener.type="mouseup",addEventListener("mouseup",this.pointerUpListener);else if(t.type==="touchstart")this.pointerMoveListener=this.onPointerMove.bind(this),this.pointerMoveListener.type="touchmove",addEventListener("touchmove",this.pointerMoveListener),this.pointerUpListener=this.onPointerUp.bind(this),this.pointerUpListener.type="touchend",addEventListener("touchend",this.pointerUpListener);else throw Error("4b74af");this.contextMenuListener||(this.contextMenuListener=this.onContextMenu.bind(this),this.chessboard.view.svg.addEventListener("contextmenu",this.contextMenuListener))}else throw Error("94ad0c");break;case m.clickTo:this.draggablePiece&&(P.removeElement(this.draggablePiece),this.draggablePiece=null),s===m.dragTo&&this.view.setPieceVisibility(t.square,!0);break;case m.secondClickThreshold:if(m.clickTo!==s)throw new Error("moveInputState");this.startPoint=t.point;break;case m.dragTo:if(m.pieceClickedThreshold!==s)throw new Error("moveInputState");this.view.chessboard.state.inputEnabled()&&(this.view.setPieceVisibility(t.square,!1),this.createDraggablePiece(t.piece));break;case m.clickDragTo:if(m.secondClickThreshold!==s)throw new Error("moveInputState");this.view.chessboard.state.inputEnabled()&&(this.view.setPieceVisibility(t.square,!1),this.createDraggablePiece(t.piece));break;case m.moveDone:if([m.dragTo,m.clickTo,m.clickDragTo].indexOf(s)===-1)throw new Error("moveInputState");this.toSquare=t.square,this.toSquare&&this.validateMoveInputCallback(this.fromSquare,this.toSquare)?this.chessboard.movePiece(this.fromSquare,this.toSquare,s===m.clickTo).then(()=>{s===m.clickTo&&this.view.setPieceVisibility(this.toSquare,!0),this.setMoveInputState(m.reset)}):(this.view.setPieceVisibility(this.fromSquare,!0),this.setMoveInputState(m.reset));break;case m.reset:this.fromSquare&&!this.toSquare&&this.movedPiece&&this.chessboard.state.position.setPiece(this.fromSquare,this.movedPiece),this.fromSquare=null,this.toSquare=null,this.movedPiece=null,this.draggablePiece&&(P.removeElement(this.draggablePiece),this.draggablePiece=null),this.pointerMoveListener&&(removeEventListener(this.pointerMoveListener.type,this.pointerMoveListener),this.pointerMoveListener=null),this.pointerUpListener&&(removeEventListener(this.pointerUpListener.type,this.pointerUpListener),this.pointerUpListener=null),this.contextMenuListener&&(removeEventListener("contextmenu",this.contextMenuListener),this.contextMenuListener=null),this.setMoveInputState(m.waitForInputStart);const i=this.view.piecesGroup.querySelectorAll("[visibility=hidden]");for(let r=0;r<i.length;r++)i[r].removeAttribute("visibility");break;default:throw Error(`260b09: moveInputState ${e}`)}}createDraggablePiece(e){if(this.draggablePiece)throw Error("draggablePiece already exists");this.draggablePiece=P.createSvg(document.body),this.draggablePiece.classList.add("cm-chessboard-draggable-piece"),this.draggablePiece.setAttribute("width",this.view.squareWidth),this.draggablePiece.setAttribute("height",this.view.squareHeight),this.draggablePiece.setAttribute("style","pointer-events: none"),this.draggablePiece.name=e;const t=this.chessboard.props.assetsCache?"":this.view.getSpriteUrl(),s=P.addElement(this.draggablePiece,"use",{href:`${t}#${e}`}),i=this.view.squareHeight/this.chessboard.props.style.pieces.tileSize,r=this.draggablePiece.createSVGTransform();r.setScale(i,i),s.transform.baseVal.appendItem(r)}moveDraggablePiece(e,t){this.draggablePiece.setAttribute("style",`pointer-events: none; position: absolute; left: ${e-this.view.squareHeight/2}px; top: ${t-this.view.squareHeight/2}px`)}onPointerDown(e){if(!(e.type==="mousedown"&&e.button===0||e.type==="touchstart"))return;const t=e.target.getAttribute("data-square");if(!t)return;const s=this.chessboard.getPiece(t);let i;if(s&&(i=s?s.substring(0,1):null,(i==="w"&&this.chessboard.state.inputWhiteEnabled||i==="b"&&this.chessboard.state.inputBlackEnabled)&&e.preventDefault()),this.moveInputState!==m.waitForInputStart||this.chessboard.state.inputWhiteEnabled&&i==="w"||this.chessboard.state.inputBlackEnabled&&i==="b"){let r;if(e.type==="mousedown"?r={x:e.clientX,y:e.clientY}:e.type==="touchstart"&&(r={x:e.touches[0].clientX,y:e.touches[0].clientY}),this.moveInputState===m.waitForInputStart&&s&&this.moveInputStartedCallback(t))this.setMoveInputState(m.pieceClickedThreshold,{square:t,piece:s,point:r,type:e.type});else if(this.moveInputState===m.clickTo)if(t===this.fromSquare)this.setMoveInputState(m.secondClickThreshold,{square:t,piece:s,point:r,type:e.type});else{const n=this.chessboard.getPiece(t),o=n?n.substring(0,1):null,d=this.chessboard.getPiece(this.fromSquare),p=d?d.substring(0,1):null;i&&p===o?(this.moveInputCanceledCallback(this.fromSquare,t,ae.clickedAnotherPiece),this.moveInputStartedCallback(t)?this.setMoveInputState(m.pieceClickedThreshold,{square:t,piece:n,point:r,type:e.type}):this.setMoveInputState(m.reset)):this.setMoveInputState(m.moveDone,{square:t})}}}onPointerMove(e){let t,s,i,r,n;if(e.type==="mousemove"?(i=e.clientX,r=e.clientY,t=e.pageX,s=e.pageY,n=e.target):e.type==="touchmove"&&(i=e.touches[0].clientX,r=e.touches[0].clientY,t=e.touches[0].pageX,s=e.touches[0].pageY,n=document.elementFromPoint(i,r)),this.moveInputState===m.pieceClickedThreshold||this.moveInputState===m.secondClickThreshold)(Math.abs(this.startPoint.x-i)>wt||Math.abs(this.startPoint.y-r)>wt)&&(this.moveInputState===m.secondClickThreshold?this.setMoveInputState(m.clickDragTo,{square:this.fromSquare,piece:this.movedPiece}):this.setMoveInputState(m.dragTo,{square:this.fromSquare,piece:this.movedPiece}),this.view.chessboard.state.inputEnabled()&&this.moveDraggablePiece(t,s));else if(this.moveInputState===m.dragTo||this.moveInputState===m.clickDragTo||this.moveInputState===m.clickTo){if(n&&n.getAttribute&&n.parentElement===this.view.boardGroup){const o=n.getAttribute("data-square");o!==this.fromSquare&&o!==this.toSquare?(this.toSquare=o,this.movingOverSquareCallback(this.fromSquare,this.toSquare)):o===this.fromSquare&&this.toSquare!==null&&(this.toSquare=null,this.movingOverSquareCallback(this.fromSquare,null))}else this.toSquare!==null&&(this.toSquare=null,this.movingOverSquareCallback(this.fromSquare,null));this.view.chessboard.state.inputEnabled()&&(this.moveInputState===m.dragTo||this.moveInputState===m.clickDragTo)&&this.moveDraggablePiece(t,s)}}onPointerUp(e){let t;if(e.type==="mouseup"?t=e.target:e.type==="touchend"&&(t=document.elementFromPoint(e.changedTouches[0].clientX,e.changedTouches[0].clientY)),t&&t.getAttribute){const s=t.getAttribute("data-square");if(s)this.moveInputState===m.dragTo||this.moveInputState===m.clickDragTo?this.fromSquare===s?this.moveInputState===m.clickDragTo?(this.chessboard.state.position.setPiece(this.fromSquare,this.movedPiece),this.view.setPieceVisibility(this.fromSquare),this.moveInputCanceledCallback(s,null,ae.draggedBack),this.setMoveInputState(m.reset)):this.setMoveInputState(m.clickTo,{square:s}):this.setMoveInputState(m.moveDone,{square:s}):this.moveInputState===m.pieceClickedThreshold?this.setMoveInputState(m.clickTo,{square:s}):this.moveInputState===m.secondClickThreshold&&(this.setMoveInputState(m.reset),this.moveInputCanceledCallback(s,null,ae.secondClick));else{this.view.redrawPieces();const i=this.fromSquare;this.setMoveInputState(m.reset),this.moveInputCanceledCallback(i,null,ae.movedOutOfBoard)}}else this.view.redrawPieces(),this.setMoveInputState(m.reset)}onContextMenu(e){e.preventDefault(),this.view.redrawPieces(),this.setMoveInputState(m.reset),this.moveInputCanceledCallback(this.fromSquare,null,ae.secondaryClick)}isDragging(){return this.moveInputState===m.dragTo||this.moveInputState===m.clickDragTo}destroy(){this.setMoveInputState(m.reset)}}const R={white:"w",black:"b"},F={moveInputStarted:"moveInputStarted",movingOverSquare:"movingOverSquare",validateMoveInput:"validateMoveInput",moveInputCanceled:"moveInputCanceled",moveInputFinished:"moveInputFinished"},Js={pointerdown:"pointerdown"},se={none:"none",thin:"thin",frame:"frame"};class ei{constructor(e){this.chessboard=e,this.visualMoveInput=new Zs(this),e.props.assetsCache&&this.cacheSpriteToDiv("cm-chessboard-sprite",this.getSpriteUrl()),this.container=document.createElement("div"),this.chessboard.context.appendChild(this.container),e.props.responsive&&(typeof ResizeObserver<"u"?(this.resizeObserver=new ResizeObserver(()=>{setTimeout(()=>{this.handleResize()})}),this.resizeObserver.observe(this.chessboard.context)):(this.resizeListener=this.handleResize.bind(this),window.addEventListener("resize",this.resizeListener))),this.positionsAnimationTask=Promise.resolve(),this.pointerDownListener=this.pointerDownHandler.bind(this),this.container.addEventListener("mousedown",this.pointerDownListener),this.container.addEventListener("touchstart",this.pointerDownListener,{passive:!1}),this.createSvgAndGroups(),this.handleResize()}pointerDownHandler(e){this.visualMoveInput.onPointerDown(e)}destroy(){this.visualMoveInput.destroy(),this.resizeObserver&&this.resizeObserver.unobserve(this.chessboard.context),this.resizeListener&&window.removeEventListener("resize",this.resizeListener),this.chessboard.context.removeEventListener("mousedown",this.pointerDownListener),this.chessboard.context.removeEventListener("touchstart",this.pointerDownListener),P.removeElement(this.svg),this.container.remove()}cacheSpriteToDiv(e,t){if(!document.getElementById(e)){const s=document.createElement("div");s.style.transform="scale(0)",s.style.position="absolute",s.setAttribute("aria-hidden","true"),s.id=e,document.body.appendChild(s);const i=new XMLHttpRequest;i.open("GET",t,!0),i.onload=function(){s.insertAdjacentHTML("afterbegin",i.response)},i.send()}}createSvgAndGroups(){this.svg=P.createSvg(this.container);let e=this.chessboard.props.style.cssClass?this.chessboard.props.style.cssClass:"default";this.svg.setAttribute("class","cm-chessboard border-type-"+this.chessboard.props.style.borderType+" "+e),this.svg.setAttribute("role","img"),this.updateMetrics(),this.boardGroup=P.addElement(this.svg,"g",{class:"board"}),this.coordinatesGroup=P.addElement(this.svg,"g",{class:"coordinates","aria-hidden":"true"}),this.markersLayer=P.addElement(this.svg,"g",{class:"markers-layer"}),this.piecesLayer=P.addElement(this.svg,"g",{class:"pieces-layer"}),this.piecesGroup=P.addElement(this.piecesLayer,"g",{class:"pieces"}),this.markersTopLayer=P.addElement(this.svg,"g",{class:"markers-top-layer"}),this.interactiveTopLayer=P.addElement(this.svg,"g",{class:"interactive-top-layer"})}updateMetrics(){const e=this.chessboard.props.style.pieces.tileSize;this.width=this.container.clientWidth,this.height=this.container.clientWidth*(this.chessboard.props.style.aspectRatio||1),this.chessboard.props.style.borderType===se.frame?this.borderSize=this.width/25:this.chessboard.props.style.borderType===se.thin?this.borderSize=this.width/320:this.borderSize=0,this.innerWidth=this.width-2*this.borderSize,this.innerHeight=this.height-2*this.borderSize,this.squareWidth=this.innerWidth/8,this.squareHeight=this.innerHeight/8,this.scalingX=this.squareWidth/e,this.scalingY=this.squareHeight/e,this.pieceXTranslate=this.squareWidth/2-e*this.scalingY/2}handleResize(){this.container.style.width=this.chessboard.context.clientWidth+"px",this.container.style.height=this.chessboard.context.clientWidth*this.chessboard.props.style.aspectRatio+"px",(this.container.clientWidth!==this.width||this.container.clientHeight!==this.height)&&(this.updateMetrics(),this.redrawBoard(),this.redrawPieces()),this.svg.setAttribute("width","100%"),this.svg.setAttribute("height","100%")}redrawBoard(){this.chessboard.state.invokeExtensionPoints(T.beforeRedrawBoard),this.redrawSquares(),this.drawCoordinates(),this.chessboard.state.invokeExtensionPoints(T.afterRedrawBoard),this.visualizeInputState()}redrawSquares(){for(;this.boardGroup.firstChild;)this.boardGroup.removeChild(this.boardGroup.lastChild);if(P.addElement(this.boardGroup,"rect",{width:this.width,height:this.height}).setAttribute("class","border"),this.chessboard.props.style.borderType===se.frame){const t=this.borderSize;P.addElement(this.boardGroup,"rect",{x:t,y:t,width:this.width-t*2,height:this.height-t*2}).setAttribute("class","border-inner")}for(let t=0;t<64;t++){const s=this.chessboard.state.orientation===R.white?t:63-t,r=`square ${(9*s&8)===0?"black":"white"}`,n=this.squareToPoint(x.indexToSquare(s)),o=P.addElement(this.boardGroup,"rect",{x:n.x,y:n.y,width:this.squareWidth,height:this.squareHeight});o.setAttribute("class",r),o.setAttribute("data-square",x.indexToSquare(s))}}drawCoordinates(){if(!this.chessboard.props.style.showCoordinates)return;for(;this.coordinatesGroup.firstChild;)this.coordinatesGroup.removeChild(this.coordinatesGroup.lastChild);const e=this.chessboard.props.style.borderType!==se.frame;for(let t=0;t<8;t++){let s=this.borderSize+(17+this.chessboard.props.style.pieces.tileSize*t)*this.scalingX,i=this.height-this.scalingY*3.5,r="coordinate file";e&&(s=s+this.scalingX*15.5,r+=t%2?" white":" black");const n=P.addElement(this.coordinatesGroup,"text",{class:r,x:s,y:i,style:`font-size: ${this.scalingY*10}px`});this.chessboard.state.orientation===R.white?n.textContent=String.fromCharCode(97+t):n.textContent=String.fromCharCode(104-t)}for(let t=0;t<8;t++){let s=this.borderSize/3.7,i=this.borderSize+25*this.scalingY+t*this.squareHeight,r="coordinate rank";e&&(r+=t%2?" black":" white",this.chessboard.props.style.borderType===se.frame?(s=s+this.scalingX*10,i=i-this.scalingY*15):(s=s+this.scalingX*2,i=i-this.scalingY*15));const n=P.addElement(this.coordinatesGroup,"text",{class:r,x:s,y:i,style:`font-size: ${this.scalingY*10}px`});this.chessboard.state.orientation===R.white?n.textContent=""+(8-t):n.textContent=""+(1+t)}}redrawPieces(e=this.chessboard.state.position.squares){const t=Array.from(this.piecesGroup.childNodes),s=this.visualMoveInput.isDragging();for(let i=0;i<64;i++){const r=e[i];if(r){const n=x.indexToSquare(i);this.drawPieceOnSquare(n,r,s&&n===this.visualMoveInput.fromSquare)}}for(const i of t)this.piecesGroup.removeChild(i)}drawPiece(e,t,s){const i=P.addElement(e,"g",{});i.setAttribute("data-piece",t);const r=this.svg.createSVGTransform();r.setTranslate(s.x,s.y),i.transform.baseVal.appendItem(r);const n=this.chessboard.props.assetsCache?"":this.getSpriteUrl(),o=P.addElement(i,"use",{href:`${n}#${t}`,class:"piece"}),d=this.svg.createSVGTransform();return d.setScale(this.scalingY,this.scalingY),o.transform.baseVal.appendItem(d),i}drawPieceOnSquare(e,t,s=!1){const i=P.addElement(this.piecesGroup,"g",{});i.setAttribute("data-piece",t),i.setAttribute("data-square",e),s&&i.setAttribute("visibility","hidden");const r=this.squareToPoint(e),n=this.svg.createSVGTransform();n.setTranslate(r.x,r.y),i.transform.baseVal.appendItem(n);const o=this.chessboard.props.assetsCache?"":this.getSpriteUrl(),d=P.addElement(i,"use",{href:`${o}#${t}`,class:"piece"}),p=this.svg.createSVGTransform();p.setTranslate(this.pieceXTranslate,0),d.transform.baseVal.appendItem(p);const g=this.svg.createSVGTransform();return g.setScale(this.scalingY,this.scalingY),d.transform.baseVal.appendItem(g),i}setPieceVisibility(e,t=!0){const s=this.getPieceElement(e);s?t?s.setAttribute("visibility","visible"):s.setAttribute("visibility","hidden"):console.warn("no piece on",e)}getPieceElement(e){if(!e||e.length<2)return console.warn("invalid square",e),null;const t=this.piecesGroup.querySelector(`g[data-square='${e}']`);return t||(console.warn("no piece on",e),null)}enableMoveInput(e,t=null){if(this.chessboard.state.moveInputCallback)throw Error("moveInput already enabled");t===R.white?this.chessboard.state.inputWhiteEnabled=!0:t===R.black?this.chessboard.state.inputBlackEnabled=!0:(this.chessboard.state.inputWhiteEnabled=!0,this.chessboard.state.inputBlackEnabled=!0),this.chessboard.state.moveInputCallback=e,this.chessboard.state.invokeExtensionPoints(T.moveInputToggled,{enabled:!0,color:t}),this.visualizeInputState()}disableMoveInput(){this.chessboard.state.inputWhiteEnabled=!1,this.chessboard.state.inputBlackEnabled=!1,this.chessboard.state.moveInputCallback=null,this.chessboard.state.invokeExtensionPoints(T.moveInputToggled,{enabled:!1}),this.visualizeInputState()}moveInputStartedCallback(e){const t={chessboard:this.chessboard,type:F.moveInputStarted,square:e,squareFrom:e,piece:this.chessboard.getPiece(e)};return this.chessboard.state.moveInputCallback&&(t.moveInputCallbackResult=this.chessboard.state.moveInputCallback(t)),this.chessboard.state.invokeExtensionPoints(T.moveInput,t),t.moveInputCallbackResult}movingOverSquareCallback(e,t){const s={chessboard:this.chessboard,type:F.movingOverSquare,squareFrom:e,squareTo:t,piece:this.chessboard.getPiece(e)};this.chessboard.state.moveInputCallback&&(s.moveInputCallbackResult=this.chessboard.state.moveInputCallback(s)),this.chessboard.state.invokeExtensionPoints(T.moveInput,s)}validateMoveInputCallback(e,t){const s={chessboard:this.chessboard,type:F.validateMoveInput,squareFrom:e,squareTo:t,piece:this.chessboard.getPiece(e)};return this.chessboard.state.moveInputCallback&&(s.moveInputCallbackResult=this.chessboard.state.moveInputCallback(s)),this.chessboard.state.invokeExtensionPoints(T.moveInput,s),s.moveInputCallbackResult}moveInputCanceledCallback(e,t,s){const i={chessboard:this.chessboard,type:F.moveInputCanceled,reason:s,squareFrom:e,squareTo:t};this.chessboard.state.moveInputCallback&&this.chessboard.state.moveInputCallback(i),this.chessboard.state.invokeExtensionPoints(T.moveInput,i)}moveInputFinishedCallback(e,t,s){const i={chessboard:this.chessboard,type:F.moveInputFinished,squareFrom:e,squareTo:t,legalMove:s};this.chessboard.state.moveInputCallback&&this.chessboard.state.moveInputCallback(i),this.chessboard.state.invokeExtensionPoints(T.moveInput,i)}visualizeInputState(){this.chessboard.state&&(this.chessboard.state.inputWhiteEnabled||this.chessboard.state.inputBlackEnabled?this.boardGroup.setAttribute("class","board input-enabled"):this.boardGroup.setAttribute("class","board"))}indexToPoint(e){let t,s;return this.chessboard.state.orientation===R.white?(t=this.borderSize+e%8*this.squareWidth,s=this.borderSize+(7-Math.floor(e/8))*this.squareHeight):(t=this.borderSize+(7-e%8)*this.squareWidth,s=this.borderSize+Math.floor(e/8)*this.squareHeight),{x:t,y:s}}squareToPoint(e){const t=x.squareToIndex(e);return this.indexToPoint(t)}getSpriteUrl(){return X.isAbsoluteUrl(this.chessboard.props.style.pieces.file)?this.chessboard.props.style.pieces.file:this.chessboard.props.assetsUrl+this.chessboard.props.style.pieces.file}}const Y={wp:"wp",wb:"wb",wn:"wn",wr:"wr",wq:"wq",wk:"wk",bp:"bp",bb:"bb",bn:"bn",br:"br",bq:"bq",bk:"bk"},ti={svgSprite:"svgSprite"};class si{constructor(e,t={}){if(!e)throw new Error("container element is "+e);this.context=e,this.id=(Math.random()+1).toString(36).substring(2,8),this.extensions=[],this.props={position:we.empty,orientation:R.white,responsive:!0,assetsUrl:"./assets/",assetsCache:!0,style:{cssClass:"default",showCoordinates:!0,borderType:se.none,aspectRatio:1,pieces:{type:ti.svgSprite,file:"pieces/standard.svg",tileSize:40},animationDuration:300},extensions:[]},X.mergeObjects(this.props,t),this.state=new Ys,this.view=new ei(this),this.positionAnimationsQueue=new Xs(this),this.state.orientation=this.props.orientation;for(const s of this.props.extensions)this.addExtension(s.class,s.props);this.view.redrawBoard(),this.state.position=new x(this.props.position),this.view.redrawPieces(),this.state.invokeExtensionPoints(T.positionChanged),this.initialized=Promise.resolve()}async setPiece(e,t,s=!1){const i=this.state.position.clone();return this.state.position.setPiece(e,t),this.state.invokeExtensionPoints(T.positionChanged),this.positionAnimationsQueue.enqueuePositionChange(i,this.state.position.clone(),s)}async movePiece(e,t,s=!1){const i=this.state.position.clone();return this.state.position.movePiece(e,t),this.state.invokeExtensionPoints(T.positionChanged),this.positionAnimationsQueue.enqueuePositionChange(i,this.state.position.clone(),s)}async setPosition(e,t=!1){const s=this.state.position.clone(),i=new x(e);return s.getFen()!==i.getFen()&&(this.state.position.setFen(e),this.state.invokeExtensionPoints(T.positionChanged)),this.positionAnimationsQueue.enqueuePositionChange(s,this.state.position.clone(),t)}async setOrientation(e,t=!1){const s=this.state.position.clone();if(this.boardTurning){console.warn("setOrientation is only once in queue allowed");return}return this.boardTurning=!0,this.positionAnimationsQueue.enqueueTurnBoard(s,e,t).then(()=>{this.boardTurning=!1,this.state.invokeExtensionPoints(T.boardChanged)})}getPiece(e){return this.state.position.getPiece(e)}getPosition(){return this.state.position.getFen()}getOrientation(){return this.state.orientation}enableMoveInput(e,t=void 0){this.view.enableMoveInput(e,t)}disableMoveInput(){this.view.disableMoveInput()}isMoveInputEnabled(){return this.state.inputWhiteEnabled||this.state.inputBlackEnabled}enableSquareSelect(e=Js.pointerdown,t){this.squareSelectListener||(this.squareSelectListener=function(s){const i=s.target.getAttribute("data-square");t({eventType:s.type,event:s,chessboard:this,square:i})}),this.context.addEventListener(e,this.squareSelectListener),this.state.squareSelectEnabled=!0,this.view.visualizeInputState()}disableSquareSelect(e){this.context.removeEventListener(e,this.squareSelectListener),this.squareSelectListener=void 0,this.state.squareSelectEnabled=!1,this.view.visualizeInputState()}isSquareSelectEnabled(){return this.state.squareSelectEnabled}addExtension(e,t){if(this.getExtension(e))throw Error('extension "'+e.name+'" already added');this.extensions.push(new e(this,t))}getExtension(e){for(const t of this.extensions)if(t instanceof e)return t;return null}destroy(){this.state.invokeExtensionPoints(T.destroy),this.positionAnimationsQueue.destroy(),this.view.destroy(),this.view=void 0,this.state=void 0}}const he={frame:{class:"marker-frame",slice:"markerFrame"},dot:{class:"marker-dot",slice:"markerDot",position:"above"},bevel:{class:"marker-bevel",slice:"markerBevel"}};class ii extends Re{constructor(e,t={}){super(e),this.registerExtensionPoint(T.afterRedrawBoard,()=>{this.onRedrawBoard()}),this.props={autoMarkers:he.frame,sprite:"extensions/markers/markers.svg"},Object.assign(this.props,t),e.props.assetsCache&&e.view.cacheSpriteToDiv("cm-chessboard-markers",this.getSpriteUrl()),e.addMarker=this.addMarker.bind(this),e.getMarkers=this.getMarkers.bind(this),e.removeMarkers=this.removeMarkers.bind(this),e.addLegalMovesMarkers=this.addLegalMovesMarkers.bind(this),e.removeLegalMovesMarkers=this.removeLegalMovesMarkers.bind(this),this.markerGroupDown=P.addElement(e.view.markersLayer,"g",{class:"markers"}),this.markerGroupUp=P.addElement(e.view.markersTopLayer,"g",{class:"markers"}),this.markers=[],this.props.autoMarkers&&(Object.assign(this.props.autoMarkers,this.props.autoMarkers),this.registerExtensionPoint(T.moveInput,s=>{this.drawAutoMarkers(s)}))}drawAutoMarkers(e){e.type!==F.moveInputFinished&&this.removeMarkers(this.props.autoMarkers),!(e.type===F.moveInputStarted&&!e.moveInputCallbackResult)&&(e.type===F.moveInputStarted||e.type===F.movingOverSquare)&&(e.squareFrom&&this.addMarker(this.props.autoMarkers,e.squareFrom),e.squareTo&&this.addMarker(this.props.autoMarkers,e.squareTo))}onRedrawBoard(){for(;this.markerGroupUp.firstChild;)this.markerGroupUp.removeChild(this.markerGroupUp.firstChild);for(;this.markerGroupDown.firstChild;)this.markerGroupDown.removeChild(this.markerGroupDown.firstChild);this.markers.forEach(e=>{this.drawMarker(e)})}addLegalMovesMarkers(e){for(const t of e)t.promotion&&t.promotion!=="q"||(this.chessboard.getPiece(t.to)?this.chessboard.addMarker(he.bevel,t.to):this.chessboard.addMarker(he.dot,t.to))}removeLegalMovesMarkers(){this.chessboard.removeMarkers(he.bevel),this.chessboard.removeMarkers(he.dot)}drawMarker(e){let t;e.type.position==="above"?t=P.addElement(this.markerGroupUp,"g"):t=P.addElement(this.markerGroupDown,"g"),t.setAttribute("data-square",e.square);const s=this.chessboard.view.squareToPoint(e.square),i=this.chessboard.view.svg.createSVGTransform();i.setTranslate(s.x,s.y),t.transform.baseVal.appendItem(i);const r=this.chessboard.props.assetsCache?"":this.getSpriteUrl(),n=P.addElement(t,"use",{href:`${r}#${e.type.slice}`,class:"marker "+e.type.class}),o=this.chessboard.view.svg.createSVGTransform();return o.setScale(this.chessboard.view.scalingX,this.chessboard.view.scalingY),n.transform.baseVal.appendItem(o),t}addMarker(e,t){if(typeof e=="string"||typeof t=="object"){console.error("changed the signature of `addMarker` to `(type, square)` with v5.1.x");return}this.markers.push(new ri(t,e)),this.onRedrawBoard()}getMarkers(e=void 0,t=void 0){if(typeof e=="string"||typeof t=="object"){console.error("changed the signature of `getMarkers` to `(type, square)` with v5.1.x");return}let s=[];return this.markers.forEach(i=>{i.matches(t,e)&&s.push(i)}),s}removeMarkers(e=void 0,t=void 0){if(typeof e=="string"||typeof t=="object"){console.error("changed the signature of `removeMarkers` to `(type, square)` with v5.1.x");return}this.markers=this.markers.filter(s=>!s.matches(t,e)),this.onRedrawBoard()}getSpriteUrl(){return X.isAbsoluteUrl(this.props.sprite)?this.props.sprite:this.chessboard.props.assetsUrl+this.props.sprite}}class ri{constructor(e,t){this.square=e,this.type=t}matches(e=void 0,t=void 0){if(!t&&!e)return!0;if(t){if(e){if(this.type===t&&e===this.square)return!0}else if(this.type===t)return!0}else if(e===this.square)return!0;return!1}}const U={hidden:"hidden",displayRequested:"displayRequested",shown:"shown"},Oe={pieceSelected:"pieceSelected",canceled:"canceled"};class ni extends Re{constructor(e){super(e),this.registerExtensionPoint(T.afterRedrawBoard,this.extensionPointRedrawBoard.bind(this)),e.showPromotionDialog=this.showPromotionDialog.bind(this),e.isPromotionDialogShown=this.isPromotionDialogShown.bind(this),this.promotionDialogGroup=P.addElement(e.view.interactiveTopLayer,"g",{class:"promotion-dialog-group"}),this.state={displayState:U.hidden,callback:null,dialogParams:{square:null,color:null}}}showPromotionDialog(e,t,s){this.state.dialogParams.square=e,this.state.dialogParams.color=t,this.state.callback=s,this.setDisplayState(U.displayRequested),setTimeout(()=>{this.chessboard.view.positionsAnimationTask.then(()=>{this.setDisplayState(U.shown)})})}isPromotionDialogShown(){return this.state.displayState===U.shown||this.state.displayState===U.displayRequested}extensionPointRedrawBoard(){this.redrawDialog()}drawPieceButton(e,t){const s=this.chessboard.view.squareWidth,i=this.chessboard.view.squareHeight;P.addElement(this.promotionDialogGroup,"rect",{x:t.x,y:t.y,width:s,height:i,class:"promotion-dialog-button","data-piece":e}),this.chessboard.view.drawPiece(this.promotionDialogGroup,e,t)}redrawDialog(){for(;this.promotionDialogGroup.firstChild;)this.promotionDialogGroup.removeChild(this.promotionDialogGroup.firstChild);if(this.state.displayState===U.shown){const e=this.chessboard.view.squareWidth,t=this.chessboard.view.squareHeight,s=this.chessboard.view.squareToPoint(this.state.dialogParams.square);s.x=s.x+e/2,s.y=s.y+t/2;let i=!1;const r=parseInt(this.state.dialogParams.square.charAt(1),10);(this.chessboard.getOrientation()===R.white&&r<5||this.chessboard.getOrientation()===R.black&&r>=5)&&(i=!0);const n=i?-4*t:0,o=s.x+e>this.chessboard.view.width?-e:0;P.addElement(this.promotionDialogGroup,"rect",{x:s.x+o,y:s.y+n,width:e,height:t*4,class:"promotion-dialog"});const d=this.state.dialogParams;i?(this.drawPieceButton(Y[d.color+"q"],{x:s.x+o,y:s.y-t}),this.drawPieceButton(Y[d.color+"r"],{x:s.x+o,y:s.y-t*2}),this.drawPieceButton(Y[d.color+"b"],{x:s.x+o,y:s.y-t*3}),this.drawPieceButton(Y[d.color+"n"],{x:s.x+o,y:s.y-t*4})):(this.drawPieceButton(Y[d.color+"q"],{x:s.x+o,y:s.y}),this.drawPieceButton(Y[d.color+"r"],{x:s.x+o,y:s.y+t}),this.drawPieceButton(Y[d.color+"b"],{x:s.x+o,y:s.y+t*2}),this.drawPieceButton(Y[d.color+"n"],{x:s.x+o,y:s.y+t*3}))}}promotionDialogOnClickPiece(e){e.button!==2&&(e.target.dataset.piece?(this.state.callback&&this.state.callback({type:Oe.pieceSelected,square:this.state.dialogParams.square,piece:e.target.dataset.piece}),this.setDisplayState(U.hidden)):this.promotionDialogOnCancel(e))}promotionDialogOnCancel(e){this.state.displayState===U.shown&&(e.preventDefault(),this.setDisplayState(U.hidden),this.state.callback&&this.state.callback({type:Oe.canceled}))}contextMenu(e){e.preventDefault(),this.setDisplayState(U.hidden),this.state.callback&&this.state.callback({type:Oe.canceled})}setDisplayState(e){this.state.displayState=e,e===U.shown?(this.clickDelegate=X.delegate(this.chessboard.view.svg,"pointerdown","*",this.promotionDialogOnClickPiece.bind(this)),this.contextMenuListener=this.contextMenu.bind(this),this.chessboard.view.svg.addEventListener("contextmenu",this.contextMenuListener)):e===U.hidden&&(this.clickDelegate.remove(),this.chessboard.view.svg.removeEventListener("contextmenu",this.contextMenuListener)),this.redrawDialog()}}class oi extends Re{constructor(e){super(e),e.addHtmlLayer=this.addHtmlLayer.bind(this),e.removeHtmlLayer=this.removeHtmlLayer.bind(this)}addHtmlLayer(e){const t=document.createElement("div");return this.chessboard.context.appendChild(t),this.chessboard.context.style.position="relative",t.classList.add("html-layer"),t.style.position="absolute",t.style.top="0",t.style.left="0",t.style.bottom="0",t.style.right="0",t.innerHTML=e,t}removeHtmlLayer(e){this.chessboard.context.removeChild(e)}}const me={white:{class:"customMarkerWhite",slice:"markerSquare"},black:{class:"customMarkerBlack",slice:"markerSquare"}},ai=`
<div class="overlay-content">
  <div id="gameOverText" class="overlay-text"></div>
  <div id="gameOverRestart" class="game-over-arrow" role="button" aria-label="Restart game" title="Restart game" tabindex="0">
    
  </div>
</div>
`,hi=`
<div class="overlay-content">
  <div class="loading-spinner"></div>
  <div class="overlay-text"></div>
</div>
`;class kt{layer;overlayText;constructor(e){this.layer=e,this.overlayText=this.layer.querySelector(".overlay-text"),this.hide()}show(e){e!==null&&(this.overlayText.textContent=e),this.layer.classList.add("visible"),this.layer.setAttribute("aria-hidden","false")}hide(){this.layer.classList.remove("visible"),this.layer.setAttribute("aria-hidden","true")}}class li{player=R.white;chessGame=new bt;cpBar=new dt("cpBar",$e.CP);wdlBar=new dt("wdlBar",$e.WDL);chessBoard=this.initChessBoard();engineWorker=null;workerState="uninitialized";workerPromise=null;selectedSquare=null;possibleTargets=null;gameOverOverlay;loadingOverlay;fenInput=document.querySelector("#fenInput");constructor(){const e=this.chessBoard.addHtmlLayer(ai),t=this.chessBoard.addHtmlLayer(hi);this.gameOverOverlay=new kt(e),this.loadingOverlay=new kt(t),document.getElementById("gameOverRestart").onclick=async()=>{this.initializeEngine(!0),await this.startGame()},this.fenInput.addEventListener("focus",()=>this.fenInput.select()),this.fenInput.addEventListener("keydown",async s=>{if(s.key!=="Enter")return;const i=this.fenInput.value.trim()??"";!i||!St(i).ok?this.fenInput.value=this.chessGame.fen():(this.initializeEngine(!0),await this.startGame(i))}),window.addEventListener("resize",()=>this.resize()),this.resize()}async initializeEngine(e=!1){if(this.workerState!=="uninitialized"&&!e)return this.workerPromise;this.workerState="initializing",this.loadingOverlay.show("Loading..."),this.engineWorker&&this.engineWorker.terminate();const t=new Worker(new URL("/assets/engineWorker-BqkjdvgA.js",import.meta.url),{type:"module"});this.engineWorker=t;const s=await Cs,i=r=>{const{type:n,data:o}=r.data??{};n==="searchResult"?this.updateSearchData?.(o):n==="perftResult"?this.updatePerftData?.(o):n==="enginePick"&&this.updateEnginePick?.(o)};return this.workerPromise=new Promise(r=>{const n=o=>{o.data?.type==="ready"&&(t.removeEventListener("message",n),t.addEventListener("message",i),this.workerState="initialized",this.loadingOverlay.hide(),r())};t.addEventListener("message",n)}),t.postMessage({type:"init",module:s}),this.workerPromise}addCustomMarker(e){function t(s){const i=s.charCodeAt(0)-97;return 8*(parseInt(s.charAt(1))-1)+i}t(e)%2===0?this.chessBoard.addMarker(me.black,e):this.chessBoard.addMarker(me.white,e)}removeSelectionMarkers(){this.selectedSquare!==null&&(this.chessBoard.removeLegalMovesMarkers(),this.chessBoard.removeMarkers(void 0,this.selectedSquare),this.possibleTargets=null,this.selectedSquare=null)}removeAllMarkers(){this.removeSelectionMarkers(),this.chessBoard.removeMarkers(me.black),this.chessBoard.removeMarkers(me.white)}addSelectionMarkers(e){const t=this.chessGame.moves({square:e,verbose:!0});this.possibleTargets=new Set,this.selectedSquare=e,this.addCustomMarker(e),this.chessBoard.addLegalMovesMarkers(t);for(let s=0;s<t.length;s++)this.possibleTargets.add(t[s].to)}addMoveMarkers(e,t){this.addCustomMarker(e),this.addCustomMarker(t)}makeEngineMove(){if(this.workerState!=="initialized")return;const e="fen "+this.chessGame.fen();this.engineWorker.postMessage({type:"search",data:{position:e,tc:"movetime 1000"}})}disableMoveInput(){this.chessBoard.disableMoveInput(),this.chessBoard.view?.visualMoveInput?.destroy?.()}setTurn(e){e===this.player?this.chessBoard.enableMoveInput(t=>this.moveEventHandler(t)):(this.disableMoveInput(),this.makeEngineMove())}gameOver(){let e,t,s;if(this.chessGame.isCheckmate()){const i=this.chessGame.turn(),r=i!==this.player,n=i==="b";e=n?"Mate":"Mated",t={val:1,w:n?1e3:0,d:0,l:n?0:1e3},s=r?"You win!":"You lose!"}else e="Cp",t={val:0,w:0,d:1e3,l:0},s="It's a draw!";this.cpBar.updateEvaluation(e,t),this.wdlBar.updateEvaluation(e,t),this.gameOverOverlay.show(s),this.disableMoveInput()}async applyMoveToGame(e){const t=this.chessGame.move(e);this.fenInput.value=this.chessGame.fen(),this.removeAllMarkers(),await this.chessBoard.setPosition(this.chessGame.fen(),!0),this.addMoveMarkers(t.from,t.to),this.chessGame.isGameOver()?this.gameOver():this.setTurn(this.chessGame.turn())}moveEventHandler(e){switch(e.type){case F.moveInputStarted:return console.log(e),this.addSelectionMarkers(e.square),!0;case F.validateMoveInput:console.log(e);const[t,s,i]=[e.squareFrom,e.squareTo,e.piece];if(i.charAt(0)!=this.player||!this.possibleTargets?.has(s))return!1;const o=i.charAt(1)==="p",d=s.charAt(1),p=d=="8"&&this.player===R.white||d=="1"&&this.player===R.black;return o&&p?(this.chessBoard.showPromotionDialog(s,this.player,g=>{g&&g.piece?this.applyMoveToGame({from:t,to:s,promotion:g.piece.charAt(1)}):this.chessBoard.movePiece(s,t,!1)}),!0):(this.applyMoveToGame({from:t,to:s}),!0);case F.moveInputFinished:case F.moveInputCanceled:return console.log(e),this.removeSelectionMarkers(),!0}}initChessBoard(){const e={position:this.chessGame.fen(),orientation:this.player,responsive:!0,animationDuration:200,assetsUrl:"/vendor/",assetsCache:!0,style:{cssClass:"green",showCoordinates:!1,borderType:"none",aspectRatio:1,pieces:{file:"staunty.svg",tileSize:40}},extensions:[{class:ni},{class:ii,props:{autoMarkers:null,sprite:"markers.svg"}},{class:oi}]},t=document.getElementById("board");return new si(t,e)}resize(){this.cpBar.setHeight("0px"),this.wdlBar.setHeight("0px"),this.chessBoard.view.handleResize();const t=document.getElementById("board").getBoundingClientRect().height+"px";this.cpBar.setHeight(t),this.wdlBar.setHeight(t)}async startGame(e){this.resize(),this.gameOverOverlay.hide(),this.removeAllMarkers(),this.cpBar.reset(),this.wdlBar.reset(),this.chessGame=new bt(e),this.player=this.chessGame.turn(),this.fenInput.value=this.chessGame.fen(),await this.chessBoard.setPosition(this.chessGame.fen(),!0),await this.chessBoard.setOrientation(this.player),await this.workerPromise,this.setTurn(this.chessGame.turn())}updatePerftData(e){console.log("Perft speed: ",e.nps)}updateSearchData(e){console.log("Search speed: ",e.nps);const t=e.score_type,s=e.score,i=this.player===R.white;this.cpBar.updateEvaluation(t,s,i),this.wdlBar.updateEvaluation(t,s,i)}updateEnginePick(e){console.log("Engine pick: ",e),this.applyMoveToGame(e)}}class ci{currentPage="";chessApp=new li;constructor(){this.setupNavigation(),this.loadPage(this.getInitialPage()),this.setupExternalLinks(),this.setupPopState(),this.chessApp.initializeEngine()}getInitialPage(){const e=window.location.hash.slice(1);return e&&["home","about","chess","github"].includes(e)?e:"home"}setupNavigation(){document.querySelectorAll(".nav-link").forEach(t=>{t.addEventListener("click",s=>{s.preventDefault();const i=t.getAttribute("data-page");i&&i!==this.currentPage&&this.loadPage(i)})}),document.addEventListener("keydown",t=>{switch(t.key){case"1":t.preventDefault(),this.loadPage("home");break;case"2":t.preventDefault(),this.loadPage("about");break;case"3":t.preventDefault(),this.loadPage("chess");break;case"4":t.preventDefault(),this.loadPage("github");break}})}async loadPage(e){if(this.currentPage===e)return;document.querySelectorAll(".page").forEach(i=>{i.id===`page-${e}`?i.classList.add("active"):i.classList.remove("active")}),this.currentPage=e,this.updateNavigation(e),window.scrollTo(0,0);const s=e==="home"?"/":`/#${e}`;history.pushState({page:e},"",s),document.title="asgobbi / "+e,e==="chess"?await this.chessApp.startGame():this.chessApp.initializeEngine(!0)}updateNavigation(e){document.querySelectorAll(".nav-link").forEach(t=>{t.getAttribute("data-page")===e?t.classList.add("active"):t.classList.remove("active")})}setupExternalLinks(){const e='a[href^="http"]:not([href*="'+window.location.host+'"]),a[target="_blank"]';document.querySelectorAll(e).forEach(s=>{s.setAttribute("target","_blank"),s.setAttribute("rel","noopener noreferrer")})}setupPopState(){window.addEventListener("popstate",e=>{e.state&&e.state.page?this.loadPage(e.state.page):this.loadPage("home")})}}window.terminalSite=new ci;document.addEventListener("keydown",h=>{if(h.key==="Tab"&&h.target===document.body){const e=document.querySelector(".nav-link");e&&(h.preventDefault(),e.focus())}});
